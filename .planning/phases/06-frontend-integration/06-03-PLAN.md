---
phase: 06-frontend-integration
plan: 03
type: execute
wave: 2
depends_on:
  - 06-01
files_modified:
  - frontend/src/components/pickers/ComponentPicker.tsx
  - frontend/src/components/forms/SimulationForm.tsx
autonomous: true
requirements:
  - SRC-04

must_haves:
  truths:
    - "Simulation form shows clickable card/chip for powder, bullet, and cartridge selection instead of flat Select dropdowns"
    - "Clicking a chip opens a modal overlay with debounced search input and result list"
    - "Typing in the modal search triggers a server-side API query (debounced 300ms, min 3 chars)"
    - "Single-click on a search result selects the item and closes the modal"
    - "Picker modal shows spinner while search results load"
    - "Picker modal shows 'Type to search...' placeholder when no query entered"
    - "Empty results show 'No results found' message with suggestion to adjust search"
    - "Rifle selection remains a flat Select dropdown (only 5 records, no change needed)"
  artifacts:
    - path: "frontend/src/components/pickers/ComponentPicker.tsx"
      provides: "Generic searchable modal picker for any component type"
      min_lines: 80
    - path: "frontend/src/components/forms/SimulationForm.tsx"
      provides: "Simulation form with ComponentPicker chips replacing Select dropdowns"
      contains: "ComponentPicker"
  key_links:
    - from: "frontend/src/components/forms/SimulationForm.tsx"
      to: "frontend/src/components/pickers/ComponentPicker.tsx"
      via: "import ComponentPicker for powder, bullet, cartridge selection"
      pattern: "import.*ComponentPicker"
    - from: "frontend/src/components/pickers/ComponentPicker.tsx"
      to: "frontend/src/lib/api.ts"
      via: "calls getPowders/getBullets/getCartridges with search params"
      pattern: "fetchFn.*page.*size.*q"
    - from: "frontend/src/components/pickers/ComponentPicker.tsx"
      to: "frontend/src/hooks/useDebounce.ts"
      via: "debounces search input before API call"
      pattern: "useDebounce"
---

<objective>
Replace the flat Select dropdowns in the simulation form with searchable picker modals that query the backend for components, enabling users to efficiently find items in databases with 200+ records.

Purpose: With 208 powders and 127 bullets in the database, flat `<Select>` dropdowns are unusable. Searchable picker modals with server-side fuzzy search let users type partial names (including with typos) and quickly find the component they need. This is the core UX improvement of v1.2.

Output: 1 new generic ComponentPicker modal component, 1 modified SimulationForm replacing 3 Select dropdowns with picker chips.
</objective>

<execution_context>
@C:/Users/vall-/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/vall-/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-frontend-integration/06-CONTEXT.md
@.planning/phases/06-frontend-integration/06-RESEARCH.md
@.planning/phases/06-frontend-integration/06-01-SUMMARY.md
@frontend/src/components/forms/SimulationForm.tsx
@frontend/src/lib/api.ts
@frontend/src/lib/types.ts
@frontend/src/hooks/useDebounce.ts
@frontend/src/components/ui/Spinner.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create generic ComponentPicker modal</name>
  <files>
    frontend/src/components/pickers/ComponentPicker.tsx
  </files>
  <action>
Create a new directory `frontend/src/components/pickers/` and file `ComponentPicker.tsx`.

This is a GENERIC modal picker component that works for any component type (powder, bullet, cartridge). It receives callbacks and rendering functions as props.

**Props interface:**
```typescript
interface ComponentPickerProps<T> {
  open: boolean;
  onClose: () => void;
  onSelect: (item: T) => void;
  title: string;              // e.g., "Seleccionar Polvora"
  fetchFn: (params: ListParams) => Promise<PaginatedResponse<T>>;
  renderItem: (item: T) => React.ReactNode;
  getId: (item: T) => string; // Extract id from item
  selectedId?: string;        // Currently selected item id (for highlighting)
}
```

**Implementation details:**

1. **Modal overlay:**
   - Fixed position, full screen, semi-transparent black backdrop (bg-black/50)
   - Centered dialog: max-w-lg, max-h-[70vh], bg-slate-800, rounded-xl, shadow-2xl
   - Close on Escape key (`onKeyDown` handler)
   - Close on backdrop click
   - Per user decision: lightweight modal, not full-page takeover

2. **Search input:**
   - Auto-focused text input at top of modal
   - Placeholder: "Escribe para buscar..." per user decision
   - Search icon (lucide-react Search) on left
   - Clear button (lucide-react X) on right when text present
   - Local state `searchTerm` + `useDebounce(searchTerm, 300)` for debounced value

3. **Data fetching with TanStack Query:**
   - Use `useQuery` internally (NOT the entity-specific hooks -- this component is generic)
   - Query key: `[title, { q: debouncedQuery, page: 1, size: 20 }]`
   - `queryFn`: call `fetchFn({ page: 1, size: 20, q: debouncedQuery.length >= 3 ? debouncedQuery : undefined })`
   - CRITICAL: Only pass `q` when debouncedQuery is >= 3 chars (backend min_length=3 requirement, prevents 422 errors)
   - When debouncedQuery is empty or < 3 chars, fetch default paginated list (no q param)
   - `enabled: open` (only fetch when modal is open)

4. **Results list:**
   - Scrollable container (overflow-y-auto, max height fills remaining modal space)
   - Each item rendered via `renderItem(item)` prop inside a clickable row
   - Rows: `hover:bg-slate-700 cursor-pointer px-4 py-3 border-b border-slate-700/50`
   - Currently selected item highlighted with `bg-blue-600/20 border-l-2 border-l-blue-500`
   - Single-click calls `onSelect(item)` then `onClose()` per user decision

5. **Loading state:**
   - Show Spinner (from `@/components/ui/Spinner`) centered in results area while `isLoading` or `isFetching`
   - Per user decision: spinner inside picker modal while search results load

6. **Empty state:**
   - When query returned 0 results AND debouncedQuery.length >= 3:
     Show "No se encontraron resultados. Intenta ajustar tu busqueda." per user decision
   - When no query entered (< 3 chars): show the default paginated list (first 20 items)

7. **Prevent body scroll:**
   - Add `overflow-hidden` to body when modal is open, restore on close (useEffect cleanup)
  </action>
  <verify>
    <automated>cd C:/Users/vall-/Desktop/projectes/simulador_balistica/frontend && npx tsc --noEmit 2>&1 | head -30</automated>
    <manual>Verify ComponentPicker.tsx exists in pickers/ directory and compiles without errors</manual>
  </verify>
  <done>
    - ComponentPicker is a generic modal with search input, debounced API queries, result list, and single-click selection
    - Modal opens/closes properly with backdrop click and Escape key
    - Search input auto-focused, debounced at 300ms, only sends q when >= 3 chars
    - Loading spinner shown while fetching
    - Empty state message shown when no results found
    - Selected item highlighted in results list
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace SimulationForm Select dropdowns with ComponentPicker chips</name>
  <files>
    frontend/src/components/forms/SimulationForm.tsx
  </files>
  <action>
Modify `frontend/src/components/forms/SimulationForm.tsx` to replace the 3 flat Select dropdowns (bullet, powder, cartridge... actually rifle has cartridge baked in, so it's rifle, bullet, powder) with searchable picker modals.

**Key insight from current code:** The form receives `rifles`, `bullets`, `powders` arrays as props and renders `<Select>` for each. We need to:
1. Remove the `bullets` and `powders` props (no longer needed -- pickers fetch their own data)
2. Keep the `rifles` prop (rifles stay as a flat Select -- only 5 records, per research recommendation)
3. Add ComponentPicker integration for bullet and powder

**Changes to SimulationFormProps:**
```typescript
interface SimulationFormProps {
  rifles: Rifle[];         // Keep -- only 5 records, flat Select is fine
  // REMOVE: bullets: Bullet[];
  // REMOVE: powders: Powder[];
  isLoading: boolean;
  onSubmit: (input: SimulationInput) => void;
}
```

**IMPORTANT:** This changes the component's public API. The parent (simulate/page.tsx) will need to stop passing `bullets` and `powders` props. Check simulate/page.tsx and update its usage:
- Currently it passes: `<SimulationForm rifles={rifles} bullets={bullets} powders={powders} ...>`
- After: `<SimulationForm rifles={rifles} ...>`
- Remove `useBullets()` and `usePowders()` calls from simulate/page.tsx IF they are only used for passing to SimulationForm. If they are used elsewhere on the page, keep them but just stop passing to SimulationForm.

**For each picker (bullet and powder), add:**

1. **State for modal visibility and selected item display:**
   ```typescript
   const [showBulletPicker, setShowBulletPicker] = useState(false);
   const [selectedBullet, setSelectedBullet] = useState<Bullet | null>(null);

   const [showPowderPicker, setShowPowderPicker] = useState(false);
   const [selectedPowder, setSelectedPowder] = useState<Powder | null>(null);
   ```

2. **Replace Select with clickable chip/card:**
   Instead of `<Select id="bullet" ...>`, render:
   ```tsx
   <div
     onClick={() => setShowBulletPicker(true)}
     className="flex items-center justify-between rounded-lg border border-slate-600 bg-slate-800 px-4 py-3 cursor-pointer
       hover:border-blue-500 transition-colors"
   >
     {selectedBullet ? (
       <div>
         <span className="text-sm font-medium text-white">{selectedBullet.name}</span>
         <span className="ml-2 text-xs text-slate-400">
           {selectedBullet.weight_grains}gr - BC G7: {selectedBullet.bc_g7 ?? 'N/D'}
         </span>
       </div>
     ) : (
       <span className="text-sm text-slate-500">-- Seleccionar proyectil --</span>
     )}
     <ChevronDown size={16} className="text-slate-400" />
   </div>
   ```
   Import ChevronDown from lucide-react.

3. **Render ComponentPicker modal:**
   ```tsx
   <ComponentPicker<Bullet>
     open={showBulletPicker}
     onClose={() => setShowBulletPicker(false)}
     onSelect={(bullet) => {
       setSelectedBullet(bullet);
       setBulletId(bullet.id);
     }}
     title="Seleccionar Proyectil"
     fetchFn={getBullets}
     getId={(b) => b.id}
     selectedId={bulletId}
     renderItem={(b) => (
       <div>
         <div className="text-sm font-medium text-white">{b.name}</div>
         <div className="text-xs text-slate-400">
           {b.manufacturer} - {b.weight_grains}gr - {b.diameter_mm}mm - BC G7: {b.bc_g7 ?? 'N/D'}
         </div>
       </div>
     )}
   />
   ```

4. **Same pattern for powder picker:**
   - Show: name, manufacturer, burn rate relative
   - renderItem: name on line 1, manufacturer + burn rate on line 2

5. **Update handleSubmit:**
   - bulletId and powderId still come from state (set via picker onSelect)
   - No changes needed to the submit payload

6. **Update canSubmit:**
   - Still checks `rifleId && bulletId && powderId && chargeGrains > 0` -- no change needed since bulletId/powderId are still set via state

7. **Import statements:**
   - Add: `import ComponentPicker from '@/components/pickers/ComponentPicker'`
   - Add: `import { getBullets, getPowders } from '@/lib/api'`
   - Add: `import { ChevronDown } from 'lucide-react'`
   - Add: `import type { Bullet, Powder } from '@/lib/types'`
   - Remove: the Select import is still needed for rifle, keep it

**Also update simulate/page.tsx:**
- Remove the `bullets` and `powders` props from the `<SimulationForm>` JSX
- Keep `rifles` prop
- If `useBullets()` and `usePowders()` are only used for passing to SimulationForm, remove those hook calls from simulate/page.tsx to reduce unnecessary data fetching. Check if they're used for anything else on the page (like displaying in results).
  </action>
  <verify>
    <automated>cd C:/Users/vall-/Desktop/projectes/simulador_balistica/frontend && npx tsc --noEmit 2>&1 | head -30</automated>
    <manual>Verify SimulationForm renders picker chips instead of Select dropdowns, and clicking them opens the modal</manual>
  </verify>
  <done>
    - Bullet and powder Selects replaced with clickable chip/card elements
    - Clicking chip opens ComponentPicker modal overlay
    - Picker modal has debounced search (300ms), shows server-side results
    - Single-click selects item, closes modal, updates form state
    - Rifle selection remains as flat Select (only 5 records)
    - SimulationForm no longer requires bullets/powders array props
    - simulate/page.tsx updated to not pass removed props
    - No TypeScript compilation errors
    - Form submission still works (same payload structure)
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. ComponentPicker.tsx exists in `frontend/src/components/pickers/`
3. SimulationForm uses ComponentPicker for bullet and powder (2 picker modals)
4. Rifle still uses flat Select dropdown
5. simulate/page.tsx compiles and no longer passes unnecessary props
6. Picker modal shows search input, results list, and handles empty/loading states
</verification>

<success_criteria>
- SRC-04 fully satisfied: Simulation form uses searchable picker modals instead of flat Select dropdowns for powder and bullet selection
- Picker modals have debounced search with server-side API queries
- Single-click selection with modal close
- Currently selected item shown as clickable card/chip
- Picker shows loading spinner and empty state messages
- No breaking changes to simulation submission (same API payload)
</success_criteria>

<output>
After completion, create `.planning/phases/06-frontend-integration/06-03-SUMMARY.md`
</output>
