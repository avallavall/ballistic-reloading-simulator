---
phase: 06-frontend-integration
plan: 02
type: execute
wave: 2
depends_on:
  - 06-01
files_modified:
  - frontend/src/app/powders/page.tsx
  - frontend/src/app/bullets/page.tsx
  - frontend/src/app/cartridges/page.tsx
autonomous: true
requirements:
  - QLT-01
  - SRC-05

must_haves:
  truths:
    - "Powders page shows Pagination controls at bottom of table and uses paginated hook"
    - "Bullets page shows Quality column with QualityBadge for each record"
    - "Cartridges page shows Quality column with QualityBadge for each record"
    - "All three pages show skeleton rows while loading instead of spinner"
    - "Navigating between pages does not flash empty content (keepPreviousData)"
    - "Changing search/filters resets page to 1"
    - "Page size selector allows 10, 20, or 50 items per page"
  artifacts:
    - path: "frontend/src/app/powders/page.tsx"
      provides: "Paginated powders table with existing quality badges and pagination controls"
      contains: "usePowdersPaginated"
    - path: "frontend/src/app/bullets/page.tsx"
      provides: "Paginated bullets table with new Quality column and pagination controls"
      contains: "useBulletsPaginated"
    - path: "frontend/src/app/cartridges/page.tsx"
      provides: "Paginated cartridges table with new Quality column and pagination controls"
      contains: "useCartridgesPaginated"
  key_links:
    - from: "frontend/src/app/powders/page.tsx"
      to: "frontend/src/components/ui/Pagination.tsx"
      via: "import Pagination component"
      pattern: "import.*Pagination"
    - from: "frontend/src/app/bullets/page.tsx"
      to: "frontend/src/components/ui/QualityBadge.tsx"
      via: "import QualityBadge component"
      pattern: "import.*QualityBadge"
    - from: "frontend/src/app/cartridges/page.tsx"
      to: "frontend/src/components/ui/QualityBadge.tsx"
      via: "import QualityBadge component"
      pattern: "import.*QualityBadge"
---

<objective>
Add quality badge columns and pagination controls to all three component list pages (powders, bullets, cartridges), replacing the current all-at-once data fetching with paginated server-side queries.

Purpose: Users have 200+ powders, 127 bullets, and 53 cartridges in the database. The current implementation loads all records at once into flat tables. This plan adds server-side pagination with smooth transitions, quality badge columns on bullets and cartridges pages, and skeleton loading states -- making large datasets navigable and displaying data quality at a glance.

Output: 3 modified page files with pagination controls, quality badges, and skeleton loading.
</objective>

<execution_context>
@C:/Users/vall-/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/vall-/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-frontend-integration/06-CONTEXT.md
@.planning/phases/06-frontend-integration/06-RESEARCH.md
@.planning/phases/06-frontend-integration/06-01-SUMMARY.md
@frontend/src/app/powders/page.tsx
@frontend/src/app/bullets/page.tsx
@frontend/src/app/cartridges/page.tsx
@frontend/src/components/ui/QualityBadge.tsx
@frontend/src/components/ui/Pagination.tsx
@frontend/src/components/ui/SkeletonRows.tsx
@frontend/src/hooks/usePowders.ts
@frontend/src/hooks/useBullets.ts
@frontend/src/hooks/useCartridges.ts
@frontend/src/lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pagination and skeleton loading to powders page, replace inline quality badge with QualityBadge component</name>
  <files>
    frontend/src/app/powders/page.tsx
  </files>
  <action>
Modify `frontend/src/app/powders/page.tsx` to use paginated data fetching and reusable components:

**1. Switch to paginated hook:**
- Add state: `const [page, setPage] = useState(1)` and `const [size, setSize] = useState(20)`
- Replace `usePowders()` with `usePowdersPaginated({ page, size })` from Plan 01
- The paginated hook returns `{ data, isLoading, isError, isPlaceholderData }` where `data` is `PaginatedResponse<Powder>` (NOT unwrapped items)
- Access powders via `data?.items ?? []` and total via `data?.total ?? 0`
- Compute `totalPages = Math.ceil((data?.total ?? 0) / size)`

**2. Replace inline quality badge with QualityBadge component:**
- Import QualityBadge from `@/components/ui/QualityBadge`
- Replace the existing inline quality badge markup (lines 706-715 with group/relative/tooltip span) with:
  `<QualityBadge score={powder.quality_score} level={powder.quality_level} tooltip={powder.quality_tooltip} />`
- This is a refactor for consistency, not a functional change

**3. Add skeleton loading state:**
- Import SkeletonRows from `@/components/ui/SkeletonRows`
- Replace the existing Spinner loading state with SkeletonRows inside the table body
- Show SkeletonRows when `isLoading` is true (initial load)
- When `isPlaceholderData` is true (page transition), show the previous data with reduced opacity (`opacity-50 transition-opacity`) while loading

**4. Add Pagination controls at bottom of table:**
- Import Pagination from `@/components/ui/Pagination`
- Place `<Pagination page={page} totalPages={totalPages} size={size} onPageChange={setPage} onSizeChange={(s) => { setSize(s); setPage(1); }} />` below the table
- When size changes, reset page to 1

**5. Reset page on other state changes:**
- If the page has any search/filter state that changes (currently powders page doesn't have server-side search in the table, but if it does), reset page to 1 when those change

**6. Ensure backward compat of CRUD operations:**
- Create/update/delete mutations should still invalidate `['powders']` queries. Additionally, invalidate `['powders', 'list']` to refresh paginated data.
- Add `queryClient.invalidateQueries({ queryKey: ['powders', 'list'] })` to create/update/delete mutation onSuccess callbacks. IMPORTANT: Keep the existing `['powders']` invalidation too so that SimulationForm/LadderTest/ParametricSearch pages that use the non-paginated `usePowders()` hook also refresh.
  </action>
  <verify>
    <automated>cd C:/Users/vall-/Desktop/projectes/simulador_balistica/frontend && npx tsc --noEmit 2>&1 | head -30</automated>
    <manual>Verify powders page still renders, shows pagination, and uses QualityBadge component</manual>
  </verify>
  <done>
    - Powders page uses usePowdersPaginated with page/size state
    - Inline quality badge replaced with reusable QualityBadge component
    - Skeleton rows shown during initial load
    - Pagination controls at bottom of table with 10/20/50 size selector
    - Page transitions are smooth (keepPreviousData prevents flash)
    - CRUD mutations invalidate both paginated and non-paginated query keys
  </done>
</task>

<task type="auto">
  <name>Task 2: Add quality badges, pagination, and skeleton loading to bullets and cartridges pages</name>
  <files>
    frontend/src/app/bullets/page.tsx
    frontend/src/app/cartridges/page.tsx
  </files>
  <action>
Modify both `frontend/src/app/bullets/page.tsx` and `frontend/src/app/cartridges/page.tsx` with the same pattern:

**For BOTH pages:**

**1. Switch to paginated hook:**
- Add `useState` for `page` (default 1) and `size` (default 20)
- Replace `useBullets()` / `useCartridges()` with `useBulletsPaginated({ page, size })` / `useCartridgesPaginated({ page, size })`
- Access items via `data?.items ?? []`, total via `data?.total ?? 0`
- Compute totalPages

**2. Add Quality column to table:**
- Import QualityBadge from `@/components/ui/QualityBadge`
- Add `<TableHead>Calidad</TableHead>` to the table header (position it as the second column after Name)
- In each row, add a `<TableCell>` with:
  ```
  <QualityBadge
    score={item.quality_score}
    level={item.quality_level}
    tooltip={item.quality_tooltip}
  />
  ```
- IMPORTANT: Bullet and Cartridge types have quality fields as OPTIONAL (`quality_score?: number`). The QualityBadge component must handle undefined gracefully (show "N/D" badge if score is undefined). This was handled in Plan 01's QualityBadge implementation.

**3. Add skeleton loading:**
- Import SkeletonRows from `@/components/ui/SkeletonRows`
- Replace Spinner with SkeletonRows in table body during `isLoading`
- Add `isPlaceholderData` opacity handling for page transitions

**4. Add Pagination controls:**
- Import Pagination from `@/components/ui/Pagination`
- Place below table with same pattern as powders page
- Reset page to 1 when size changes

**5. Update CRUD mutation invalidation:**
- Add `queryClient.invalidateQueries({ queryKey: ['bullets', 'list'] })` (or `['cartridges', 'list']`) to create/update/delete mutation onSuccess alongside existing key invalidation

**Bullets-specific:**
- Quality column after Name: Calidad
- Keep all existing columns: Nombre, Calidad (NEW), Fabricante, Peso, Diametro, BC G1, BC G7, Material, Acciones

**Cartridges-specific:**
- Quality column after Name: Calidad
- Keep all existing columns: Nombre, Calidad (NEW), Presion SAAMI, Capacidad Vaina, Largo Vaina, Diametro Anima, Acciones
  </action>
  <verify>
    <automated>cd C:/Users/vall-/Desktop/projectes/simulador_balistica/frontend && npx tsc --noEmit 2>&1 | head -30</automated>
    <manual>Verify bullets and cartridges pages show Quality column with colored badges and pagination controls</manual>
  </verify>
  <done>
    - Bullets page shows Quality column with QualityBadge component for every record
    - Cartridges page shows Quality column with QualityBadge component for every record
    - Both pages use paginated hooks with keepPreviousData
    - Skeleton rows shown during initial load on both pages
    - Pagination controls at bottom of both tables
    - CRUD mutations invalidate paginated query keys
    - No TypeScript errors
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. All three pages (powders, bullets, cartridges) import and render QualityBadge and Pagination components
3. Bullet and Cartridge tables have a new "Calidad" column
4. Powders page no longer has inline quality badge markup (uses QualityBadge component)
5. All three pages use paginated hooks (usePowdersPaginated, useBulletsPaginated, useCartridgesPaginated)
6. CRUD operations still work (mutations invalidate both paginated and non-paginated query keys)
</verification>

<success_criteria>
- QLT-01 fully satisfied: All three component list pages display quality badges on every record
- SRC-05 fully satisfied: All three pages have pagination controls with keepPreviousData for smooth transitions
- Default 20 items per page with 10/20/50 selector
- Skeleton loading instead of spinner
- No breaking changes to other pages (SimulationForm, LadderTest, ParametricSearch still use non-paginated hooks)
</success_criteria>

<output>
After completion, create `.planning/phases/06-frontend-integration/06-02-SUMMARY.md`
</output>
