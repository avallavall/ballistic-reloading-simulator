---
phase: 07-cross-phase-integration-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/main.py
  - backend/app/services/search.py
  - backend/app/api/powders.py
  - backend/app/api/bullets.py
  - backend/app/api/cartridges.py
  - frontend/src/lib/types.ts
  - frontend/src/lib/api.ts
  - frontend/src/app/powders/page.tsx
  - backend/tests/test_search_pagination.py
autonomous: true
requirements:
  - PWD-01
  - SRC-02
  - BUL-03

must_haves:
  truths:
    - "Fresh Docker boot with create_all (no Alembic) creates pg_trgm extension and GIN indexes — GET /powders?q=varget returns results without manual alembic upgrade head"
    - "When pg_trgm is unavailable (e.g., SQLite tests), search degrades to case-insensitive ILIKE and the app starts without error"
    - "Frontend GRT import with overwrite mode sends ?mode=overwrite matching backend ImportMode enum, and backend correctly overwrites collisions"
    - "Frontend TypeScript Bullet interface declares length_mm and bc_g7 as number | null matching backend nullable schema"
    - "Frontend GrtImportResult interface includes updated array and mode field matching backend response"
    - "Import result display shows N actualizadas count when overwrite mode returns updated records"
  artifacts:
    - path: "backend/app/main.py"
      provides: "pg_trgm extension + GIN index creation in lifespan, app.state.has_trgm flag"
      contains: "CREATE EXTENSION IF NOT EXISTS pg_trgm"
    - path: "backend/app/services/search.py"
      provides: "ILIKE fallback branch when has_trgm=False"
      contains: "ilike"
    - path: "frontend/src/lib/types.ts"
      provides: "Fixed nullable types for Bullet, GrtImportResult, Cartridge, Powder interfaces"
      contains: "length_mm: number | null"
    - path: "frontend/src/lib/api.ts"
      provides: "Fixed import mode query parameter"
      contains: "?mode=overwrite"
  key_links:
    - from: "backend/app/main.py"
      to: "app.state.has_trgm"
      via: "lifespan sets boolean flag after pg_trgm creation attempt"
      pattern: "app\\.state\\.has_trgm"
    - from: "backend/app/api/powders.py"
      to: "backend/app/services/search.py"
      via: "passes has_trgm=getattr(request.app.state, 'has_trgm', False) to apply_fuzzy_search"
      pattern: "has_trgm.*request\\.app\\.state"
    - from: "frontend/src/lib/api.ts"
      to: "backend/app/api/powders.py import-grt endpoint"
      via: "?mode=overwrite query parameter matching ImportMode enum"
      pattern: "mode=overwrite"
---

<objective>
Fix 4 wiring bugs between completed phases (4 and 5) so Docker fresh boot search, GRT import overwrite, and frontend type safety work correctly before Phase 6 UI work.

Purpose: Phase 6 (Frontend Integration) depends on correct API wiring. These bugs would cause search crashes on fresh boot, silent import failures, and TypeScript type errors.
Output: Backend startup creates pg_trgm on boot with graceful fallback, search service supports ILIKE degradation, frontend types and API params aligned with backend schemas.
</objective>

<execution_context>
@C:/Users/vall-/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/vall-/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-cross-phase-integration-fixes/07-RESEARCH.md
@.planning/phases/04-search-and-pagination/04-02-SUMMARY.md
@.planning/phases/05-import-pipelines-and-fixture-data/05-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix pg_trgm bootstrap and search service ILIKE fallback</name>
  <files>
    backend/app/main.py
    backend/app/services/search.py
    backend/app/api/powders.py
    backend/app/api/bullets.py
    backend/app/api/cartridges.py
  </files>
  <action>
**Bug 1 fix — pg_trgm startup in main.py lifespan:**

In `backend/app/main.py`, inside the `lifespan()` function, AFTER the existing `create_all()` block and BEFORE the seed data block, add a new try/except block that:
1. Opens a new `async with engine.begin() as conn:` block
2. Executes `await conn.execute(text("CREATE EXTENSION IF NOT EXISTS pg_trgm"))`
3. Creates all 5 GIN indexes using `CREATE INDEX IF NOT EXISTS`:
   - `ix_powders_name_trgm ON powders USING gin (name gin_trgm_ops)`
   - `ix_powders_mfg_trgm ON powders USING gin (manufacturer gin_trgm_ops)`
   - `ix_bullets_name_trgm ON bullets USING gin (name gin_trgm_ops)`
   - `ix_bullets_mfg_trgm ON bullets USING gin (manufacturer gin_trgm_ops)`
   - `ix_cartridges_name_trgm ON cartridges USING gin (name gin_trgm_ops)`
4. Sets `app.state.has_trgm = True` on success
5. Logs `logger.info("pg_trgm extension and GIN indexes ready")`
6. In the `except Exception as e:` handler: sets `app.state.has_trgm = False` and logs `logger.warning("pg_trgm unavailable (%s) - fuzzy search will use ILIKE fallback", e)` — log warning ONCE only (at startup, not per request)
7. The `text()` import is already present in main.py

**Bug 1 fix — ILIKE fallback in search.py:**

In `backend/app/services/search.py`, modify `apply_fuzzy_search()` to accept a new parameter `has_trgm: bool = True`:
1. Add `has_trgm: bool = True` as the last parameter
2. When `has_trgm` is True: use existing pg_trgm path (no changes)
3. When `has_trgm` is False: use ILIKE fallback:
   - Build pattern as `f"%{search_term}%"` (contains match — per research recommendation, `%query%` for consistency with pg_trgm substring matching)
   - Use `col.ilike(pattern)` for each search column (SQLAlchemy `.ilike()` works on both PostgreSQL and SQLite)
   - Apply `or_(*conditions)` WHERE clause
   - Order by `model.quality_score.desc()` only (no similarity function available without pg_trgm)

**Callers — pass has_trgm flag:**

In each of these 3 files, modify the list endpoint function signature to accept `request: Request` from FastAPI (import from `fastapi`), and pass `has_trgm=getattr(request.app.state, "has_trgm", False)` to `apply_fuzzy_search()`:

1. `backend/app/api/powders.py` — `list_powders()` function: add `request: Request` parameter, pass `has_trgm=getattr(request.app.state, "has_trgm", False)` to the `apply_fuzzy_search(query, Powder, q)` call
2. `backend/app/api/bullets.py` — `list_bullets()` function: same pattern
3. `backend/app/api/cartridges.py` — `list_cartridges()` function: same pattern (note: this one already passes `fields=["name"]`)

Use `getattr(request.app.state, "has_trgm", False)` defensively to handle the case where the attribute hasn't been set yet.

Do NOT modify the Alembic migration 006 — keep it intact for production use.
  </action>
  <verify>
    <automated>cd C:/Users/vall-/Desktop/projectes/simulador_balistica/backend && python -m pytest tests/test_search_pagination.py -x -v 2>&1 | tail -20</automated>
    <manual>Verify that backend/app/main.py lifespan has the pg_trgm block, search.py has ilike fallback, and all 3 callers pass has_trgm</manual>
  </verify>
  <done>
    - main.py lifespan creates pg_trgm extension + 5 GIN indexes with try/except + sets app.state.has_trgm flag
    - search.py apply_fuzzy_search has has_trgm parameter with ILIKE fallback branch using %search_term% pattern
    - All 3 list endpoints (powders, bullets, cartridges) pass has_trgm from request.app.state to apply_fuzzy_search
    - Existing tests still pass (SQLite tests will use ILIKE fallback path since has_trgm defaults to True but pg_trgm is unavailable in SQLite)
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix frontend TypeScript interfaces, API import parameter, and import result display</name>
  <files>
    frontend/src/lib/types.ts
    frontend/src/lib/api.ts
    frontend/src/app/powders/page.tsx
  </files>
  <action>
**Bug 3 fix — TypeScript nullable alignment in types.ts:**

Fix the `Bullet` interface:
- Change `length_mm: number` to `length_mm: number | null`
- Change `bc_g7: number` to `bc_g7: number | null`
- Add missing fields from backend `BulletResponse`:
  - `model_number: string | null;` (after `material`)
  - `bullet_type: string | null;` (after model_number)
  - `base_type: string | null;` (after bullet_type)

Fix the `Cartridge` interface:
- Change `cip_max_pressure_mpa: number` to `cip_max_pressure_mpa: number | null` (backend declares it as `float | None`)
- Add missing fields from backend `CartridgeResponse`:
  - `parent_cartridge_name: string | null;` (after groove_diameter_mm)
  - `shoulder_diameter_mm: number | null;` (after parent_cartridge_name)
  - `neck_diameter_mm: number | null;`
  - `base_diameter_mm: number | null;`
  - `rim_diameter_mm: number | null;`

Fix the `Powder` interface:
- Add missing field: `alias_group: string | null;` (after `web_thickness_mm`)

Also fix `BulletCreate` interface:
- Change `length_mm: number` to `length_mm?: number | null` (backend accepts null)
- Change `bc_g7: number` to `bc_g7?: number | null` (backend accepts null)

**Bug 4 fix — GrtImportResult interface in types.ts:**

Update the `GrtImportResult` interface to add:
- `updated: Powder[];` (after `created`)
- `mode: string;` (after `errors`)

**Bug 2 fix — API import parameter in api.ts:**

In `frontend/src/lib/api.ts`, in the `importGrtPowders` function, change line 109 from:
```
const url = `${API_PREFIX}/powders/import-grt${overwrite ? '?overwrite=true' : ''}`;
```
to:
```
const url = `${API_PREFIX}/powders/import-grt${overwrite ? '?mode=overwrite' : ''}`;
```

**Import result display fix in powders/page.tsx:**

1. Update the `importResult` state type from `{ created: number; skipped: string[]; errors: string[] }` to `{ created: number; updated: number; skipped: string[]; errors: string[]; mode: string }`.

2. Find where `setImportResult` is called after successful import and update it to include `updated` and `mode`:
   ```typescript
   setImportResult({
     created: data.created.length,
     updated: data.updated?.length ?? 0,
     skipped: data.skipped,
     errors: data.errors,
     mode: data.mode ?? 'skip',
   });
   ```
   Apply this in BOTH places where setImportResult is called (initial import and overwrite import).

3. In the result display section, after the created count badge, add a conditional block that shows `{importResult.updated} actualizadas` when `importResult.updated > 0`:
   ```tsx
   {importResult.updated > 0 && (
     <p>
       <Badge variant="info">{importResult.updated}</Badge>{' '}
       {importResult.updated === 1 ? 'pólvora actualizada' : 'pólvoras actualizadas'}.
     </p>
   )}
   ```
   Use variant "info" (or "default" if "info" is not available in the Badge component — check the Badge variants) for the updated count badge to distinguish from the green "created" badge.
  </action>
  <verify>
    <automated>cd C:/Users/vall-/Desktop/projectes/simulador_balistica/frontend && npx tsc --noEmit 2>&1 | tail -20</automated>
    <manual>Verify types.ts has nullable fields, api.ts sends ?mode=overwrite, powders page shows updated count</manual>
  </verify>
  <done>
    - Bullet interface declares length_mm and bc_g7 as number | null, plus model_number/bullet_type/base_type fields
    - Cartridge interface declares cip_max_pressure_mpa as number | null, plus parent_cartridge_name and 4 extended dimension fields
    - Powder interface includes alias_group field
    - BulletCreate has optional nullable length_mm and bc_g7
    - GrtImportResult includes updated array and mode field
    - api.ts sends ?mode=overwrite instead of ?overwrite=true
    - Powders page import result shows "N actualizadas" when overwrite mode returns updated records
    - TypeScript compilation passes with --noEmit
  </done>
</task>

<task type="auto">
  <name>Task 3: Add tests for pg_trgm fallback, import mode fix, and search integration</name>
  <files>
    backend/tests/test_search_pagination.py
  </files>
  <action>
Add the following tests to `backend/tests/test_search_pagination.py`:

**Test 1: test_apply_fuzzy_search_ilike_fallback**
- Import `apply_fuzzy_search` from `app.services.search`
- Create a basic SQLAlchemy select query for the Powder model
- Call `apply_fuzzy_search(query, Powder, "test", has_trgm=False)`
- Verify the returned query compiles to SQL containing `ILIKE` (use `str(query.compile(compile_kwargs={"literal_binds": True}))` or similar)
- This tests the ILIKE fallback path directly without needing PostgreSQL

**Test 2: test_apply_fuzzy_search_trgm_path**
- Same setup but call with `has_trgm=True` (default)
- Verify the returned query uses the `%` operator (trigram) rather than ILIKE
- This confirms the existing pg_trgm path is unchanged

**Test 3: test_search_ilike_fallback_returns_results**
- Using the existing async SQLite test infrastructure (from conftest.py)
- Create 3 powder records: "Hodgdon Varget", "Vihtavuori N150", "Hodgdon H4350"
- Call the list powders endpoint with `?q=Hodgdon`
- The endpoint should return results using the ILIKE fallback (since SQLite has no pg_trgm)
- Assert response status 200 and that results contain the two Hodgdon powders
- NOTE: This requires modifying the test client's app to set `app.state.has_trgm = False` in the test fixture, so the endpoint uses the ILIKE path. Check the existing conftest.py for how the test app is configured and add `app.state.has_trgm = False` after app creation.

**Test 4: test_import_grt_mode_parameter**
- Verify the backend import-grt endpoint accepts `?mode=overwrite` parameter
- Create a minimal GRT XML file fixture (can reuse from existing test_import_pipelines.py)
- POST to `/api/v1/powders/import-grt?mode=overwrite` with the file
- Assert response status is 200 (not 422 validation error)
- Assert response JSON contains `mode` field with value "overwrite"

**Test 5: test_import_grt_mode_skip_default**
- POST to `/api/v1/powders/import-grt` without mode parameter
- Assert response JSON contains `mode` field with value "skip" (the default)

All tests should follow the existing test patterns in the file (async, use the same fixtures/conftest).
  </action>
  <verify>
    <automated>cd C:/Users/vall-/Desktop/projectes/simulador_balistica/backend && python -m pytest tests/test_search_pagination.py -x -v 2>&1 | tail -30</automated>
    <manual>All new tests pass and no existing tests are broken</manual>
  </verify>
  <done>
    - 5 new tests covering: ILIKE fallback path compilation, pg_trgm path compilation, ILIKE search returns results via endpoint, import mode=overwrite acceptance, import mode=skip default
    - All existing tests continue to pass
    - Full test suite green
  </done>
</task>

</tasks>

<verification>
1. Backend: `cd backend && python -m pytest tests/ -x -v` — all tests pass (existing 317+ plus 5 new)
2. Frontend: `cd frontend && npx tsc --noEmit` — TypeScript compiles without errors
3. Code inspection: `grep -n "CREATE EXTENSION" backend/app/main.py` shows pg_trgm creation in lifespan
4. Code inspection: `grep -n "ilike" backend/app/services/search.py` shows ILIKE fallback
5. Code inspection: `grep -n "mode=overwrite" frontend/src/lib/api.ts` shows fixed parameter
6. Code inspection: `grep -n "length_mm.*null" frontend/src/lib/types.ts` shows nullable type
</verification>

<success_criteria>
- All 4 bugs fixed: pg_trgm bootstrap, import mode param, bullet nullable types, GrtImportResult interface
- Search service degrades gracefully to ILIKE when pg_trgm is unavailable
- App never fails to start due to missing pg_trgm
- TypeScript compilation passes with all interface changes
- 5 new tests pass covering all fix areas
- Full backend test suite passes
- No regressions in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/07-cross-phase-integration-fixes/07-01-SUMMARY.md`
</output>
