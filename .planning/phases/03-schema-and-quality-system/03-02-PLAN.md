---
phase: 03-schema-and-quality-system
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - frontend/src/lib/types.ts
  - frontend/src/lib/utils.ts
  - frontend/src/app/powders/page.tsx
autonomous: true
requirements:
  - PWD-02
  - PWD-03
  - PWD-04

must_haves:
  truths:
    - "User sees green/yellow/red quality badge on each powder row in the powder list table"
    - "User can hover a quality badge and see a tooltip with score breakdown (score/100, source, fields filled, missing fields)"
    - "Each powder row displays a human-readable source label (e.g. GRT Community, Manual, Fabricante)"
    - "Powder create/edit form in Advanced mode shows web_thickness_mm field with no placeholder when empty"
    - "web_thickness_mm field is hidden in Simple mode"
  artifacts:
    - path: "frontend/src/lib/types.ts"
      provides: "Powder interface with data_source, quality_score, quality_level, quality_tooltip, web_thickness_mm fields"
      contains: "quality_score"
    - path: "frontend/src/lib/utils.ts"
      provides: "Source label map and quality level helper"
      contains: "SOURCE_LABELS"
    - path: "frontend/src/app/powders/page.tsx"
      provides: "Quality badge with hover tooltip, source label, web_thickness_mm in Advanced form"
      contains: "quality_tooltip"
  key_links:
    - from: "frontend/src/app/powders/page.tsx"
      to: "frontend/src/lib/types.ts"
      via: "Powder interface type used for table rendering"
      pattern: "Powder"
    - from: "frontend/src/app/powders/page.tsx"
      to: "frontend/src/lib/utils.ts"
      via: "SOURCE_LABELS map used for display"
      pattern: "SOURCE_LABELS"
---

<objective>
Display quality badges with hover tooltips, data source labels, and web_thickness_mm field on the powder list page and create/edit form.

Purpose: Users can visually assess powder data reliability at a glance (green/yellow/red badges) and see exactly what data is missing via the tooltip. Source provenance is visible for trust assessment.
Output: Powder page shows quality information; Advanced form includes web_thickness_mm.
</objective>

<execution_context>
@C:/Users/vall-/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/vall-/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-schema-and-quality-system/03-RESEARCH.md
@.planning/phases/03-schema-and-quality-system/03-CONTEXT.md
@.planning/phases/03-schema-and-quality-system/03-01-SUMMARY.md
@frontend/src/lib/types.ts
@frontend/src/lib/utils.ts
@frontend/src/app/powders/page.tsx
@frontend/src/components/ui/Badge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: TypeScript types and utility helpers</name>
  <files>
    frontend/src/lib/types.ts
    frontend/src/lib/utils.ts
  </files>
  <action>
**1. Update `frontend/src/lib/types.ts`:**

In the `Powder` interface, add these fields (after existing fields like `has_3curve`):
```typescript
data_source: string;
quality_score: number;
quality_level: string;      // "success" | "warning" | "danger"
quality_tooltip: string;    // One-line breakdown from API
web_thickness_mm: number | null;
```

In `PowderCreate` interface, add:
```typescript
data_source?: string;       // defaults to "manual" on server
web_thickness_mm?: number | null;
```

In `PowderUpdate` interface (if it exists, otherwise in the partial type used for updates), add:
```typescript
data_source?: string;
web_thickness_mm?: number | null;
```

**2. Update `frontend/src/lib/utils.ts`:**

Add a source label map for human-readable display (interface is in Spanish per project convention):
```typescript
export const SOURCE_LABELS: Record<string, string> = {
  manufacturer: 'Fabricante',
  grt_community: 'GRT Community',
  grt_modified: 'GRT Modificado',
  manual: 'Manual',
  estimated: 'Estimado',
};
```

Add a helper function:
```typescript
export function getSourceLabel(source: string): string {
  return SOURCE_LABELS[source] || source;
}
```
  </action>
  <verify>
Run: `cd frontend && npx tsc --noEmit` -- no TypeScript compilation errors.
  </verify>
  <done>
Powder interface includes all quality-related fields. Source label map provides Spanish-friendly display names. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Quality badges, tooltip, source label, and web_thickness in powder page</name>
  <files>
    frontend/src/app/powders/page.tsx
  </files>
  <action>
**1. Add quality badge with hover tooltip to the powder table:**

In the table that lists powders, add a new column "Calidad" (Quality). For each powder row, render:

```tsx
<td className="...">
  <span className="group relative inline-flex items-center cursor-default">
    <Badge variant={powder.quality_level as 'success' | 'warning' | 'danger'}>
      {powder.quality_score}
    </Badge>
    {/* Tooltip on hover - per user decision: purely informational, no edit links */}
    <span className="pointer-events-none absolute bottom-full left-1/2 -translate-x-1/2 mb-2
      whitespace-nowrap rounded bg-slate-800 px-3 py-1.5 text-xs text-slate-200
      opacity-0 transition-opacity group-hover:opacity-100 border border-slate-600 shadow-lg z-10">
      {powder.quality_tooltip}
    </span>
  </span>
</td>
```

Import `Badge` from `@/components/ui/Badge` if not already imported.

**2. Add source label to the powder table:**

Add a "Fuente" (Source) column to the table. For each row, display the human-readable source label:

```tsx
<td className="...">
  <span className="text-xs text-slate-400">
    {getSourceLabel(powder.data_source)}
  </span>
</td>
```

Import `getSourceLabel` from `@/lib/utils`.

**3. Add web_thickness_mm to the Advanced section of the create/edit form:**

The powder page already has a collapsible "Avanzado" section for 3-curve parameters (ba, bp, br, brp, z1, z2, a0). In that same Advanced section, add a `web_thickness_mm` field:

```tsx
<Input
  label="Espesor de alma (mm)"
  type="number"
  step="0.01"
  min="0.1"
  max="2.0"
  value={formData.web_thickness_mm ?? ''}
  onChange={(e) => setFormData({...formData, web_thickness_mm: e.target.value ? parseFloat(e.target.value) : null})}
/>
```

Per user decisions:
- Only visible in Advanced mode (hidden in Simple mode) -- it is already in the Advanced section
- Show empty/blank when not set (no "default 0.4mm" placeholder) -- use `value ?? ''`
- Units in mm (consistent with COAL/mm convention)

**4. Include `data_source` and `web_thickness_mm` in form submission:**

When submitting the create form, include `web_thickness_mm` in the payload (only if set, otherwise omit or send null). Do NOT include `data_source` in the create form (server defaults to "manual").

When submitting the edit/update form, include `web_thickness_mm` if the field has a value. Do NOT allow editing `data_source` from the form (it is managed by the system: manual for new, grt_modified for edited GRT powders).

**5. Update table header row:**

Add `<th>Calidad</th>` and `<th>Fuente</th>` to the table header. Position them after the powder name column for visibility.
  </action>
  <verify>
Run: `cd frontend && npx tsc --noEmit` -- no TypeScript compilation errors.
Run: `cd frontend && npm run build` -- build succeeds without errors.
  </verify>
  <done>
Powder list table shows quality badge (green/yellow/red) with hover tooltip showing score breakdown. Source label displayed as small text. web_thickness_mm editable in Advanced form section with no placeholder. Table columns include Calidad and Fuente. Build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` -- TypeScript compiles cleanly
2. `cd frontend && npm run build` -- Next.js build succeeds
3. Visual check: Powder interface in types.ts has quality_score, data_source, quality_level, quality_tooltip, web_thickness_mm
4. Visual check: powders/page.tsx has Badge import, group-hover tooltip pattern, SOURCE_LABELS usage, web_thickness_mm Input in Advanced section
</verification>

<success_criteria>
- Each powder row shows a colored badge (green >= 70, yellow >= 40, red < 40) with numeric score
- Hovering the badge reveals a one-sentence tooltip: "78/100 â€” GRT Community, 8/10 campos, faltan: web_thickness, ba, bp (+4)"
- Source label visible on each row: "GRT Community", "Manual", "Fabricante", etc.
- web_thickness_mm field in Advanced section, empty when not set, editable with 0.1-2.0 range
- Frontend builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-schema-and-quality-system/03-02-SUMMARY.md`
</output>
