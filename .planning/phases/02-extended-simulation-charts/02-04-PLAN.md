---
phase: 02-extended-simulation-charts
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/schemas/simulation.py
  - backend/app/api/simulate.py
  - frontend/src/lib/types.ts
  - frontend/src/hooks/useSensitivity.ts
  - frontend/src/components/panels/SensitivityPanel.tsx
autonomous: true
gap_closure: true
requirements:
  - CHART-05

must_haves:
  truths:
    - "User can drag the barrel length slider and see all charts update with the new barrel length"
    - "Barrel length override is transient — it does not modify the rifle record in the database"
    - "Backend /simulate/direct and /simulate/sensitivity accept an optional barrel_length_mm_override field"
  artifacts:
    - path: "backend/app/schemas/simulation.py"
      provides: "barrel_length_mm_override field on DirectSimulationRequest and SensitivityRequest"
      contains: "barrel_length_mm_override"
    - path: "backend/app/api/simulate.py"
      provides: "Override logic in _make_params and both direct/sensitivity endpoints"
      contains: "barrel_length_mm_override"
    - path: "frontend/src/hooks/useSensitivity.ts"
      provides: "Barrel length passed to re-simulation calls"
      contains: "barrel_length_mm_override"
    - path: "frontend/src/components/panels/SensitivityPanel.tsx"
      provides: "Enabled barrel length slider with delta badge"
      contains: "onBarrelLengthChange"
  key_links:
    - from: "frontend/src/hooks/useSensitivity.ts"
      to: "/simulate/direct"
      via: "barrel_length_mm_override in API call payload"
      pattern: "barrel_length_mm_override"
    - from: "frontend/src/components/panels/SensitivityPanel.tsx"
      to: "frontend/src/hooks/useSensitivity.ts"
      via: "onBarrelLengthChange callback triggers debounced re-simulation"
      pattern: "onBarrelLengthChange"
    - from: "backend/app/api/simulate.py"
      to: "backend/app/core/solver.py"
      via: "_make_params barrel_length_m override applied to RifleParams"
      pattern: "barrel_length_mm_override"
---

<objective>
Close the barrel length slider gap identified in 02-VERIFICATION.md. The SensitivityPanel currently renders a disabled barrel length slider labeled "(proximamente)". This plan adds backend support for a barrel_length_mm_override parameter on the /simulate/direct and /simulate/sensitivity endpoints, then enables the frontend slider to use it.

Purpose: Complete CHART-05 requirement — all three sensitivity sliders (charge weight, seating depth, barrel length) must be functional.
Output: Barrel length slider works end-to-end: user drags slider, API receives override, solver uses overridden barrel length, charts update.
</objective>

<execution_context>
@C:/Users/vall-/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/vall-/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-extended-simulation-charts/02-03-SUMMARY.md
@backend/app/schemas/simulation.py
@backend/app/api/simulate.py
@frontend/src/hooks/useSensitivity.ts
@frontend/src/components/panels/SensitivityPanel.tsx
@frontend/src/lib/types.ts
@frontend/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add barrel_length_mm_override to backend schemas and endpoints</name>
  <files>
    backend/app/schemas/simulation.py
    backend/app/api/simulate.py
  </files>
  <action>
    **In `backend/app/schemas/simulation.py`:**

    1. Add an optional `barrel_length_mm_override` field to `DirectSimulationRequest`:
       ```python
       barrel_length_mm_override: float | None = Field(default=None, gt=100, le=1500, description="Optional barrel length override (mm). If provided, overrides the rifle's barrel length for this simulation only.")
       ```

    2. Add the same optional field to `SensitivityRequest`:
       ```python
       barrel_length_mm_override: float | None = Field(default=None, gt=100, le=1500, description="Optional barrel length override (mm)")
       ```

    **In `backend/app/api/simulate.py`:**

    3. Modify `_make_params` to accept an optional `barrel_length_mm_override` parameter:
       - Add parameter: `barrel_length_mm_override: float | None = None`
       - In the RifleParams construction, use the override if provided:
         ```python
         barrel_length_m = (barrel_length_mm_override * MM_TO_M) if barrel_length_mm_override else (rifle_row.barrel_length_mm * MM_TO_M)
         rif = RifleParams(
             barrel_length_m=barrel_length_m,
             twist_rate_m=rifle_row.twist_rate_mm * MM_TO_M,
             rifle_mass_kg=rifle_row.weight_kg if rifle_row.weight_kg else 3.5,
         )
         ```

    4. Update the `run_direct_simulation` endpoint to pass the override:
       - Change the `_make_params` call to include `barrel_length_mm_override=req.barrel_length_mm_override`

    5. Update the `run_sensitivity` endpoint to pass the override:
       - In the loop that calls `_make_params` for center/upper/lower, pass `barrel_length_mm_override=req.barrel_length_mm_override`

    **Important:** Do NOT modify _make_params calls in `run_simulation` (Load-based), `run_ladder_test`, or `run_parametric_search` — those do not accept barrel length overrides.
  </action>
  <verify>
    Run backend tests to verify no regressions:
    ```bash
    cd backend && python -m pytest tests/ -v --tb=short
    ```
    All existing tests must pass. The override field is optional with a default of None, so all existing callers are unaffected.
  </verify>
  <done>
    - DirectSimulationRequest and SensitivityRequest schemas accept `barrel_length_mm_override: float | None`
    - `_make_params` uses the override when provided, falls back to rifle DB value when None
    - `/simulate/direct` and `/simulate/sensitivity` pass the override through
    - All existing tests pass without modification
  </done>
</task>

<task type="auto">
  <name>Task 2: Enable barrel length slider in frontend sensitivity explorer</name>
  <files>
    frontend/src/lib/types.ts
    frontend/src/hooks/useSensitivity.ts
    frontend/src/components/panels/SensitivityPanel.tsx
  </files>
  <action>
    **In `frontend/src/lib/types.ts`:**

    1. Add `barrel_length_mm_override?: number` to the `SimulationInput` interface (after seating_depth_mm).

    2. Add `barrel_length_mm_override?: number` to the `SensitivityInput` interface (after charge_delta_grains).

    **In `frontend/src/hooks/useSensitivity.ts`:**

    3. Add `originalBarrelLengthMm: number` to the `UseSensitivityOptions` interface (new field alongside originalParams).

    4. Change the `barrelLengthMm` state initialization from `useState(0)` to `useState(originalBarrelLengthMm)`. Remove the "Display only" comment.

    5. Add `barrelLengthMm` to the reset effect that fires when originalParams change — also reset barrel length to `originalBarrelLengthMm`.

    6. Update the `hasChanged` callback to also check barrel length:
       ```typescript
       const hasChanged = useCallback(() => {
         const orig = origRef.current;
         return (
           chargeGrains !== orig.powder_charge_grains ||
           seatingDepthMm !== orig.seating_depth_mm ||
           barrelLengthMm !== originalBarrelLengthMm
         );
       }, [chargeGrains, seatingDepthMm, barrelLengthMm, originalBarrelLengthMm]);
       ```

    7. In the debounced re-simulation effect:
       - Add `barrelLengthMm` to the dependency array (alongside chargeGrains and seatingDepthMm)
       - In the `params` object passed to `simMutation.mutate()`, add:
         ```typescript
         barrel_length_mm_override: barrelLengthMm !== originalBarrelLengthMm ? barrelLengthMm : undefined,
         ```
       - Same for the `sensMutation.mutate()` call — include barrel_length_mm_override in both the "no change" sensitivity call and the "has changed" sensitivity call.

    8. In the `reset` callback, also reset barrel length: `setBarrelLengthMm(originalBarrelLengthMm)`.

    **In `frontend/src/components/panels/SensitivityPanel.tsx`:**

    9. Add `onBarrelLengthChange: (v: number) => void` to the `SensitivityPanelProps` interface.

    10. Replace the disabled barrel length slider section (currently wrapped in `<div className="opacity-50">`) with a fully functional slider:
       - Remove the `opacity-50` class from the wrapper div
       - Remove `disabled` attribute from the range input
       - Change cursor class from `cursor-not-allowed` to `cursor-pointer`
       - Change background opacity from `opacity-50` to nothing (same as other sliders)
       - Add `onChange={(e) => onBarrelLengthChange(parseFloat(e.target.value))}` handler
       - Change `accent` class to match other sliders: `accent-blue-500`
       - Remove the "(proximamente)" text
       - Change label text color from `text-slate-400` to `text-slate-300` (matching other sliders)
       - Compute `barrelDelta = barrelLengthMm - originalBarrelLength` and show DeltaBadge for barrel length (invert=false since longer barrel = higher velocity = good)
       - Add center tick mark showing original barrel length (matching charge and seating patterns)

    **In `frontend/src/app/simulate/page.tsx`:**

    11. Pass `originalBarrelLengthMm={rifleBarrelLength}` to the `useSensitivity` hook call. The hook options interface now expects this field.

    12. Pass `onBarrelLengthChange={sensitivity.setBarrelLengthMm}` to the SensitivityPanel props.
  </action>
  <verify>
    Build the frontend to verify no TypeScript errors:
    ```bash
    cd frontend && npx next build 2>&1 | tail -30
    ```
    If Docker is available, run the full stack and manually test the barrel length slider triggers re-simulation.
  </verify>
  <done>
    - `SimulationInput` and `SensitivityInput` types include `barrel_length_mm_override`
    - `useSensitivity` hook tracks barrel length state and includes it in debounced re-simulation calls
    - `SensitivityPanel` barrel length slider is fully enabled with onChange handler, delta badge, and matching visual style
    - Barrel length changes trigger debounced API calls with the override field
    - All three sliders (charge, seating, barrel) are functional and visually consistent
  </done>
</task>

</tasks>

<verification>
1. **Backend schema validation:** `barrel_length_mm_override` field accepts floats >100 and <=1500 (mm), or None. Existing requests without the field still work (backward compatible).
2. **Backend endpoint behavior:** When `barrel_length_mm_override` is provided, the solver uses that value instead of the rifle's DB barrel length. When omitted, behavior is unchanged.
3. **Frontend slider behavior:** Dragging the barrel length slider triggers a debounced re-simulation (300ms). All charts update. Delta badge shows difference vs original.
4. **Reset behavior:** Clicking "Restablecer" resets barrel length slider to the rifle's original value.
5. **All existing tests pass:** `cd backend && python -m pytest tests/ -v` — no regressions.
6. **Frontend builds:** `cd frontend && npx next build` — no TypeScript errors.
</verification>

<success_criteria>
- Barrel length slider in the Sensitivity Panel is enabled and interactive (not disabled or grayed out)
- Dragging the barrel length slider causes charts to update with new simulation results
- The override is transient: no database writes occur when the slider is moved
- All three sensitivity sliders (charge weight, seating depth, barrel length) are functional
- CHART-05 requirement is fully satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/02-extended-simulation-charts/02-04-SUMMARY.md`
</output>
