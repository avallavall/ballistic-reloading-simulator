---
phase: 05-import-pipelines-and-fixture-data
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/db/migrations/versions/007_import_pipelines.py
  - backend/app/models/powder.py
  - backend/app/models/bullet.py
  - backend/app/models/cartridge.py
  - backend/app/schemas/powder.py
  - backend/app/schemas/bullet.py
  - backend/app/schemas/cartridge.py
  - backend/app/core/quality.py
autonomous: true
requirements: [PWD-05, BUL-02, BUL-03, CRT-02]

must_haves:
  truths:
    - "Powder model has alias_group column for linking equivalent powders across markets"
    - "Bullet model has model_number, bullet_type, base_type columns for manufacturer data"
    - "Bullet length_mm is nullable so records without length data can be imported"
    - "Cartridge model has parent_cartridge_name and extended dimension columns"
    - "Import schemas define 3-mode collision handling (skip/overwrite/merge) and ImportResult"
    - "Quality scoring includes new bullet bonus fields (model_number, bullet_type, base_type) in completeness calculation"
  artifacts:
    - path: "backend/app/db/migrations/versions/007_import_pipelines.py"
      provides: "Alembic migration for all new columns"
      contains: "alias_group"
    - path: "backend/app/models/powder.py"
      provides: "alias_group column"
      contains: "alias_group"
    - path: "backend/app/models/bullet.py"
      provides: "model_number, bullet_type, base_type columns + nullable length_mm"
      contains: "model_number"
    - path: "backend/app/models/cartridge.py"
      provides: "parent_cartridge_name and extended dimension columns"
      contains: "parent_cartridge_name"
    - path: "backend/app/schemas/bullet.py"
      provides: "BulletImportRequest, ImportMode enum, ImportResult schema"
      contains: "ImportMode"
  key_links:
    - from: "backend/app/db/migrations/versions/007_import_pipelines.py"
      to: "backend/app/models/powder.py"
      via: "Migration adds alias_group column that model declares"
      pattern: "alias_group.*String\\(100\\)"
    - from: "backend/app/schemas/bullet.py"
      to: "backend/app/models/bullet.py"
      via: "Schema fields match model columns for new bullet fields"
      pattern: "model_number|bullet_type|base_type"
---

<objective>
Add database columns and Pydantic schemas required for Phase 5 import pipelines: powder alias groups, extended bullet fields (model_number, bullet_type, base_type), nullable bullet length_mm, cartridge parent lineage and extended dimensions, and shared import infrastructure schemas (ImportMode enum, ImportResult).

Purpose: Foundation for fixture data loading and batch import endpoints. Without these schema changes, neither the fixture data (Plan 02) nor the import endpoints (Plan 03) can function.
Output: Migration 007, updated ORM models, updated Pydantic schemas with import request/result types.
</objective>

<execution_context>
@C:/Users/vall-/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/vall-/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-import-pipelines-and-fixture-data/05-RESEARCH.md

Key existing files:
@backend/app/models/powder.py
@backend/app/models/bullet.py
@backend/app/models/cartridge.py
@backend/app/schemas/powder.py
@backend/app/schemas/bullet.py
@backend/app/schemas/cartridge.py
@backend/app/core/quality.py
@backend/app/db/migrations/versions/006_search_and_pagination.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Alembic migration 007 and update ORM models</name>
  <files>
    backend/app/db/migrations/versions/007_import_pipelines.py
    backend/app/models/powder.py
    backend/app/models/bullet.py
    backend/app/models/cartridge.py
  </files>
  <action>
Create Alembic migration `007_import_pipelines.py` with `depends_on` pointing to the revision ID of migration 006. Follow the exact pattern of existing migrations (read 006 for the style: revision/down_revision strings, sa imports, op.add_column/alter_column).

**upgrade():**
1. Powder: `op.add_column("powders", sa.Column("alias_group", sa.String(100), nullable=True))` + `op.create_index("ix_powders_alias_group", "powders", ["alias_group"])`
2. Bullet: `op.add_column("bullets", sa.Column("model_number", sa.String(50), nullable=True))`, `op.add_column("bullets", sa.Column("bullet_type", sa.String(30), nullable=True))`, `op.add_column("bullets", sa.Column("base_type", sa.String(50), nullable=True))`, `op.alter_column("bullets", "length_mm", existing_type=sa.Float, nullable=True)`
3. Cartridge: `op.add_column("cartridges", sa.Column("parent_cartridge_name", sa.String(100), nullable=True))`, `op.add_column("cartridges", sa.Column("shoulder_diameter_mm", sa.Float, nullable=True))`, `op.add_column("cartridges", sa.Column("neck_diameter_mm", sa.Float, nullable=True))`, `op.add_column("cartridges", sa.Column("base_diameter_mm", sa.Float, nullable=True))`, `op.add_column("cartridges", sa.Column("rim_diameter_mm", sa.Float, nullable=True))`

**downgrade():** Reverse all operations (drop columns, alter back to NOT NULL).

Then update ORM models:
- `powder.py`: Add `alias_group = Column(String(100), nullable=True, index=True)` after the `a0` field block.
- `bullet.py`: Add `model_number = Column(String(50), nullable=True)`, `bullet_type = Column(String(30), nullable=True)`, `base_type = Column(String(50), nullable=True)` after `material` column. Change `length_mm = Column(Float, nullable=False)` to `length_mm = Column(Float, nullable=True)`.
- `cartridge.py`: Add `parent_cartridge_name = Column(String(100), nullable=True)`, `shoulder_diameter_mm = Column(Float, nullable=True)`, `neck_diameter_mm = Column(Float, nullable=True)`, `base_diameter_mm = Column(Float, nullable=True)`, `rim_diameter_mm = Column(Float, nullable=True)` after `groove_diameter_mm`.
  </action>
  <verify>
Read migration file and all three model files to confirm:
1. Migration has correct up/down operations for all columns
2. ORM models declare matching columns
3. `length_mm` is nullable=True in Bullet model
4. `alias_group` has index=True in Powder model
  </verify>
  <done>
Migration 007 exists with all column additions. Powder has alias_group, Bullet has model_number/bullet_type/base_type and nullable length_mm, Cartridge has parent_cartridge_name and 4 extended dimension columns. All ORM models match migration columns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Pydantic schemas and quality scoring for new fields</name>
  <files>
    backend/app/schemas/powder.py
    backend/app/schemas/bullet.py
    backend/app/schemas/cartridge.py
    backend/app/core/quality.py
  </files>
  <action>
**Powder schemas** (`schemas/powder.py`):
- Add `alias_group: str | None = Field(None, max_length=100, description="Alias group identifier linking equivalent powders")` to PowderCreate and PowderUpdate.
- Add `alias_group: str | None = None` to PowderResponse.
- Update `GrtImportResult` to add `updated: list[PowderResponse] = Field(default_factory=list)` field (for overwrite/merge results). Also add `mode: str = "skip"` field to track which mode was used.
- Add a shared `ImportMode` enum (str, Enum) at the top of the file with values: `skip = "skip"`, `overwrite = "overwrite"`, `merge = "merge"`. This will be imported by other modules too.
- Add `ImportResult` base schema: `created: int = 0`, `updated: int = 0`, `skipped: list[str] = Field(default_factory=list)`, `errors: list[str] = Field(default_factory=list)`.

**Bullet schemas** (`schemas/bullet.py`):
- Add to BulletCreate: `model_number: str | None = Field(None, max_length=50, description="Manufacturer part number")`, `bullet_type: str | None = Field(None, max_length=30, description="Type: match, hunting, target")`, `base_type: str | None = Field(None, max_length=50, description="Base type: hollow_point_boat_tail, polymer_tip, flat_base, etc.")`.
- Change `length_mm` in BulletCreate from required to optional: `length_mm: float | None = Field(None, gt=0, le=100, description="Bullet length (mm), nullable for incomplete data")`.
- Add same 3 new fields + nullable length_mm to BulletUpdate (all optional as they already are in updates).
- Add `model_number`, `bullet_type`, `base_type` to BulletResponse.
- Change BulletResponse `length_mm` from `float` to `float | None`.
- Add `BulletImportRequest(BaseModel)` with field `bullets: list[BulletCreate]`.

**Cartridge schemas** (`schemas/cartridge.py`):
- Add to CartridgeCreate: `parent_cartridge_name: str | None = Field(None, max_length=100, description="Parent cartridge name for lineage")`, `shoulder_diameter_mm: float | None = Field(None, gt=0, le=20)`, `neck_diameter_mm: float | None = Field(None, gt=0, le=20)`, `base_diameter_mm: float | None = Field(None, gt=0, le=20)`, `rim_diameter_mm: float | None = Field(None, gt=0, le=20)`.
- Add same fields to CartridgeUpdate (all optional).
- Add same fields to CartridgeResponse.
- Add `CartridgeImportRequest(BaseModel)` with field `cartridges: list[CartridgeCreate]`.

**Quality scoring** (`core/quality.py`):
- Add `model_number`, `bullet_type`, `base_type` to `BULLET_BONUS_FIELDS` list (increases total fields from 6 to 9 for bullets -- these are bonus, not critical).
- Add `parent_cartridge_name`, `shoulder_diameter_mm`, `neck_diameter_mm`, `base_diameter_mm`, `rim_diameter_mm` to `CARTRIDGE_BONUS_FIELDS` list (increases total cartridge fields from 7 to 12).
- No formula changes needed -- the existing 30/70 completeness/source formula handles the expanded field lists automatically.

IMPORTANT: Import the `ImportMode` enum and `ImportResult` from `schemas/powder.py` where needed in Plan 03. For now, just define them there. Also add `from enum import Enum` import to `schemas/powder.py`.
  </action>
  <verify>
Read all four modified files and confirm:
1. PowderCreate/Update/Response all include alias_group
2. BulletCreate has nullable length_mm and 3 new optional fields (model_number, bullet_type, base_type)
3. BulletResponse has matching fields with correct types
4. CartridgeCreate/Response have 5 new fields (parent_cartridge_name + 4 dims)
5. ImportMode enum has 3 values (skip, overwrite, merge)
6. ImportResult schema has created/updated/skipped/errors
7. BulletImportRequest and CartridgeImportRequest exist
8. BULLET_BONUS_FIELDS has 5 entries (bc_g7, length_mm, model_number, bullet_type, base_type)
9. CARTRIDGE_BONUS_FIELDS has 8 entries
  </verify>
  <done>
All schemas updated with new fields matching ORM models. ImportMode enum and ImportResult provide shared import infrastructure. Quality scoring accounts for new bonus fields. BulletImportRequest and CartridgeImportRequest ready for batch import endpoints in Plan 03.
  </done>
</task>

</tasks>

<verification>
1. Read migration 007 and confirm all columns match between migration and ORM models
2. Verify `ImportMode` enum has exactly 3 values: skip, overwrite, merge
3. Verify `length_mm` is nullable in both Bullet model and BulletCreate schema
4. Verify quality scoring BONUS_FIELDS lists include new fields
5. Run `cd backend && python -c "from app.models.powder import Powder; from app.models.bullet import Bullet; from app.models.cartridge import Cartridge; print('Models OK')"` to verify import works
</verification>

<success_criteria>
- Migration 007 adds 11 new columns (1 powder, 4 bullet incl. alter, 5 cartridge) with correct downgrade
- All ORM models declare matching columns
- All Pydantic schemas include new fields with appropriate validation
- ImportMode enum, ImportResult, BulletImportRequest, CartridgeImportRequest schemas exist
- Quality scoring BONUS_FIELDS expanded for bullets and cartridges
</success_criteria>

<output>
After completion, create `.planning/phases/05-import-pipelines-and-fixture-data/05-01-SUMMARY.md`
</output>
