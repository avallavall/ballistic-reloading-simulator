---
phase: 11-foundation-and-data-expansion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/models/bullet.py
  - backend/app/models/cartridge.py
  - backend/app/schemas/bullet.py
  - backend/app/schemas/cartridge.py
  - backend/app/core/quality.py
  - backend/app/db/migrations/versions/009_schema_extensions.py
  - backend/app/seed/fixtures/cartridges.json
  - frontend/src/lib/types.ts
autonomous: true
requirements:
  - SCHM-01
  - SCHM-02

must_haves:
  truths:
    - "Cartridge model accepts 5 new optional drawing fields (shoulder_angle_deg, neck_length_mm, body_length_mm, rim_thickness_mm, case_type) and saves them to the database"
    - "Bullet model accepts 4 new rendering fields (bearing_surface_mm, boat_tail_length_mm, meplat_diameter_mm, ogive_type) and 5 velocity-banded BC fields (bc_g1_high, bc_g1_mid, bc_g1_low, bc_g1_high_vel, bc_g1_mid_vel) and saves them to the database"
    - "Quality scoring includes new fields in BONUS_FIELDS so filling them improves quality score"
    - "All 53 existing cartridges in cartridges.json have estimated values for the 5 new fields"
    - "Frontend TypeScript interfaces include all new fields"
  artifacts:
    - path: "backend/app/db/migrations/versions/009_schema_extensions.py"
      provides: "Alembic migration adding 14 new columns across bullets and cartridges tables"
      contains: "add_column"
    - path: "backend/app/models/bullet.py"
      provides: "9 new SQLAlchemy columns on Bullet"
    - path: "backend/app/models/cartridge.py"
      provides: "5 new SQLAlchemy columns on Cartridge"
    - path: "backend/app/schemas/bullet.py"
      provides: "9 new Pydantic fields on BulletCreate/Update/Response"
    - path: "backend/app/schemas/cartridge.py"
      provides: "5 new Pydantic fields on CartridgeCreate/Update/Response"
    - path: "backend/app/core/quality.py"
      provides: "Updated BULLET_BONUS_FIELDS and CARTRIDGE_BONUS_FIELDS lists"
    - path: "frontend/src/lib/types.ts"
      provides: "Updated Bullet and Cartridge TypeScript interfaces"
  key_links:
    - from: "backend/app/schemas/bullet.py"
      to: "backend/app/models/bullet.py"
      via: "from_attributes ORM mapping"
      pattern: "model_config.*from_attributes"
    - from: "backend/app/core/quality.py"
      to: "backend/app/schemas/bullet.py"
      via: "BULLET_BONUS_FIELDS list used in quality_tooltip"
      pattern: "BULLET_BONUS_FIELDS"
    - from: "backend/app/db/migrations/versions/009_schema_extensions.py"
      to: "backend/app/models/bullet.py"
      via: "Migration columns match model columns"
      pattern: "add_column.*bullets"
---

<objective>
Extend Cartridge and Bullet database schemas with drawing/rendering dimension fields and Sierra velocity-banded BC fields. Update quality scoring, Pydantic schemas, Alembic migration, cartridge fixture backfill, and frontend TypeScript interfaces.

Purpose: These schema extensions are the foundation for the geometry engine (SCHM-03), 2D SVG drawings (Phase 12), 3D viewer (Phase 13), and the expanded bullet database (DATA-01). Without these columns, no visualization or expanded data work can proceed.

Output: Alembic migration 009, updated models/schemas/quality/types, backfilled cartridges.json
</objective>

<execution_context>
@C:/Users/vall-/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/vall-/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-foundation-and-data-expansion/11-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From backend/app/models/bullet.py (current):
```python
class Bullet(UUIDMixin, Base):
    __tablename__ = "bullets"
    name = Column(String(100), nullable=False, unique=True)
    manufacturer = Column(String(100), nullable=False)
    weight_grains = Column(Float, nullable=False)
    diameter_mm = Column(Float, nullable=False)
    length_mm = Column(Float, nullable=True)
    bc_g1 = Column(Float, nullable=False)
    bc_g7 = Column(Float, nullable=True)
    sectional_density = Column(Float, nullable=False)
    material = Column(String(50), nullable=False, default="copper")
    model_number = Column(String(50), nullable=True)
    bullet_type = Column(String(30), nullable=True)
    base_type = Column(String(50), nullable=True)
    data_source = Column(String(20), nullable=False, default="manual")
    quality_score = Column(Integer, nullable=False, default=0)
    caliber_family = Column(String(20), nullable=True)
```

From backend/app/models/cartridge.py (current):
```python
class Cartridge(UUIDMixin, Base):
    __tablename__ = "cartridges"
    name = Column(String(100), nullable=False, unique=True)
    saami_max_pressure_psi = Column(Float, nullable=False)
    cip_max_pressure_mpa = Column(Float, nullable=True)
    case_capacity_grains_h2o = Column(Float, nullable=False)
    case_length_mm = Column(Float, nullable=False)
    overall_length_mm = Column(Float, nullable=False)
    bore_diameter_mm = Column(Float, nullable=False)
    groove_diameter_mm = Column(Float, nullable=False)
    parent_cartridge_name = Column(String(100), nullable=True)
    shoulder_diameter_mm = Column(Float, nullable=True)
    neck_diameter_mm = Column(Float, nullable=True)
    base_diameter_mm = Column(Float, nullable=True)
    rim_diameter_mm = Column(Float, nullable=True)
    data_source = Column(String(20), nullable=False, default="manual")
    quality_score = Column(Integer, nullable=False, default=0)
    caliber_family = Column(String(20), nullable=True)
```

From backend/app/core/quality.py (current):
```python
BULLET_BONUS_FIELDS = ["bc_g7", "length_mm", "model_number", "bullet_type", "base_type"]
CARTRIDGE_BONUS_FIELDS = ["cip_max_pressure_mpa", "case_length_mm", "overall_length_mm", "parent_cartridge_name", "shoulder_diameter_mm", "neck_diameter_mm", "base_diameter_mm", "rim_diameter_mm"]
```

Last Alembic migration: 008_fix_cartridge_caliber_backfill.py
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema extensions — models, schemas, migration, quality, frontend types</name>
  <files>
    backend/app/models/bullet.py
    backend/app/models/cartridge.py
    backend/app/schemas/bullet.py
    backend/app/schemas/cartridge.py
    backend/app/core/quality.py
    backend/app/db/migrations/versions/009_schema_extensions.py
    frontend/src/lib/types.ts
  </files>
  <action>
**Bullet model** — Add 9 new nullable columns to `backend/app/models/bullet.py`:

Rendering fields (4):
- `bearing_surface_mm = Column(Float, nullable=True)` — bearing surface length in mm
- `boat_tail_length_mm = Column(Float, nullable=True)` — boat tail length in mm
- `meplat_diameter_mm = Column(Float, nullable=True)` — meplat (tip) diameter in mm
- `ogive_type = Column(String(20), nullable=True)` — one of: tangent, secant, hybrid, flat_nose, round_nose, spitzer. Use String(20) NOT native ENUM (Alembic migration complexity per research decision).

Velocity-banded BC fields (5):
- `bc_g1_high = Column(Float, nullable=True)` — BC at high velocity (Sierra only)
- `bc_g1_mid = Column(Float, nullable=True)` — BC at mid velocity
- `bc_g1_low = Column(Float, nullable=True)` — BC at low velocity
- `bc_g1_high_vel = Column(Float, nullable=True)` — velocity threshold for high BC (fps, e.g. 2800)
- `bc_g1_mid_vel = Column(Float, nullable=True)` — velocity threshold for mid BC (fps, e.g. 1800)

**Cartridge model** — Add 5 new nullable columns to `backend/app/models/cartridge.py`:
- `shoulder_angle_deg = Column(Float, nullable=True)` — shoulder angle in degrees
- `neck_length_mm = Column(Float, nullable=True)` — neck length in mm
- `body_length_mm = Column(Float, nullable=True)` — body length in mm
- `rim_thickness_mm = Column(Float, nullable=True)` — rim thickness in mm
- `case_type = Column(String(20), nullable=True)` — one of: rimless, belted, rimmed, rebated, semi_rimmed, straight_wall. Use String(20) NOT native ENUM.

**Bullet schemas** — Update `backend/app/schemas/bullet.py`:
- BulletCreate: Add 9 new optional fields with physical limit validation:
  - `bearing_surface_mm: float | None = Field(None, gt=0, le=50)`
  - `boat_tail_length_mm: float | None = Field(None, gt=0, le=20)`
  - `meplat_diameter_mm: float | None = Field(None, gt=0, le=15)`
  - `ogive_type: str | None = Field(None, max_length=20)` with description listing valid values
  - `bc_g1_high: float | None = Field(None, gt=0, le=2.0)`
  - `bc_g1_mid: float | None = Field(None, gt=0, le=2.0)`
  - `bc_g1_low: float | None = Field(None, gt=0, le=2.0)`
  - `bc_g1_high_vel: float | None = Field(None, gt=0, le=5000)` — fps
  - `bc_g1_mid_vel: float | None = Field(None, gt=0, le=5000)` — fps
- BulletUpdate: Add same 9 fields, all `float | None` or `str | None` with same validation
- BulletResponse: Add same 9 fields with `= None` defaults for backward compat

**Cartridge schemas** — Update `backend/app/schemas/cartridge.py`:
- CartridgeCreate: Add 5 new optional fields:
  - `shoulder_angle_deg: float | None = Field(None, gt=0, le=90)`
  - `neck_length_mm: float | None = Field(None, gt=0, le=50)`
  - `body_length_mm: float | None = Field(None, gt=0, le=100)`
  - `rim_thickness_mm: float | None = Field(None, gt=0, le=5)`
  - `case_type: str | None = Field(None, max_length=20)` with description listing valid values
- CartridgeUpdate: Add same 5 fields, all optional
- CartridgeResponse: Add same 5 fields with `= None` defaults for backward compat

**Quality scoring** — Update `backend/app/core/quality.py`:
- Add to BULLET_BONUS_FIELDS: `"bearing_surface_mm"`, `"boat_tail_length_mm"`, `"meplat_diameter_mm"`, `"ogive_type"`, `"bc_g1_high"`, `"bc_g1_mid"`, `"bc_g1_low"`, `"bc_g1_high_vel"`, `"bc_g1_mid_vel"`
- Add to CARTRIDGE_BONUS_FIELDS: `"shoulder_angle_deg"`, `"neck_length_mm"`, `"body_length_mm"`, `"rim_thickness_mm"`, `"case_type"`

**Alembic migration** — Create `backend/app/db/migrations/versions/009_schema_extensions.py`:
- `revision = "009_schema_extensions"`
- `down_revision = "008_fix_cartridge_caliber_backfill"`
- upgrade(): `op.add_column` for all 14 new columns (5 cartridge + 9 bullet), all `nullable=True`
- downgrade(): `op.drop_column` for all 14 columns in reverse order
- Follow exact pattern from research code example (see 11-RESEARCH.md "Alembic Migration for Schema Extensions")

**Frontend types** — Update `frontend/src/lib/types.ts`:
- Bullet interface: Add 9 new optional fields (`bearing_surface_mm: number | null`, etc.)
- BulletCreate interface: Add 9 new optional fields
- Cartridge interface: Add 5 new optional fields (`shoulder_angle_deg: number | null`, etc.)
- CartridgeCreate interface: Add 5 new optional fields
  </action>
  <verify>
    <automated>cd backend && python -m pytest tests/test_schema_validation.py -x --tb=short 2>&amp;1 | tail -5</automated>
  </verify>
  <done>
    - Bullet model has 9 new columns, Cartridge model has 5 new columns
    - Pydantic schemas accept and return all new fields
    - Quality BONUS_FIELDS lists include all new fields
    - Alembic migration 009 exists with upgrade/downgrade for all 14 columns
    - Frontend types.ts Bullet and Cartridge interfaces include all new fields
    - Existing tests still pass (no regression)
  </done>
</task>

<task type="auto">
  <name>Task 2: Backfill cartridges.json with new drawing fields</name>
  <files>
    backend/app/seed/fixtures/cartridges.json
  </files>
  <action>
Update `backend/app/seed/fixtures/cartridges.json` to add the 5 new fields to all 53 existing cartridge records. This is a locked user decision: "Backfill all 53 existing cartridges with estimated values for new fields from CIP/SAAMI reference data."

For each of the 53 cartridges, add:

1. **shoulder_angle_deg** — Use known SAAMI/CIP values where published:
   - Most standard bottleneck rifle cartridges: 20-25 degrees (e.g., .308 Win = 20, .223 Rem = 23, .30-06 = 17.5)
   - Short magnums: 30-35 degrees (e.g., .300 WSM = 35, 6.5 PRC = 30)
   - Belted magnums: 25 degrees typical
   - Straight-wall: `null` (no shoulder)

2. **neck_length_mm** — From SAAMI dimensional drawings:
   - General rule: approximately 1x caliber (bore diameter)
   - .308 Win = ~7.80mm, 6.5 CM = ~6.50mm, .223 Rem = ~4.80mm
   - Use known values from CIP/SAAMI specs

3. **body_length_mm** — From SAAMI: distance from head to shoulder junction
   - .308 Win = ~37.1mm, 6.5 CM = ~35.2mm, .223 Rem = ~30.4mm
   - Compute as: case_length - neck_length - shoulder_taper_height

4. **rim_thickness_mm** — From SAAMI/CIP specs:
   - Most rimless: ~1.27mm (.050")
   - Belted magnums: ~1.32mm (.052")
   - Rimmed: ~1.6-1.7mm

5. **case_type** — Classification:
   - `"rimless"` for most modern rifle cartridges (.308, .223, 6.5 CM, etc.)
   - `"belted"` for magnum cartridges (.300 Win Mag, 7mm Rem Mag, .338 Lapua)
   - `"rimmed"` for revolver/lever (.45-70, .30-30)
   - `"rebated"` for .300 RUM, etc.
   - `"semi_rimmed"` for .220 Swift, etc.
   - `"straight_wall"` for pistol cartridges if any

**Estimation rules for cartridges without known specs:**
- shoulder_angle_deg: 25.0 for standard bottleneck, 30.0 for short-action magnums, null for straight wall
- neck_length_mm: bore_diameter_mm (1x caliber rule of thumb)
- body_length_mm: case_length_mm - neck_length_mm - 6.0 (average shoulder region)
- rim_thickness_mm: 1.27 for rimless, 1.32 for belted
- case_type: infer from rim_diameter_mm vs base_diameter_mm relationship

Use `"data_source": "saami"` or `"estimated"` field on cartridge records to indicate provenance. Keep existing data_source values unchanged.

The JSON structure stays the same (array of objects), just add the 5 new key-value pairs to each record.
  </action>
  <verify>
    <automated>cd backend && python -c "import json; data=json.load(open('app/seed/fixtures/cartridges.json')); assert len(data)==53; assert all('case_type' in c for c in data); assert all('shoulder_angle_deg' in c for c in data); print(f'OK: {len(data)} cartridges, all have new fields')"</automated>
  </verify>
  <done>
    - All 53 cartridges in cartridges.json have shoulder_angle_deg, neck_length_mm, body_length_mm, rim_thickness_mm, and case_type fields
    - Values are realistic (shoulder angles 17-35 deg, neck lengths 4-10mm, etc.)
    - case_type distribution is correct (majority rimless, some belted, some rimmed)
    - Straight-wall cartridges have shoulder_angle_deg = null
  </done>
</task>

</tasks>

<verification>
1. `cd backend && python -m pytest tests/ -v --tb=short` — All existing 200 tests pass, no regression
2. `cd backend && python -c "from app.models.bullet import Bullet; print([c.name for c in Bullet.__table__.columns])"` — Shows all 24 columns including 9 new
3. `cd backend && python -c "from app.models.cartridge import Cartridge; print([c.name for c in Cartridge.__table__.columns])"` — Shows all 21 columns including 5 new
4. `cd backend && python -c "from app.schemas.bullet import BulletCreate; b=BulletCreate(name='Test',manufacturer='Test',weight_grains=168,diameter_mm=7.82,bc_g1=0.5,sectional_density=0.253,bearing_surface_mm=18.0,ogive_type='tangent'); print(b.model_dump())"` — New fields accepted
5. `cd backend && python -c "import json; d=json.load(open('app/seed/fixtures/cartridges.json')); print(f'{len(d)} cartridges, {sum(1 for c in d if c.get(\"case_type\"))} have case_type')"` — 53 cartridges, all with case_type
</verification>

<success_criteria>
- Alembic migration 009 exists and defines 14 new nullable columns
- Bullet model, schema, and frontend type include 9 new fields
- Cartridge model, schema, and frontend type include 5 new fields
- Quality BONUS_FIELDS updated for both bullet and cartridge
- cartridges.json has 5 new fields on all 53 records
- All existing tests pass without modification
</success_criteria>

<output>
After completion, create `.planning/phases/11-foundation-and-data-expansion/11-01-SUMMARY.md`
</output>
