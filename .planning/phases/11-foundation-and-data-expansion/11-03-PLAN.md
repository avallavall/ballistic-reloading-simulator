---
phase: 11-foundation-and-data-expansion
plan: 03
type: execute
wave: 2
depends_on:
  - 11-01
files_modified:
  - backend/app/seed/fixtures/bullets/sierra.json
  - backend/app/seed/fixtures/bullets/hornady.json
  - backend/app/seed/fixtures/bullets/berger.json
  - backend/app/seed/fixtures/bullets/nosler.json
  - backend/app/seed/fixtures/bullets/lapua.json
  - backend/app/seed/fixtures/bullets/barnes.json
  - backend/app/seed/fixtures/bullets/speer.json
  - backend/app/seed/initial_data.py
  - backend/tests/test_seed_data.py
  - backend/tests/test_schema_validation.py
  - backend/tests/test_api_integration.py
autonomous: true
requirements:
  - DATA-01

must_haves:
  truths:
    - "User can browse 500+ bullets in the bullet list page"
    - "Bullets cover all 7 manufacturers: Sierra, Hornady, Berger, Nosler, Lapua, Barnes, Speer"
    - "Sierra bullets have velocity-banded BCs (bc_g1_high, bc_g1_mid, bc_g1_low with velocity thresholds)"
    - "Seed loader reads from per-manufacturer JSON files instead of single bullets.json"
    - "Seed loader only replaces bullets when count suggests old seed data (<=127), preserving user data"
    - "Quality scores are computed for all seeded bullets"
    - "Match bullets are prioritized (Sierra MatchKing, Berger Hybrid/Target, Hornady ELD-M, Lapua Scenar)"
    - "Popular discontinued bullets are included (Sierra 168gr HPBT #2200, etc.)"
  artifacts:
    - path: "backend/app/seed/fixtures/bullets/sierra.json"
      provides: "Sierra bullet data with velocity-banded BCs"
      min_lines: 50
    - path: "backend/app/seed/fixtures/bullets/hornady.json"
      provides: "Hornady bullet data"
      min_lines: 50
    - path: "backend/app/seed/fixtures/bullets/berger.json"
      provides: "Berger bullet data with detailed dimensions"
      min_lines: 50
    - path: "backend/app/seed/fixtures/bullets/nosler.json"
      provides: "Nosler bullet data"
      min_lines: 30
    - path: "backend/app/seed/fixtures/bullets/lapua.json"
      provides: "Lapua bullet data"
      min_lines: 30
    - path: "backend/app/seed/fixtures/bullets/barnes.json"
      provides: "Barnes bullet data (solid copper)"
      min_lines: 30
    - path: "backend/app/seed/fixtures/bullets/speer.json"
      provides: "Speer bullet data"
      min_lines: 30
    - path: "backend/app/seed/initial_data.py"
      provides: "Updated seed loader with manufacturer-file-based bullet loading"
      contains: "BULLET_MANUFACTURERS"
    - path: "backend/tests/test_seed_data.py"
      provides: "Tests for bullet count, manufacturer coverage, quality scores"
    - path: "backend/tests/test_schema_validation.py"
      provides: "New tests for SCHM-01 and SCHM-02 field validation"
    - path: "backend/tests/test_api_integration.py"
      provides: "New tests for schema extension CRUD"
  key_links:
    - from: "backend/app/seed/initial_data.py"
      to: "backend/app/seed/fixtures/bullets/*.json"
      via: "_load_fixture(f'bullets/{mfg}.json') for each manufacturer"
      pattern: "BULLET_MANUFACTURERS"
    - from: "backend/app/seed/initial_data.py"
      to: "backend/app/core/quality.py"
      via: "compute_bullet_quality_score() called for each seeded bullet"
      pattern: "compute_bullet_quality_score"
    - from: "backend/app/seed/initial_data.py"
      to: "backend/app/models/bullet.py"
      via: "Bullet ORM model instantiation with new fields"
      pattern: "Bullet\\(\\*\\*"
---

<objective>
Create 500+ bullet seed data organized by manufacturer and update the seed loader to support per-manufacturer JSON files. Add tests for schema extensions and seed data integrity.

Purpose: This is the DATA-01 requirement — users need 500+ bullets to choose from immediately without manual data entry. The expanded database covers 7 major manufacturers, prioritizing match bullets per user decision, and includes popular discontinued bullets that reloaders still use.

Output: 7 manufacturer JSON files totaling 500+ bullets, updated seed loader, 15+ new tests
</objective>

<execution_context>
@C:/Users/vall-/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/vall-/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-foundation-and-data-expansion/11-RESEARCH.md
@.planning/phases/11-foundation-and-data-expansion/11-01-SUMMARY.md

<interfaces>
<!-- Interfaces from Plan 11-01 that this plan depends on -->

From backend/app/models/bullet.py (after 11-01):
```python
class Bullet(UUIDMixin, Base):
    __tablename__ = "bullets"
    # Existing fields
    name = Column(String(100), nullable=False, unique=True)
    manufacturer = Column(String(100), nullable=False)
    weight_grains = Column(Float, nullable=False)
    diameter_mm = Column(Float, nullable=False)
    length_mm = Column(Float, nullable=True)
    bc_g1 = Column(Float, nullable=False)
    bc_g7 = Column(Float, nullable=True)
    sectional_density = Column(Float, nullable=False)
    material = Column(String(50), nullable=False, default="copper")
    model_number = Column(String(50), nullable=True)
    bullet_type = Column(String(30), nullable=True)
    base_type = Column(String(50), nullable=True)
    data_source = Column(String(20), nullable=False, default="manual")
    quality_score = Column(Integer, nullable=False, default=0)
    caliber_family = Column(String(20), nullable=True)
    # NEW in 11-01: Rendering fields
    bearing_surface_mm = Column(Float, nullable=True)
    boat_tail_length_mm = Column(Float, nullable=True)
    meplat_diameter_mm = Column(Float, nullable=True)
    ogive_type = Column(String(20), nullable=True)
    # NEW in 11-01: Velocity-banded BC fields
    bc_g1_high = Column(Float, nullable=True)
    bc_g1_mid = Column(Float, nullable=True)
    bc_g1_low = Column(Float, nullable=True)
    bc_g1_high_vel = Column(Float, nullable=True)
    bc_g1_mid_vel = Column(Float, nullable=True)
```

From backend/app/seed/initial_data.py (current seed loader pattern):
```python
FIXTURES_DIR = Path(__file__).parent / "fixtures"

def _load_fixture(filename: str) -> list | dict:
    filepath = FIXTURES_DIR / filename
    if filepath.exists():
        with open(filepath, encoding="utf-8") as f:
            return json.load(f)
    return []

async def seed_initial_data(db: AsyncSession):
    existing = await db.execute(select(Powder).limit(1))
    if existing.scalar():
        return
    # ... loads powders.json, bullets.json, cartridges.json
```

Bullet JSON format (from 11-RESEARCH.md):
```json
{
  "name": "Sierra 175gr HPBT MK .308",
  "manufacturer": "Sierra",
  "model_number": "2275",
  "weight_grains": 175,
  "diameter_mm": 7.82,
  "length_mm": 32.3,
  "bc_g1": 0.505,
  "bc_g7": 0.264,
  "bc_g1_high": 0.505,
  "bc_g1_mid": 0.496,
  "bc_g1_low": 0.485,
  "bc_g1_high_vel": 2800,
  "bc_g1_mid_vel": 1800,
  "sectional_density": 0.264,
  "material": "copper",
  "bullet_type": "match",
  "base_type": "hollow_point_boat_tail",
  "bearing_surface_mm": 18.5,
  "boat_tail_length_mm": 5.0,
  "meplat_diameter_mm": 1.8,
  "ogive_type": "tangent",
  "data_source": "manufacturer"
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create 500+ bullet seed data across 7 manufacturer JSON files</name>
  <files>
    backend/app/seed/fixtures/bullets/sierra.json
    backend/app/seed/fixtures/bullets/hornady.json
    backend/app/seed/fixtures/bullets/berger.json
    backend/app/seed/fixtures/bullets/nosler.json
    backend/app/seed/fixtures/bullets/lapua.json
    backend/app/seed/fixtures/bullets/barnes.json
    backend/app/seed/fixtures/bullets/speer.json
  </files>
  <action>
Create the `backend/app/seed/fixtures/bullets/` directory and populate 7 JSON files. Each file is a JSON array of bullet objects.

**LOCKED DECISIONS to follow:**
- Prioritize match bullets first: Sierra MatchKing, Berger Hybrid/Target, Hornady ELD-M, Lapua Scenar
- Then expand to broader coverage (hunting, varmint) from Barnes, Speer, Nosler
- Leave bc_g7 null when manufacturer doesn't publish it — do NOT estimate from G1
- Store all 3 velocity-banded G1 BCs for Sierra bullets (bc_g1_high, bc_g1_mid, bc_g1_low)
- Store velocity threshold values alongside BCs (bc_g1_high_vel, bc_g1_mid_vel)
- Estimate bullet length_mm from weight + caliber when not published, mark with data_source = "estimated" (or keep "manufacturer" and note in a comment)
- Include popular discontinued bullets (Sierra 168gr HPBT #2200, etc.)

**Target counts by manufacturer:**
- **Sierra** (~100 bullets): MatchKing line (.224, .243, .264, .277, .284, .308, .338), GameKing, Pro-Hunter. Include 3 velocity-banded BCs for all Sierra bullets. Include discontinued #2200 (168gr .308 HPBT MK).
- **Hornady** (~100 bullets): ELD-M, ELD-X, V-MAX, InterLock, SST, A-TIP, GMX across common calibers.
- **Berger** (~90 bullets): Hybrid Target, Hybrid Hunting, VLD Target, VLD Hunting, Long Range Hybrid Target, Classic Hunter. Berger has the most detailed dimension data (bearing_surface_mm, boat_tail_length_mm from Quick Reference Sheets).
- **Nosler** (~70 bullets): Custom Competition, RDF, AccuBond, Partition, Ballistic Tip, E-Tip.
- **Lapua** (~50 bullets): Scenar, Scenar-L, Lock Base, Mega, FMJ, Naturalis.
- **Barnes** (~50 bullets): TTSX, LRX, TSX, Varmint Grenade. NOTE: Barnes bullets are solid copper (monolithic), set material="solid_copper".
- **Speer** (~50 bullets): Gold Dot, TMJ, Hot-Cor, Grand Slam, TNT.

**Total target: 500+ bullets across all 7 files.**

**Required fields per bullet:**
- `name` (str, unique): "{Manufacturer} {weight}gr {type} .{caliber}" — e.g., "Sierra 175gr HPBT MK .308"
- `manufacturer` (str): Manufacturer name
- `model_number` (str|null): Manufacturer SKU/part number
- `weight_grains` (float): Bullet weight
- `diameter_mm` (float): Bullet diameter — use standard values: .224=5.69, .243=6.17, .257=6.53, .264=6.72, .277=7.04, .284=7.21, .308=7.82, .311=7.90, .323=8.20, .338=8.59, .358=9.09, .375=9.53, .416=10.57, .458=11.63, .510=12.95
- `length_mm` (float|null): Bullet overall length. Use manufacturer data when available, estimate when not.
- `bc_g1` (float): Primary G1 BC. For Sierra, use the high-velocity BC as the primary.
- `bc_g7` (float|null): G7 BC if published by manufacturer. null if not published (DO NOT estimate from G1).
- `bc_g1_high` (float|null): Sierra only — high velocity BC
- `bc_g1_mid` (float|null): Sierra only — mid velocity BC
- `bc_g1_low` (float|null): Sierra only — low velocity BC
- `bc_g1_high_vel` (float|null): Sierra only — velocity threshold for high BC (fps)
- `bc_g1_mid_vel` (float|null): Sierra only — velocity threshold for mid BC (fps)
- `sectional_density` (float): SD = weight_grains / (7000 * diameter_inches^2). Compute accurately.
- `material` (str): "copper" for standard jacketed, "solid_copper" for Barnes monolithics, "lead" for cast
- `bullet_type` (str): "match", "hunting", "target", "varmint", "plinking", "tactical"
- `base_type` (str): "hollow_point_boat_tail", "polymer_tip_boat_tail", "polymer_tip_flat_base", "flat_base", "hollow_point_flat_base", "monolithic_boat_tail", etc.
- `bearing_surface_mm` (float|null): From manufacturer data if available, null otherwise
- `boat_tail_length_mm` (float|null): From manufacturer data if available, null otherwise
- `meplat_diameter_mm` (float|null): From manufacturer data if available, null otherwise
- `ogive_type` (str|null): "tangent" for most match, "secant" for VLD, "hybrid" for Berger Hybrid, "flat_nose" for wadcutters, "round_nose" for round nose, "spitzer" for standard
- `data_source` (str): "manufacturer" if all critical data from manufacturer specs, "estimated" if any critical values estimated

**Data accuracy notes:**
- Use real published BC values from manufacturer websites and load manuals
- Use real published weights and diameters
- Sectional density must be accurately computed: SD = (weight_grains / 7000) / (diameter_inches)^2
- For Sierra, use their actual velocity band ranges per bullet (they vary per bullet model)
- Non-Sierra manufacturers: bc_g1_high/mid/low fields should be null
- For Berger, include bearing_surface_mm and boat_tail_length_mm when available from Quick Reference data
- For Barnes, all bullets should have material="solid_copper" and ogive_type="spitzer" or "tangent"

**File format:** Each file is a JSON array: `[{bullet1}, {bullet2}, ...]`
  </action>
  <verify>
    <automated>cd backend && python -c "
import json, os
total=0
mfgs=['sierra','hornady','berger','nosler','lapua','barnes','speer']
for m in mfgs:
    path=f'app/seed/fixtures/bullets/{m}.json'
    assert os.path.exists(path), f'Missing {path}'
    data=json.load(open(path))
    total+=len(data)
    print(f'{m}: {len(data)} bullets')
    # Validate all have required fields
    for b in data:
        assert 'name' in b and 'manufacturer' in b and 'weight_grains' in b and 'diameter_mm' in b and 'bc_g1' in b
        assert 'sectional_density' in b and 'material' in b
        if m=='sierra':
            assert 'bc_g1_high' in b, f'Sierra {b[\"name\"]} missing bc_g1_high'
        if m=='barnes':
            assert b['material']=='solid_copper', f'Barnes {b[\"name\"]} should be solid_copper'
assert total>=500, f'Only {total} bullets, need 500+'
print(f'TOTAL: {total} bullets across {len(mfgs)} manufacturers')
"</automated>
  </verify>
  <done>
    - 7 manufacturer JSON files created in backend/app/seed/fixtures/bullets/
    - Total bullet count is 500+
    - Sierra bullets have bc_g1_high, bc_g1_mid, bc_g1_low with velocity thresholds
    - Barnes bullets have material="solid_copper"
    - All bullets have required fields (name, manufacturer, weight_grains, diameter_mm, bc_g1, sectional_density, material)
    - Match bullets prioritized across all manufacturers
    - Popular discontinued bullets included
    - BC G7 is null when manufacturer doesn't publish it
    - Names are unique across all 7 files
  </done>
</task>

<task type="auto">
  <name>Task 2: Update seed loader + add tests for schema extensions and seed data</name>
  <files>
    backend/app/seed/initial_data.py
    backend/tests/test_seed_data.py
    backend/tests/test_schema_validation.py
    backend/tests/test_api_integration.py
  </files>
  <action>
**Update seed loader** — `backend/app/seed/initial_data.py`:

1. Add manufacturer-based bullet loading:
```python
BULLET_MANUFACTURERS = [
    "sierra", "hornady", "berger", "nosler", "lapua", "barnes", "speer"
]
```

2. Modify `seed_initial_data()` to use a smarter seeding strategy:
   - Keep the existing check: if powders exist, skip powder seeding
   - For bullets specifically: check bullet count. If count <= 127 (old seed), delete all existing bullets and reseed from manufacturer files. If count > 400, assume new seed loaded, skip. If between 128-400, user has added custom bullets, skip to preserve their data. Log the decision.
   - Cartridge seeding: Always seed if cartridges table is empty (same as before but with updated JSON fields)

3. Bullet loading loop:
```python
async def _seed_bullets(db: AsyncSession):
    """Load bullets from per-manufacturer fixture files."""
    result = await db.execute(select(func.count()).select_from(Bullet))
    bullet_count = result.scalar() or 0

    if bullet_count > 400:
        logger.info("Bullet database already expanded (%d bullets), skipping seed", bullet_count)
        return 0
    if 128 <= bullet_count <= 400:
        logger.info("Custom bullet data detected (%d bullets), preserving user data", bullet_count)
        return 0

    # Delete old seed data and replace
    if bullet_count > 0:
        await db.execute(delete(Bullet))
        logger.info("Replacing old bullet seed (%d bullets) with expanded data", bullet_count)

    all_bullets = []
    for mfg in BULLET_MANUFACTURERS:
        mfg_data = _load_fixture(f"bullets/{mfg}.json")
        all_bullets.extend(mfg_data)

    bullet_objects = []
    for data in all_bullets:
        bullet = Bullet(**{k: v for k, v in data.items() if hasattr(Bullet, k) and k != "id"})
        if not bullet.data_source:
            bullet.data_source = "manufacturer"
        bullet.caliber_family = derive_caliber_family(bullet.diameter_mm)
        bullet_dict = {k: v for k, v in data.items()}
        breakdown = compute_bullet_quality_score(bullet_dict, bullet.data_source)
        bullet.quality_score = breakdown.score
        bullet_objects.append(bullet)

    db.add_all(bullet_objects)
    logger.info("Seeded %d bullets from %d manufacturer files", len(bullet_objects), len(BULLET_MANUFACTURERS))
    return len(bullet_objects)
```

4. Update main `seed_initial_data` function to call `_seed_bullets(db)` separately from the existing powder/cartridge flow. Import `func` from sqlalchemy and `delete` from sqlalchemy for the count query and delete operation.

5. Keep the existing `bullets.json` file for backward compatibility but the loader should prioritize manufacturer files. If the manufacturer files directory exists and has files, use those. Otherwise fall back to `bullets.json`.

**Create test file** — `backend/tests/test_seed_data.py`:

New test file with:
- `test_all_manufacturer_files_exist()` — Verify 7 JSON files exist in fixtures/bullets/
- `test_total_bullet_count()` — Load all JSONs, assert total >= 500
- `test_manufacturer_coverage()` — Assert all 7 manufacturers represented
- `test_sierra_velocity_banded_bcs()` — Every Sierra bullet has bc_g1_high, bc_g1_mid, bc_g1_low, bc_g1_high_vel, bc_g1_mid_vel (all non-null)
- `test_barnes_solid_copper()` — All Barnes bullets have material="solid_copper"
- `test_unique_bullet_names()` — No duplicate names across all 7 files
- `test_sectional_density_accuracy()` — For a sample of 10 bullets, verify SD = weight/(7000 * dia_inches^2) within 1%
- `test_quality_scores_computed()` — Run compute_bullet_quality_score on each bullet dict, verify score > 0
- `test_required_fields_present()` — All bullets have name, manufacturer, weight_grains, diameter_mm, bc_g1, sectional_density, material

**Add schema extension tests** — append to `backend/tests/test_schema_validation.py`:

- `test_bullet_schema_new_rendering_fields()` — BulletCreate accepts bearing_surface_mm, boat_tail_length_mm, meplat_diameter_mm, ogive_type
- `test_bullet_schema_new_bc_fields()` — BulletCreate accepts bc_g1_high, bc_g1_mid, bc_g1_low, bc_g1_high_vel, bc_g1_mid_vel
- `test_bullet_schema_rejects_invalid_bc()` — bc_g1_high=3.0 (>2.0 limit) raises ValidationError
- `test_bullet_schema_rejects_invalid_ogive()` — ogive_type with >20 chars raises ValidationError
- `test_cartridge_schema_new_drawing_fields()` — CartridgeCreate accepts shoulder_angle_deg, neck_length_mm, body_length_mm, rim_thickness_mm, case_type
- `test_cartridge_schema_rejects_invalid_angle()` — shoulder_angle_deg=100 (>90 limit) raises ValidationError

**Add API integration tests** — append to `backend/tests/test_api_integration.py`:

- `test_bullet_create_with_new_fields()` — POST /bullets with bearing_surface_mm, ogive_type returns 201 with fields saved
- `test_bullet_update_new_fields()` — PUT /bullets/{id} with bc_g1_high, bc_g1_mid returns 200 with updated fields
- `test_cartridge_create_with_drawing_fields()` — POST /cartridges with shoulder_angle_deg, case_type returns 201
- `test_cartridge_update_drawing_fields()` — PUT /cartridges/{id} with neck_length_mm, body_length_mm returns 200
  </action>
  <verify>
    <automated>cd backend && python -m pytest tests/test_seed_data.py tests/test_schema_validation.py tests/test_api_integration.py -v --tb=short 2>&amp;1 | tail -30</automated>
  </verify>
  <done>
    - Seed loader loads bullets from 7 manufacturer JSON files
    - Seed loader uses count-based threshold: <=127 replace, 128-400 skip (preserve user data), >400 skip (already expanded)
    - test_seed_data.py has 9+ tests, all passing
    - test_schema_validation.py has 6+ new tests for SCHM-01/SCHM-02 fields, all passing
    - test_api_integration.py has 4+ new tests for schema extension CRUD, all passing
    - Full test suite passes: `python -m pytest tests/ -v` shows 215+ tests, 0 failures
  </done>
</task>

</tasks>

<verification>
1. `cd backend && python -m pytest tests/ -v --tb=short` — All 215+ tests pass, 0 failures
2. `cd backend && python -c "import json,os; total=sum(len(json.load(open(f'app/seed/fixtures/bullets/{m}.json'))) for m in ['sierra','hornady','berger','nosler','lapua','barnes','speer']); assert total>=500; print(f'Total: {total} bullets')"` — 500+ bullets
3. `cd backend && python -c "from app.seed.initial_data import BULLET_MANUFACTURERS; print(BULLET_MANUFACTURERS)"` — Shows 7 manufacturers
4. `cd backend && python -m pytest tests/test_seed_data.py -v` — All seed data tests pass
5. `cd backend && python -m pytest tests/test_schema_validation.py -k 'new_' -v` — All new schema validation tests pass
</verification>

<success_criteria>
- 7 manufacturer JSON files exist in backend/app/seed/fixtures/bullets/
- Total bullet count across all files is 500+
- Sierra bullets have complete velocity-banded BC data
- Barnes bullets correctly marked as solid_copper
- All bullet names are unique across the entire dataset
- Seed loader uses manufacturer-based loading with count-based threshold protection
- 15+ new tests covering seed data, schema extensions, and API integration
- Full test suite passes with 0 failures
</success_criteria>

<output>
After completion, create `.planning/phases/11-foundation-and-data-expansion/11-03-SUMMARY.md`
</output>
