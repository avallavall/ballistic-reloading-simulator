---
phase: 11-foundation-and-data-expansion
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/package.json
  - frontend/src/lib/geometry/types.ts
  - frontend/src/lib/geometry/estimation.ts
  - frontend/src/lib/geometry/cartridge-geometry.ts
  - frontend/src/lib/geometry/bullet-geometry.ts
autonomous: true
requirements:
  - SCHM-03

must_haves:
  truths:
    - "Geometry engine produces valid SVG path data from cartridge dimensions"
    - "Geometry engine produces ProfilePoint arrays usable by Three.js LatheGeometry"
    - "Geometry engine gracefully handles null optional fields with documented heuristic fallbacks"
    - "Geometry engine reports dataCompleteness as 'full', 'basic', or 'insufficient' based on which fields were estimated"
    - "Geometry engine reports which specific fields were estimated in estimatedFields array"
    - "Bullet geometry produces type-aware ogive profiles (tangent, secant, hybrid, flat_nose, round_nose, spitzer)"
    - "React Three Fiber v8, drei v9, Three.js are installed in package.json"
  artifacts:
    - path: "frontend/src/lib/geometry/types.ts"
      provides: "ProfilePoint, GeometryResult, CartridgeDimensions, BulletDimensions interfaces"
      exports: ["ProfilePoint", "GeometryResult", "CartridgeDimensions", "BulletDimensions"]
    - path: "frontend/src/lib/geometry/estimation.ts"
      provides: "Heuristic estimation functions for missing dimensions"
      exports: ["estimateShoulderAngle", "estimateNeckLength", "estimateBodyLength", "estimateRimThickness", "estimateBulletLength", "estimateBearingSurface", "estimateBoatTailLength"]
    - path: "frontend/src/lib/geometry/cartridge-geometry.ts"
      provides: "generateCartridgeProfile function returning GeometryResult"
      exports: ["generateCartridgeProfile"]
    - path: "frontend/src/lib/geometry/bullet-geometry.ts"
      provides: "generateBulletProfile function returning GeometryResult"
      exports: ["generateBulletProfile"]
    - path: "frontend/package.json"
      provides: "three, @react-three/fiber, @react-three/drei, @types/three dependencies"
  key_links:
    - from: "frontend/src/lib/geometry/cartridge-geometry.ts"
      to: "frontend/src/lib/geometry/types.ts"
      via: "import { CartridgeDimensions, GeometryResult, ProfilePoint }"
      pattern: "import.*types"
    - from: "frontend/src/lib/geometry/cartridge-geometry.ts"
      to: "frontend/src/lib/geometry/estimation.ts"
      via: "import estimation functions for null field fallbacks"
      pattern: "import.*estimation"
    - from: "frontend/src/lib/geometry/bullet-geometry.ts"
      to: "frontend/src/lib/geometry/types.ts"
      via: "import { BulletDimensions, GeometryResult, ProfilePoint }"
      pattern: "import.*types"
---

<objective>
Create the shared geometry engine library and install React Three Fiber npm dependencies. The geometry engine is a pure TypeScript module that generates both SVG path data and Three.js-compatible Vector2 profile point arrays from cartridge/bullet database dimensions.

Purpose: This is the single shared geometry engine that both Phase 12 (2D SVG drawings) and Phase 13 (3D viewer) consume. Building one authoritative geometry source guarantees 2D and 3D representations match exactly — a locked user decision. Installing R3F/Three.js now makes the Vector2 type available for type-safe geometry work.

Output: 4 TypeScript files in frontend/src/lib/geometry/, updated package.json with 3D dependencies
</objective>

<execution_context>
@C:/Users/vall-/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/vall-/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-foundation-and-data-expansion/11-RESEARCH.md

<interfaces>
<!-- Key types from research that the geometry engine must implement -->

From 11-RESEARCH.md (Pattern 3: Geometry Engine Dual Output):
```typescript
export interface ProfilePoint {
  x: number;  // mm, axial position
  y: number;  // mm, radial position (half-diameter)
}

export interface GeometryResult {
  svgPath: string;           // SVG 'd' attribute string (M/L/C/A/Z commands)
  profilePoints: ProfilePoint[];  // Ordered points for Three.js LatheGeometry
  estimatedFields: string[]; // Which fields were estimated (for transparency rendering)
  dataCompleteness: 'full' | 'basic' | 'insufficient';
}
```

From frontend/src/lib/types.ts (Cartridge interface — current fields):
```typescript
export interface Cartridge {
  case_length_mm: number;
  bore_diameter_mm: number;
  groove_diameter_mm: number;
  shoulder_diameter_mm: number | null;
  neck_diameter_mm: number | null;
  base_diameter_mm: number | null;
  rim_diameter_mm: number | null;
  // ... plus the 5 new fields from Plan 11-01 (shoulder_angle_deg, neck_length_mm, body_length_mm, rim_thickness_mm, case_type)
}
```

From frontend/src/lib/types.ts (Bullet interface — current fields):
```typescript
export interface Bullet {
  weight_grains: number;
  diameter_mm: number;
  length_mm: number | null;
  material: string;
  bullet_type: string | null;
  base_type: string | null;
  // ... plus the 4 new fields from Plan 11-01 (bearing_surface_mm, boat_tail_length_mm, meplat_diameter_mm, ogive_type)
}
```

npm versions to install (from research):
- three@^0.170.0 (pinned for R3F v8 stability)
- @react-three/fiber@^8.18.0 (React 18 compatible)
- @react-three/drei@^9.122.0 (v9 for R3F v8)
- @types/three@^0.170.0 (TypeScript types matching three version)
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install npm dependencies and create geometry type definitions</name>
  <files>
    frontend/package.json
    frontend/src/lib/geometry/types.ts
    frontend/src/lib/geometry/estimation.ts
  </files>
  <action>
**Install npm packages** — Run in the frontend directory:
```bash
cd frontend && npm install three@^0.170.0 @react-three/fiber@^8.18.0 @react-three/drei@^9.122.0 @types/three@^0.170.0
```

Verify no peer dependency warnings for React 18. If Three.js 0.170.x is not found, try `three@~0.169.0` — any 0.16x-0.17x version is fine for Vector2 stability.

**Create geometry types** — `frontend/src/lib/geometry/types.ts`:

```typescript
/**
 * Shared geometry types for 2D SVG and 3D viewer.
 * Pure data structures — no framework dependencies.
 */

export interface ProfilePoint {
  x: number;  // mm, axial position (0 = case head / bullet base)
  y: number;  // mm, radial position (half-diameter from centerline)
}

export interface GeometryResult {
  /** SVG path 'd' attribute string (M/L/C/Q/Z commands) */
  svgPath: string;
  /** Ordered profile points for Three.js LatheGeometry (Vector2 compatible) */
  profilePoints: ProfilePoint[];
  /** Field names that were estimated rather than from DB data */
  estimatedFields: string[];
  /** Data completeness tier for graceful degradation */
  dataCompleteness: 'full' | 'basic' | 'insufficient';
}

/** Cartridge dimension inputs for geometry generation */
export interface CartridgeDimensions {
  // Required core dimensions (insufficient without these)
  case_length_mm: number | null;
  base_diameter_mm: number | null;
  neck_diameter_mm: number | null;
  // Important optional dimensions
  bore_diameter_mm: number | null;
  groove_diameter_mm: number | null;
  rim_diameter_mm: number | null;
  shoulder_diameter_mm: number | null;
  // Drawing-precision fields (new in Phase 11)
  shoulder_angle_deg: number | null;
  neck_length_mm: number | null;
  body_length_mm: number | null;
  rim_thickness_mm: number | null;
  case_type: string | null;
}

/** Bullet dimension inputs for geometry generation */
export interface BulletDimensions {
  // Required core dimensions (insufficient without these)
  diameter_mm: number | null;
  length_mm: number | null;
  weight_grains: number | null;
  // Rendering fields (new in Phase 11)
  bearing_surface_mm: number | null;
  boat_tail_length_mm: number | null;
  meplat_diameter_mm: number | null;
  ogive_type: string | null;
  // Context for estimation
  material: string | null;
  bullet_type: string | null;
  base_type: string | null;
}
```

**Create estimation functions** — `frontend/src/lib/geometry/estimation.ts`:

Implement heuristic estimation functions. Each function takes the relevant dimension inputs and returns an estimated value. These are called ONLY when the database value is null.

Functions to implement (use the formulas from 11-RESEARCH.md "Bullet Length Estimation Formula" and "Cartridge Dimension Estimation Heuristics"):

1. `estimateShoulderAngle(dims: CartridgeDimensions): number | null` — Returns 25 for standard bottleneck, 30 for short-fat magnums (case_length < 50mm), null for straight-wall (shoulder_diameter - neck_diameter < 0.5mm)

2. `estimateNeckLength(dims: CartridgeDimensions): number | null` — Returns bore_diameter_mm (1x caliber rule), falls back to neck_diameter * 0.8

3. `estimateBodyLength(dims: CartridgeDimensions): number | null` — Returns case_length - neck_length - 6.0 (avg shoulder region), minimum 50% of case_length

4. `estimateRimThickness(dims: CartridgeDimensions): number | null` — Returns 1.3mm default (reasonable for rimless)

5. `estimateBulletLength(dims: BulletDimensions): number | null` — Uses cylindrical volume formula with shape correction factor 1.20. Density: 10.5 g/cm3 for copper jacket, 8.96 for solid_copper. Returns null if diameter_mm or weight_grains missing.

6. `estimateBearingSurface(dims: BulletDimensions): number | null` — Approximately 55% of total length for match bullets, 40% for hunting

7. `estimateBoatTailLength(dims: BulletDimensions): number | null` — Approximately 15% of total length for boat-tail bullets, 0 for flat-base

All estimation functions must be pure (no side effects, no imports from React/Three.js). Document each formula with a brief comment explaining the heuristic source.
  </action>
  <verify>
    <automated>cd frontend && npx tsc --noEmit src/lib/geometry/types.ts src/lib/geometry/estimation.ts 2>&amp;1 | tail -5</automated>
  </verify>
  <done>
    - package.json has three, @react-three/fiber, @react-three/drei, @types/three as dependencies
    - frontend/src/lib/geometry/types.ts exports ProfilePoint, GeometryResult, CartridgeDimensions, BulletDimensions
    - frontend/src/lib/geometry/estimation.ts exports 7 estimation functions
    - All TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement cartridge and bullet geometry profile generators</name>
  <files>
    frontend/src/lib/geometry/cartridge-geometry.ts
    frontend/src/lib/geometry/bullet-geometry.ts
  </files>
  <action>
**Cartridge geometry** — `frontend/src/lib/geometry/cartridge-geometry.ts`:

Implement `generateCartridgeProfile(dims: CartridgeDimensions): GeometryResult`.

Logic:
1. Check required fields: case_length_mm, base_diameter_mm, neck_diameter_mm. If any are null, return empty result with `dataCompleteness: 'insufficient'`.

2. For each optional field, use actual value if non-null, or call the estimation function and add field name to `estimatedFields` array.

3. Build profile points array (half cross-section, y = radius from centerline, x = 0 at case head):
   - Point 1: (0, rimR) — rim outer edge
   - Point 2: (rimThickness, rimR) — rim face
   - Point 3: (rimThickness, baseR) — extractor groove (simplified step)
   - Point 4: (rimThickness + bodyLength, baseR) — body end / shoulder start
   - Point 5: Shoulder taper to neck junction — use `shoulderEndX = rimThickness + bodyLength + (shoulderR - neckR) / tan(shoulderAngle * PI / 180)`. For straight-wall cartridges (no shoulder), skip the shoulder taper and go directly to neck.
   - Point 6: (caseLength, neckR) — case mouth
   - Mirror points for the bottom half (y negative) to create full cross-section SVG. For Three.js LatheGeometry, only the top half (positive y) is needed.

4. Convert points to SVG path using `pointsToSvgPath()` helper (M for first point, L for subsequent). Build a full closed cross-section SVG path: top profile + mirrored bottom profile + close.

5. Classify completeness: 0 estimated = 'full', 1-3 estimated = 'basic', 4+ = 'insufficient'.

6. Return GeometryResult with svgPath, profilePoints (top half only for LatheGeometry), estimatedFields, dataCompleteness.

**Bullet geometry** — `frontend/src/lib/geometry/bullet-geometry.ts`:

Implement `generateBulletProfile(dims: BulletDimensions): GeometryResult`.

Logic:
1. Check required: diameter_mm. If null, return insufficient. Use length_mm from DB or estimate from weight_grains.

2. Estimate missing rendering fields and track in estimatedFields.

3. Build profile points (half cross-section, x=0 at base):
   - Bullet base section:
     - If base_type contains "boat_tail" or "bt": Angled boat tail from base diameter to body diameter over boatTailLength
     - If flat base: straight line at body radius
   - Body/bearing surface section: straight cylinder at body radius for bearingSurfaceLength
   - Ogive section: Varies by ogive_type (locked decision: type-aware ogive profiles):
     - `tangent`: Single quadratic bezier curve from body radius down to meplat radius. The curve is a tangent ogive (smooth transition from body).
     - `secant`: Steeper curve (smaller radius arc). Use a quadratic bezier with a control point closer to the nose.
     - `hybrid`: Combination — tangent at body junction transitioning to secant toward nose. Use a cubic bezier.
     - `flat_nose`: Straight line from body radius to flat face (wadcutter-style)
     - `round_nose`: Semi-circular arc from body to tip
     - `spitzer` (default): Similar to tangent, standard spitzer ogive
   - Tip: End at (totalLength, meplat radius). Meplat diameter is the flat tip — even "pointed" bullets have a tiny meplat.

4. Convert to SVG path. For ogive sections, use SVG Q (quadratic bezier) or C (cubic bezier) commands rather than linear segments — this is a locked decision from research ("Bezier curves match ogive shapes accurately; linear segments look faceted").

5. Classify completeness same as cartridge.

6. Return GeometryResult.

**CRITICAL: No framework dependencies.** These files must NOT import React, Three.js, or any npm packages. They are pure TypeScript producing data structures (ProfilePoint[], string). The Three.js Vector2 conversion happens in the consumer (Phase 13).

**CRITICAL: Estimated geometry visual signal.** The estimatedFields array enables consumers to render estimated dimensions differently (slightly transparent or dashed per locked decision). The geometry engine itself does not handle rendering — it just reports which fields were estimated.
  </action>
  <verify>
    <automated>cd frontend && npx tsc --noEmit src/lib/geometry/cartridge-geometry.ts src/lib/geometry/bullet-geometry.ts 2>&amp;1 | tail -5</automated>
  </verify>
  <done>
    - generateCartridgeProfile produces valid SVG path string and ProfilePoint[] for cartridge with all fields populated
    - generateCartridgeProfile returns 'insufficient' for cartridge missing case_length_mm
    - generateCartridgeProfile returns 'basic' with estimatedFields populated for cartridge with some null optional fields
    - generateBulletProfile produces valid SVG path with bezier curves for ogive section
    - generateBulletProfile handles 6 ogive types (tangent, secant, hybrid, flat_nose, round_nose, spitzer)
    - Neither file imports React or Three.js
    - TypeScript compiles clean
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` — Full TypeScript compilation passes with no errors
2. `cd frontend && node -e "const {generateCartridgeProfile}=require('./src/lib/geometry/cartridge-geometry'); console.log(typeof generateCartridgeProfile)"` — Verify module exports (may need ts-node or build step)
3. `cat frontend/package.json | grep three` — Shows three, @react-three/fiber, @react-three/drei, @types/three
4. Verify no React/Three.js imports: `grep -r "from 'react'" frontend/src/lib/geometry/` should return nothing
5. Verify no Three.js imports: `grep -r "from 'three'" frontend/src/lib/geometry/` should return nothing
</verification>

<success_criteria>
- Geometry engine files exist: types.ts, estimation.ts, cartridge-geometry.ts, bullet-geometry.ts
- generateCartridgeProfile accepts CartridgeDimensions, returns GeometryResult with svgPath and profilePoints
- generateBulletProfile accepts BulletDimensions, returns GeometryResult with type-aware ogive curves
- Both functions handle null fields gracefully with estimation fallbacks
- estimatedFields accurately reports which dimensions were estimated
- dataCompleteness correctly classifies full/basic/insufficient
- R3F v8, drei v9, Three.js 0.170.x installed in package.json
- Zero React/Three.js imports in geometry engine (pure TypeScript)
</success_criteria>

<output>
After completion, create `.planning/phases/11-foundation-and-data-expansion/11-02-SUMMARY.md`
</output>
