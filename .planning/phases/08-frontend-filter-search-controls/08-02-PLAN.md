---
phase: 08-frontend-filter-search-controls
plan: 02
type: execute
wave: 2
depends_on:
  - "08-01"
files_modified:
  - frontend/src/hooks/usePowders.ts
  - frontend/src/hooks/useBullets.ts
  - frontend/src/hooks/useCartridges.ts
  - frontend/src/app/powders/page.tsx
  - frontend/src/app/bullets/page.tsx
  - frontend/src/app/cartridges/page.tsx
autonomous: true
requirements:
  - SRC-03

must_haves:
  truths:
    - "Paginated hooks include all filter params in queryKey so TanStack Query caches correctly per filter combination"
    - "Powders list page has manufacturer and quality dropdowns populated from /manufacturers endpoint"
    - "Bullets list page has manufacturer, caliber family, and quality dropdowns populated from respective endpoints"
    - "Cartridges list page has caliber family and quality dropdowns (no manufacturer -- cartridges have no manufacturer column)"
    - "All three list pages have a search input that fuzzy-searches by name with 300ms debounce"
    - "Changing any filter or search resets pagination to page 1"
    - "Zero results with active filters shows 'No se encontraron resultados' with 'Limpiar filtros' button"
    - "Filters combine with search and pagination using AND logic (no interference)"
  artifacts:
    - path: "frontend/src/hooks/usePowders.ts"
      provides: "usePowdersPaginated with all ListParams in queryKey"
      contains: "manufacturer.*caliber_family.*quality_level"
    - path: "frontend/src/hooks/useBullets.ts"
      provides: "useBulletsPaginated with all ListParams in queryKey"
      contains: "manufacturer.*caliber_family.*quality_level"
    - path: "frontend/src/hooks/useCartridges.ts"
      provides: "useCartridgesPaginated with all ListParams in queryKey"
      contains: "caliber_family.*quality_level"
    - path: "frontend/src/app/powders/page.tsx"
      provides: "Powders list with FilterBar (manufacturer + quality + search)"
      contains: "FilterBar"
    - path: "frontend/src/app/bullets/page.tsx"
      provides: "Bullets list with FilterBar (manufacturer + caliber_family + quality + search)"
      contains: "FilterBar"
    - path: "frontend/src/app/cartridges/page.tsx"
      provides: "Cartridges list with FilterBar (caliber_family + quality + search)"
      contains: "FilterBar"
  key_links:
    - from: "frontend/src/app/powders/page.tsx"
      to: "frontend/src/components/filters/FilterBar.tsx"
      via: "import and render FilterBar with manufacturer + quality props"
      pattern: "FilterBar"
    - from: "frontend/src/hooks/usePowders.ts"
      to: "frontend/src/lib/api.ts"
      via: "passes full ListParams (including filter fields) to getPowders"
      pattern: "manufacturer.*quality_level"
    - from: "frontend/src/app/powders/page.tsx"
      to: "frontend/src/hooks/useFilterOptions.ts"
      via: "useManufacturers('powders') populates dropdown options"
      pattern: "useManufacturers"
---

<objective>
Wire FilterBar into all three component list pages with filter state management, page reset on filter change, and zero-results empty state.

Purpose: Complete SRC-03 by connecting the FilterBar component (from Plan 01) to the powders, bullets, and cartridges list pages with proper state management and query integration.
Output: All three list pages support manufacturer, caliber family, and quality level filtering combined with search and pagination.
</objective>

<execution_context>
@C:/Users/vall-/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/vall-/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-frontend-filter-search-controls/08-RESEARCH.md
@.planning/phases/08-frontend-filter-search-controls/08-01-SUMMARY.md

@frontend/src/hooks/usePowders.ts
@frontend/src/hooks/useBullets.ts
@frontend/src/hooks/useCartridges.ts
@frontend/src/app/powders/page.tsx
@frontend/src/app/bullets/page.tsx
@frontend/src/app/cartridges/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update paginated hooks to pass all filter params</name>
  <files>frontend/src/hooks/usePowders.ts, frontend/src/hooks/useBullets.ts, frontend/src/hooks/useCartridges.ts</files>
  <action>
Update each `use*Paginated` hook to destructure ALL `ListParams` fields and include them in the `queryKey` and `queryFn` call. This ensures TanStack Query caches/refetches correctly when any filter changes.

**usePowders.ts -- update `usePowdersPaginated`:**
```typescript
export function usePowdersPaginated(params: ListParams = {}) {
  const { page = 1, size = 20, q, manufacturer, caliber_family, quality_level, sort, order } = params;
  return useQuery({
    queryKey: ['powders', 'list', { page, size, q, manufacturer, caliber_family, quality_level, sort, order }],
    queryFn: () => getPowders({ page, size, q, manufacturer, caliber_family, quality_level, sort, order }),
    placeholderData: keepPreviousData,
  });
}
```

**useBullets.ts -- update `useBulletsPaginated`:**
```typescript
export function useBulletsPaginated(params: ListParams = {}) {
  const { page = 1, size = 20, q, manufacturer, caliber_family, quality_level, sort, order } = params;
  return useQuery({
    queryKey: ['bullets', 'list', { page, size, q, manufacturer, caliber_family, quality_level, sort, order }],
    queryFn: () => getBullets({ page, size, q, manufacturer, caliber_family, quality_level, sort, order }),
    placeholderData: keepPreviousData,
  });
}
```

**useCartridges.ts -- update `useCartridgesPaginated`:**
```typescript
export function useCartridgesPaginated(params: ListParams = {}) {
  const { page = 1, size = 20, q, caliber_family, quality_level, sort, order } = params;
  return useQuery({
    queryKey: ['cartridges', 'list', { page, size, q, caliber_family, quality_level, sort, order }],
    queryFn: () => getCartridges({ page, size, q, caliber_family, quality_level, sort, order }),
    placeholderData: keepPreviousData,
  });
}
```

Note: cartridges does NOT destructure `manufacturer` since the cartridge backend has no manufacturer filter. However, even if `manufacturer` were passed via ListParams, `buildQueryString` would just send it and the backend would ignore unknown params. This is safe, but for clarity, we omit it from cartridges.
  </action>
  <verify>
    <automated>cd C:/Users/vall-/Desktop/projectes/simulador_balistica/frontend && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
    <manual>Verify each hook's queryKey includes all filter params, and queryFn passes them to the API function</manual>
  </verify>
  <done>All three paginated hooks destructure full ListParams, include all filter params in queryKey, and pass them to queryFn. keepPreviousData is preserved.</done>
</task>

<task type="auto">
  <name>Task 2: Wire FilterBar into powders, bullets, and cartridges list pages</name>
  <files>frontend/src/app/powders/page.tsx, frontend/src/app/bullets/page.tsx, frontend/src/app/cartridges/page.tsx</files>
  <action>
For each of the three list pages, add filter state + FilterBar + zero-results empty state. The pattern is identical across pages with entity-specific configuration.

**Common pattern for all three pages:**

1. **Add imports:**
   ```typescript
   import { FilterBar } from '@/components/filters/FilterBar';
   import { useManufacturers, useCaliberFamilies } from '@/hooks/useFilterOptions';
   import { useDebounce } from '@/hooks/useDebounce';
   ```
   (Only import useManufacturers/useCaliberFamilies that the page actually uses.)

2. **Add filter state variables** (after existing page/size state):
   ```typescript
   const [searchTerm, setSearchTerm] = useState('');
   const [manufacturer, setManufacturer] = useState('');
   const [caliberFamily, setCaliberFamily] = useState('');
   const [qualityLevel, setQualityLevel] = useState('');
   const debouncedSearch = useDebounce(searchTerm, 300);
   ```
   (Only add caliberFamily for bullets/cartridges, only add manufacturer for powders/bullets.)

3. **Create a reset-to-page-1 helper:**
   ```typescript
   const handleFilterChange = <T,>(setter: (v: T) => void) => (value: T) => {
     setter(value);
     setPage(1);
   };
   ```

4. **Pass filter params to the paginated hook:**
   ```typescript
   const { data, isLoading, isError, isPlaceholderData } = usePowdersPaginated({
     page,
     size,
     q: debouncedSearch || undefined,
     manufacturer: manufacturer || undefined,
     quality_level: qualityLevel || undefined,
   });
   ```

5. **Fetch filter dropdown options:**
   ```typescript
   const { data: manufacturers = [] } = useManufacturers('powders');
   ```

6. **Compute hasActiveFilters:**
   ```typescript
   const hasActiveFilters = !!(debouncedSearch || manufacturer || caliberFamily || qualityLevel);
   ```

7. **Create clearFilters handler:**
   ```typescript
   const handleClearFilters = () => {
     setSearchTerm('');
     setManufacturer('');
     setCaliberFamily('');
     setQualityLevel('');
     setPage(1);
   };
   ```

8. **Render FilterBar** between the page header/form section and the table. Place it just before `{(isLoading || powders.length > 0) && (` block:
   ```tsx
   <FilterBar
     searchValue={searchTerm}
     onSearchChange={handleFilterChange(setSearchTerm)}
     manufacturers={manufacturers}
     selectedManufacturer={manufacturer}
     onManufacturerChange={handleFilterChange(setManufacturer)}
     selectedQualityLevel={qualityLevel}
     onQualityLevelChange={handleFilterChange(setQualityLevel)}
     hasActiveFilters={hasActiveFilters}
     onClearFilters={handleClearFilters}
   />
   ```

9. **Add zero-results empty state** inside the table section. After the table and before Pagination, add:
   ```tsx
   {!isLoading && items.length === 0 && hasActiveFilters && (
     <div className="flex flex-col items-center py-12 text-center">
       <p className="text-sm text-slate-400">No se encontraron resultados</p>
       <button
         onClick={handleClearFilters}
         className="mt-2 text-sm text-blue-400 hover:text-blue-300"
       >
         Limpiar filtros
       </button>
     </div>
   )}
   ```
   Also update the existing "Sin X registradas" empty state to only show when there are NO active filters (to differentiate between "database is empty" and "no results for current filters").

**Entity-specific configuration:**

- **Powders page:** manufacturer dropdown + quality dropdown. No caliber_family. Use `useManufacturers('powders')`.
- **Bullets page:** manufacturer dropdown + caliber_family dropdown + quality dropdown. Use `useManufacturers('bullets')` and `useCaliberFamilies('bullets')`.
- **Cartridges page:** caliber_family dropdown + quality dropdown. NO manufacturer (cartridges have no manufacturer column per Pitfall 5 in research). Use `useCaliberFamilies('cartridges')`.

**IMPORTANT considerations:**
- The FilterBar should be rendered ALWAYS (not conditionally on data length) so users can always access search/filter.
- The search `onSearchChange` handler should call `handleFilterChange(setSearchTerm)` so page resets to 1 on each keystroke (the debounced value feeds the API, but page resets immediately for UX responsiveness).
- Pass `undefined` (not empty string) for unused filter params to avoid sending empty query params.
  </action>
  <verify>
    <automated>cd C:/Users/vall-/Desktop/projectes/simulador_balistica/frontend && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
    <manual>Verify all three pages render FilterBar with correct entity-specific dropdowns. Verify filter state resets page to 1. Verify zero-results message appears when filters yield no data.</manual>
  </verify>
  <done>All three list pages render FilterBar with entity-appropriate dropdowns. Filter changes reset to page 1. Zero results with active filters shows "No se encontraron resultados" with "Limpiar filtros" button. Powders: manufacturer+quality. Bullets: manufacturer+caliber_family+quality. Cartridges: caliber_family+quality. Search debounced at 300ms via useDebounce.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. All three paginated hooks include filter params in queryKey and queryFn
3. Powders page shows FilterBar with manufacturer dropdown (populated from /powders/manufacturers) and quality dropdown
4. Bullets page shows FilterBar with manufacturer, caliber family, and quality dropdowns
5. Cartridges page shows FilterBar with caliber family and quality dropdowns (no manufacturer)
6. Search input with 300ms debounce works on all three pages
7. Changing any filter resets pagination to page 1
8. "No se encontraron resultados" + "Limpiar filtros" appears when filters return zero results
9. Clearing filters restores all dropdowns to "all" state and search to empty
10. keepPreviousData prevents table flash during filter changes
</verification>

<success_criteria>
- TypeScript compiles without errors
- SRC-03 requirement fully satisfied: users can filter by manufacturer, caliber family, and quality level on all applicable list pages
- Filters combine with search and pagination using AND logic
- Zero-results state provides clear feedback and one-click filter reset
</success_criteria>

<output>
After completion, create `.planning/phases/08-frontend-filter-search-controls/08-02-SUMMARY.md`
</output>
