---
phase: 13-3d-parametric-cartridge-viewer
plan: 03
type: execute
wave: 3
depends_on: [13-02]
files_modified:
  - frontend/src/lib/drawings/types.ts
  - frontend/src/components/drawings/DrawingTabs.tsx
  - frontend/src/components/drawings/DrawingViewer.tsx
  - frontend/src/app/drawings/page.tsx
  - frontend/src/app/simulate/page.tsx
autonomous: true
requirements: [VIS3-01, VIS3-04, VIS3-05]

must_haves:
  truths:
    - "User sees a '3D' tab alongside cross-section/chamber/assembly tabs on the drawings page"
    - "Selecting the 3D tab loads the CartridgeViewer3D component with the selected cartridge/bullet"
    - "Three.js bundle is NOT loaded until the 3D tab is active (code splitting via next/dynamic)"
    - "Switching away from the 3D tab unmounts the Canvas, disposing WebGL context (no leak after 20+ navigations)"
    - "Deep link /drawings?tab=3d&cartridge_id=...&bullet_id=... opens the 3D viewer directly"
    - "Simulation results page has a 'Vista 3D' button that deep links to the 3D tab"
    - "When WebGL is not available, user is redirected to cross-section tab with toast notification"
    - "Insufficient data shows message instead of 3D canvas with link to edit form"
  artifacts:
    - path: "frontend/src/lib/drawings/types.ts"
      provides: "Updated DrawingTab type including '3d'"
      contains: "'3d'"
    - path: "frontend/src/components/drawings/DrawingTabs.tsx"
      provides: "4-tab navigation including 3D tab"
      contains: "3D"
    - path: "frontend/src/components/drawings/DrawingViewer.tsx"
      provides: "Conditional Canvas mount/unmount for 3D tab with dynamic import"
      contains: "dynamic"
    - path: "frontend/src/app/drawings/page.tsx"
      provides: "tab=3d query param handling"
      contains: "3d"
    - path: "frontend/src/app/simulate/page.tsx"
      provides: "Vista 3D deep link button in results"
      contains: "Vista 3D"
  key_links:
    - from: "frontend/src/components/drawings/DrawingViewer.tsx"
      to: "frontend/src/components/drawings/viewer3d/CartridgeViewer3D.tsx"
      via: "next/dynamic import with ssr: false"
      pattern: "dynamic.*CartridgeViewer3D.*ssr.*false"
    - from: "frontend/src/app/simulate/page.tsx"
      to: "frontend/src/app/drawings/page.tsx"
      via: "Link with tab=3d query param"
      pattern: "tab=3d"
    - from: "frontend/src/components/drawings/DrawingViewer.tsx"
      to: "frontend/src/lib/drawings/types.ts"
      via: "uses updated DrawingTab type including '3d'"
      pattern: "DrawingTab"
---

<objective>
Integrate the 3D viewer into the existing drawings page with code splitting, WebGL lifecycle management, and deep linking.

Purpose: Wire the CartridgeViewer3D component from Plan 02 into the existing tab navigation system on `/drawings`, ensuring Three.js is only loaded when the 3D tab is active (VIS3-04) and WebGL context is properly disposed when leaving the tab (VIS3-05). Also add deep link support from simulation results.

Output: Updated DrawingTabs with 4th tab, DrawingViewer with dynamic import and conditional mount, drawings page with tab=3d query param, simulation page with "Vista 3D" button.
</objective>

<execution_context>
@C:/Users/vall-/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/vall-/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-3d-parametric-cartridge-viewer/13-CONTEXT.md
@.planning/phases/13-3d-parametric-cartridge-viewer/13-RESEARCH.md
@.planning/phases/13-3d-parametric-cartridge-viewer/13-02-PLAN.md
@frontend/src/lib/drawings/types.ts
@frontend/src/components/drawings/DrawingTabs.tsx
@frontend/src/components/drawings/DrawingViewer.tsx
@frontend/src/app/drawings/page.tsx
@frontend/src/app/simulate/page.tsx

<interfaces>
<!-- Existing types and components that will be modified -->

From frontend/src/lib/drawings/types.ts:
```typescript
export type DrawingTab = 'cross-section' | 'chamber' | 'assembly';
// MUST be updated to: 'cross-section' | 'chamber' | 'assembly' | '3d'
```

From frontend/src/components/drawings/DrawingTabs.tsx:
```typescript
interface DrawingTabsProps {
  activeTab: DrawingTab;
  onTabChange: (tab: DrawingTab) => void;
  hasSimulation: boolean;
  hasRifle: boolean;
}
// TABS array has 3 entries: cross-section, chamber, assembly
// MUST add 4th entry: { key: '3d', label: 'Vista 3D', requiresRifle: false }
```

From frontend/src/components/drawings/DrawingViewer.tsx:
```typescript
interface DrawingViewerProps {
  cartridge: Cartridge;
  bullet?: Bullet;
  rifle?: Rifle;
  simulation?: SimulationResult;
  initialTab?: DrawingTab;
}
// MUST add: dynamic import of CartridgeViewer3D, conditional render for 3D tab
```

From frontend/src/components/drawings/viewer3d/CartridgeViewer3D.tsx (from Plan 02):
```typescript
interface CartridgeViewer3DProps {
  cartridge: Cartridge;
  bullet?: Bullet;
  rifle?: Rifle;
  powderChargeGrains?: number;
}
export default function CartridgeViewer3D(props: CartridgeViewer3DProps): JSX.Element;
```

From frontend/src/components/drawings/CompletenessBanner.tsx:
```typescript
interface CompletenessBannerProps {
  completeness: 'full' | 'basic' | 'insufficient';
  estimatedFields: string[];
  totalFields: number;
  entityType: 'cartridge' | 'rifle';
  entityId: string;
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update DrawingTab type, DrawingTabs component, and DrawingViewer with dynamic 3D import</name>
  <files>frontend/src/lib/drawings/types.ts, frontend/src/components/drawings/DrawingTabs.tsx, frontend/src/components/drawings/DrawingViewer.tsx</files>
  <action>
**1. Update types.ts — Add '3d' to DrawingTab union:**

Change:
```typescript
export type DrawingTab = 'cross-section' | 'chamber' | 'assembly';
```
To:
```typescript
export type DrawingTab = 'cross-section' | 'chamber' | 'assembly' | '3d';
```

**2. Update DrawingTabs.tsx — Add 3D tab:**

Add a 4th entry to the TABS array:
```typescript
{ key: '3d', label: 'Vista 3D', requiresRifle: false },
```

Add a visual indicator for the 3D tab — use a small "3D" badge or a cube icon to distinguish it from the 2D drawing tabs. Can use the `Box` icon from lucide-react:
```typescript
import { Box } from 'lucide-react';
```
Show the Box icon next to "Vista 3D" label in the tab button.

**3. Update DrawingViewer.tsx — Dynamic import + conditional mount:**

Add at the top of the file (AFTER existing imports):
```typescript
import dynamic from 'next/dynamic';

const CartridgeViewer3DLazy = dynamic(
  () => import('./viewer3d/CartridgeViewer3D'),
  { ssr: false, loading: () => <div className="flex items-center justify-center" style={{ height: '60vh', minHeight: 400 }}><Spinner size="lg" /></div> }
);
```

Import `Spinner` if not already imported.

In the render section, add a conditional block for the 3D tab. This is CRITICAL for VIS3-04 (code splitting) and VIS3-05 (WebGL lifecycle):

Inside the primary drawing container `<div>`, after the existing `activeTab === 'assembly'` block and before the "no rifle" fallback, add:

```tsx
{activeTab === '3d' && cartridgeGeometry.dataCompleteness !== 'insufficient' && (
  <CartridgeViewer3DLazy
    cartridge={cartridge}
    bullet={bullet}
    rifle={rifle}
  />
)}
{activeTab === '3d' && cartridgeGeometry.dataCompleteness === 'insufficient' && (
  <div className="flex flex-col items-center justify-center py-20 text-center">
    <p className="text-slate-400 text-lg">
      Datos insuficientes para el modelo 3D
    </p>
    <p className="text-slate-500 text-sm mt-2">
      Completa las dimensiones del cartucho para generar el modelo 3D
    </p>
  </div>
)}
```

IMPORTANT: The `CartridgeViewer3DLazy` component is conditionally rendered — it only mounts when `activeTab === '3d'`. When the user switches to another tab, the component unmounts, which causes R3F to call `forceContextLoss()` on the WebGL renderer automatically. This is the key mechanism for VIS3-05 (no memory leak after 20+ navigations).

For the `completeness` computation in the useMemo block, add a case for `activeTab === '3d'`:
```typescript
if (activeTab === '3d') {
  return {
    completeness: cartridgeGeometry.dataCompleteness,
    estimatedFields: cartridgeGeometry.estimatedFields,
    totalFields: CARTRIDGE_TOTAL_FIELDS,
    entityType: 'cartridge' as const,
  };
}
```

Also update the `basename` computation to handle the '3d' tab:
```typescript
const tabNames: Record<DrawingTab, string> = {
  'cross-section': 'seccion-transversal',
  chamber: 'recamara',
  assembly: 'conjunto',
  '3d': 'vista-3d',
};
```

Hide the StyleToggle and ExportMenu when the 3D tab is active (they are 2D SVG-only controls):
```tsx
{activeTab !== '3d' && (
  <div className="flex items-center gap-3">
    <StyleToggle style={style} onToggle={toggleStyle} />
    <ExportMenu ... />
  </div>
)}
```

Also skip the hidden alt-style drawing render when 3D tab is active (no dual-export for 3D):
```tsx
{activeTab !== '3d' && (
  <div className="hidden" aria-hidden="true">
    {/* existing alt-style blocks */}
  </div>
)}
```

For the drawing container, when 3D is active, do NOT use the overflow/maxHeight constraints (the 3D viewer manages its own sizing):
```tsx
{activeTab !== '3d' ? (
  <div className="overflow-x-auto rounded border border-slate-700 bg-slate-800/50 flex items-center justify-center" style={{ maxHeight: '70vh' }}>
    {/* existing 2D drawing blocks */}
  </div>
) : (
  <div className="rounded border border-slate-700 bg-slate-900">
    {/* 3D viewer */}
  </div>
)}
```

**WebGL fallback handling:**
When the 3D tab is selected but WebGL is not available, the R3F Canvas `fallback` prop will render a static message. Additionally, add a check using:
```typescript
function isWebGLAvailable(): boolean {
  try {
    const canvas = document.createElement('canvas');
    return !!(canvas.getContext('webgl2') || canvas.getContext('webgl'));
  } catch {
    return false;
  }
}
```

If WebGL is not available when the user clicks the 3D tab, switch to 'cross-section' tab and show a toast/message. You can either:
- Use a simple state-based notification that disappears after 3 seconds
- Or add a `useEffect` that checks WebGL on '3d' tab selection and reverts if unavailable

The simpler approach: let R3F's Canvas `fallback` handle it (it already renders a message). The Canvas fallback is sufficient for MVP — the user sees "WebGL no disponible" inside the viewer area.
  </action>
  <verify>
    <automated>cd frontend && npx tsc --noEmit src/lib/drawings/types.ts src/components/drawings/DrawingTabs.tsx src/components/drawings/DrawingViewer.tsx 2>&1 | head -30</automated>
  </verify>
  <done>DrawingTab type includes '3d'. DrawingTabs shows 4 tabs. DrawingViewer dynamically imports CartridgeViewer3D with ssr:false, conditionally mounts/unmounts on tab switch, hides 2D-only controls when 3D active. All 3 files compile cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Update drawings page query params and add Vista 3D deep link to simulation results</name>
  <files>frontend/src/app/drawings/page.tsx, frontend/src/app/simulate/page.tsx</files>
  <action>
**1. Update drawings/page.tsx — Add tab=3d to query param handling:**

In the `useEffect` that applies query params, update the tab validation to include '3d':

Change:
```typescript
if (tabParam === 'cross-section' || tabParam === 'chamber' || tabParam === 'assembly') {
  setInitialTab(tabParam);
}
```
To:
```typescript
if (tabParam === 'cross-section' || tabParam === 'chamber' || tabParam === 'assembly' || tabParam === '3d') {
  setInitialTab(tabParam as DrawingTab);
}
```

This enables deep linking via `/drawings?tab=3d&cartridge_id=...&bullet_id=...`.

Update the page description text to mention 3D:
```tsx
<p className="text-sm text-slate-400">
  Visualiza secciones transversales, recamaras, conjuntos y modelos 3D interactivos
</p>
```

**2. Update simulate/page.tsx — Add "Vista 3D" button:**

Find the existing "Ver Dibujo de Conjunto" Link/Button block. Add a second button next to it for the 3D view:

```tsx
<Link
  href={`/drawings?cartridge_id=${selectedRifle?.cartridge?.id || ''}&rifle_id=${lastParams?.rifle_id || ''}&bullet_id=${lastParams?.bullet_id || ''}&tab=3d`}
>
  <Button variant="secondary" size="sm">
    <Box size={14} />
    Vista 3D
  </Button>
</Link>
```

Import `Box` from lucide-react (add to the existing import line):
```typescript
import { AlertTriangle, CheckCircle, XCircle, Activity, Download, PenTool, Box } from 'lucide-react';
```

Place the "Vista 3D" button right after the "Ver Dibujo de Conjunto" button in the action bar, using the same styling pattern.
  </action>
  <verify>
    <automated>cd frontend && npx tsc --noEmit src/app/drawings/page.tsx src/app/simulate/page.tsx 2>&1 | head -20</automated>
  </verify>
  <done>Drawings page accepts tab=3d query param and opens the 3D viewer. Simulation results page has "Vista 3D" button that deep links to /drawings?tab=3d with cartridge/rifle/bullet IDs. Both files compile cleanly.</done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` — zero TypeScript errors across the full project
2. `grep "'3d'" frontend/src/lib/drawings/types.ts` — confirms '3d' in DrawingTab union
3. `grep "Vista 3D" frontend/src/components/drawings/DrawingTabs.tsx` — confirms 3D tab label
4. `grep "dynamic" frontend/src/components/drawings/DrawingViewer.tsx` — confirms dynamic import
5. `grep "ssr: false" frontend/src/components/drawings/DrawingViewer.tsx` — confirms SSR disabled for 3D
6. `grep "tab=3d" frontend/src/app/simulate/page.tsx` — confirms deep link from simulation
7. `grep "tab=3d" frontend/src/app/drawings/page.tsx` — confirms query param handling (via the '3d' string match)
8. Verify conditional mount: `grep -A2 "activeTab === '3d'" frontend/src/components/drawings/DrawingViewer.tsx` — confirms Canvas mounts/unmounts on tab switch
</verification>

<success_criteria>
- DrawingTab type union includes '3d' alongside existing tabs
- DrawingTabs component renders 4 tabs with "Vista 3D" having a Box icon
- DrawingViewer dynamically imports CartridgeViewer3D with next/dynamic + ssr: false (VIS3-04)
- Canvas component conditionally mounts/unmounts on 3D tab activate/deactivate (VIS3-05)
- 2D-only controls (StyleToggle, ExportMenu) are hidden when 3D tab is active
- Drawings page accepts tab=3d query parameter for deep linking
- Simulation results page has "Vista 3D" button with deep link to /drawings?tab=3d
- Insufficient data shows message with edit link instead of 3D canvas
- All modified files compile with zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-3d-parametric-cartridge-viewer/13-03-SUMMARY.md`
</output>
