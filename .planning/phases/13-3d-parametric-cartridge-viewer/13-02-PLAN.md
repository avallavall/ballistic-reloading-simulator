---
phase: 13-3d-parametric-cartridge-viewer
plan: 02
type: execute
wave: 2
depends_on: [13-01]
files_modified:
  - frontend/src/components/drawings/viewer3d/CartridgeViewer3D.tsx
  - frontend/src/components/drawings/viewer3d/CartridgeMesh.tsx
  - frontend/src/components/drawings/viewer3d/BulletMesh.tsx
  - frontend/src/components/drawings/viewer3d/PrimerMesh.tsx
  - frontend/src/components/drawings/viewer3d/CutawayControls.tsx
  - frontend/src/components/drawings/viewer3d/DimensionLabels3D.tsx
autonomous: true
requirements: [VIS3-01, VIS3-02, VIS3-03]

must_haves:
  truths:
    - "User can view a 3D cartridge model with realistic metallic materials (brass case, copper bullet, nickel primer)"
    - "User can rotate, zoom, and pan the 3D model using mouse/touch controls"
    - "User can toggle a cutaway half-section view showing case wall, powder space, and bullet seating"
    - "Bullet material appearance varies by bullet_type (FMJ=copper jacket, HP=copper with exposed lead, solid copper=uniform copper)"
    - "Dimension labels can be toggled on/off showing key measurements in 3D space"
  artifacts:
    - path: "frontend/src/components/drawings/viewer3d/CartridgeViewer3D.tsx"
      provides: "Main R3F Canvas scene with lighting, controls, environment"
      exports: ["default (CartridgeViewer3D)"]
    - path: "frontend/src/components/drawings/viewer3d/CartridgeMesh.tsx"
      provides: "Case body mesh from LatheGeometry with cutaway support"
      exports: ["default (CartridgeMesh)"]
    - path: "frontend/src/components/drawings/viewer3d/BulletMesh.tsx"
      provides: "Bullet mesh from LatheGeometry with type-aware materials"
      exports: ["default (BulletMesh)"]
    - path: "frontend/src/components/drawings/viewer3d/PrimerMesh.tsx"
      provides: "Primer cylinder mesh at case head"
      exports: ["default (PrimerMesh)"]
    - path: "frontend/src/components/drawings/viewer3d/CutawayControls.tsx"
      provides: "Clip plane management with animated toggle"
      exports: ["default (CutawayControls)", "useCutawayPlane"]
    - path: "frontend/src/components/drawings/viewer3d/DimensionLabels3D.tsx"
      provides: "drei Html overlays showing cartridge dimensions"
      exports: ["default (DimensionLabels3D)"]
  key_links:
    - from: "frontend/src/components/drawings/viewer3d/CartridgeViewer3D.tsx"
      to: "frontend/src/lib/geometry/mesh-builder.ts"
      via: "imports profileToLatheGeometry for geometry creation"
      pattern: "import.*profileToLatheGeometry.*from.*mesh-builder"
    - from: "frontend/src/components/drawings/viewer3d/CartridgeViewer3D.tsx"
      to: "frontend/src/lib/geometry/materials.ts"
      via: "imports MATERIALS and getBulletMaterials for PBR rendering"
      pattern: "import.*MATERIALS.*from.*materials"
    - from: "frontend/src/components/drawings/viewer3d/CartridgeViewer3D.tsx"
      to: "frontend/src/lib/geometry/cartridge-geometry.ts"
      via: "calls generateCartridgeProfile for ProfilePoint[] input"
      pattern: "import.*generateCartridgeProfile.*from.*cartridge-geometry"
---

<objective>
Build all React Three Fiber components for the interactive 3D cartridge viewer with orbit controls, cutaway toggle, and dimension labels.

Purpose: Create the complete 3D scene that renders a parametric cartridge model from database dimensions. This is the core visual deliverable of Phase 13 — the user sees a realistic 3D brass case with copper bullet, can rotate/zoom/pan it, toggle a cutaway view showing internal structure, and optionally display dimension labels.

Output: 6 R3F components in `frontend/src/components/drawings/viewer3d/` directory — the main scene, 3 mesh components (case, bullet, primer), cutaway controls, and dimension labels.
</objective>

<execution_context>
@C:/Users/vall-/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/vall-/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-3d-parametric-cartridge-viewer/13-CONTEXT.md
@.planning/phases/13-3d-parametric-cartridge-viewer/13-RESEARCH.md
@.planning/phases/13-3d-parametric-cartridge-viewer/13-01-PLAN.md
@frontend/src/lib/geometry/types.ts
@frontend/src/lib/geometry/cartridge-geometry.ts
@frontend/src/lib/geometry/bullet-geometry.ts

<interfaces>
<!-- From Plan 01 (mesh-builder.ts) — these exports will exist when this plan runs -->

From frontend/src/lib/geometry/mesh-builder.ts:
```typescript
import { ProfilePoint } from './types';
import * as THREE from 'three';

export function profileToLatheGeometry(points: ProfilePoint[], segments?: number): THREE.LatheGeometry;
export function profileToHalfLatheGeometry(points: ProfilePoint[], segments?: number): THREE.LatheGeometry;
export function createPrimerGeometry(primerDiameter: number, primerHeight: number): THREE.CylinderGeometry;
export function createPowderFillGeometry(caseInnerRadius: number, fillHeight: number): THREE.CylinderGeometry;
```

From frontend/src/lib/geometry/materials.ts:
```typescript
export interface MaterialParams {
  color: string;
  metalness: number;
  roughness: number;
}

export const MATERIALS: Record<string, MaterialParams>;
export function getBulletMaterials(bulletType: string | null): { jacket: MaterialParams; core: MaterialParams };
export const CUTAWAY_COLORS: Record<string, string>;
```

From frontend/src/lib/geometry/types.ts:
```typescript
export interface ProfilePoint { x: number; y: number; }
export interface GeometryResult {
  svgPath: string;
  profilePoints: ProfilePoint[];
  estimatedFields: string[];
  dataCompleteness: 'full' | 'basic' | 'insufficient';
}
export interface CartridgeDimensions { /* 12 fields */ }
export interface BulletDimensions { /* 10 fields */ }
```

From frontend/src/lib/geometry/cartridge-geometry.ts:
```typescript
export function generateCartridgeProfile(dims: CartridgeDimensions): GeometryResult;
```

From frontend/src/lib/geometry/bullet-geometry.ts:
```typescript
export function generateBulletProfile(dims: BulletDimensions): GeometryResult;
```

R3F / drei APIs (already installed):
```typescript
import { Canvas, useFrame, useThree } from '@react-three/fiber';
import { OrbitControls, Environment, Html } from '@react-three/drei';
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mesh components (CartridgeMesh, BulletMesh, PrimerMesh) and CutawayControls</name>
  <files>frontend/src/components/drawings/viewer3d/CartridgeMesh.tsx, frontend/src/components/drawings/viewer3d/BulletMesh.tsx, frontend/src/components/drawings/viewer3d/PrimerMesh.tsx, frontend/src/components/drawings/viewer3d/CutawayControls.tsx</files>
  <action>
Create directory `frontend/src/components/drawings/viewer3d/`.

All components below are `'use client'` React components.

**CutawayControls.tsx:**

This component manages the clipping plane for the cutaway half-section view.

Export a custom hook `useCutawayPlane(active: boolean)` that:
- Creates a `THREE.Plane` via `useRef` initialized as `new THREE.Plane(new THREE.Vector3(0, 0, -1), 0)` (clips along Z axis)
- When `active` is false, set plane constant to a large negative value (-999) to effectively disable clipping
- When `active` is true, animate the plane constant from -999 to 0 using `useFrame` with lerp (smooth transition over ~0.5 seconds)
- Returns `planeRef.current` (the THREE.Plane instance)
- Use `THREE.MathUtils.lerp` with `delta * 8` clamped to 1 for smooth animation

Also export a `CutawayPlane` component (for rendering the solid colored cap at the clip boundary):
```typescript
interface CutawayPlaneProps {
  active: boolean;
  planeRadius: number;
  color: string;
}
```
- When active, render a `<mesh>` with `<circleGeometry args={[planeRadius, 64]} />` positioned at z=0 and rotated to face the clip direction
- Use `<meshStandardMaterial color={color} side={THREE.DoubleSide} />`
- When not active, render null

**CartridgeMesh.tsx:**

Props:
```typescript
interface CartridgeMeshProps {
  profilePoints: ProfilePoint[];
  clipPlane: THREE.Plane | null;  // null = no clipping
  wallThickness?: number;         // mm, default 0.5 for inner wall
}
```

- Use `useMemo` to create the `LatheGeometry` from profilePoints via `profileToLatheGeometry(profilePoints, 64)`
- Apply `MATERIALS.brass` via `<meshStandardMaterial>` with the color, metalness, roughness from the material params
- When clipPlane is provided: set `clippingPlanes={[clipPlane]}` on the material, enable `clipShadows`, use `side={THREE.DoubleSide}`
- The mesh should be rotated so the cartridge is horizontal (lying on its side) — rotate -90 degrees around X so the Y axis (LatheGeometry default) maps to horizontal Z
- Clean up geometry in useMemo dependency cleanup (return dispose function)

For the inner wall (visible in cutaway):
- Create a second set of profile points by offsetting the outer profile inward by wallThickness (subtract wallThickness from each point's y value, clamping to minimum 0.1mm)
- Generate a second `LatheGeometry` from these inner points
- Only render the inner wall mesh when clipPlane is not null
- Use a slightly different brass color for the inner wall to differentiate it visually

**BulletMesh.tsx:**

Props:
```typescript
interface BulletMeshProps {
  profilePoints: ProfilePoint[];
  bulletType: string | null;
  clipPlane: THREE.Plane | null;
  positionY: number;  // axial offset in mm (bullet sits atop the case)
}
```

- Use `useMemo` to create geometry via `profileToLatheGeometry(profilePoints, 64)`
- Get material params via `getBulletMaterials(bulletType)`
- Apply jacket material to the mesh
- Position the bullet mesh at the correct axial position using the `positionY` prop (translate along the Y axis since LatheGeometry revolves around Y)
- Apply same rotation as CartridgeMesh (-90 deg around X) to maintain horizontal orientation
- When clipPlane provided: enable clipping on material
- For HP (hollow point) bullets: the core material (lead, darker) should be visible at the tip area. A simple approach: render a slightly smaller inner cylinder mesh at the tip position with lead material, only visible when cutaway is active.

**PrimerMesh.tsx:**

Props:
```typescript
interface PrimerMeshProps {
  primerDiameter: number;  // mm
  primerHeight: number;    // mm
  clipPlane: THREE.Plane | null;
}
```

- Use `useMemo` to create `CylinderGeometry` via `createPrimerGeometry(primerDiameter, primerHeight)`
- Apply `MATERIALS.nickel`
- Position at the case head (Y = -primerHeight/2 since primer protrudes from the base, before rotation)
- Apply same rotation as CartridgeMesh for consistent orientation
- When clipPlane provided: enable clipping

All meshes should use `<group>` wrappers with a single rotation applied at the group level so the cartridge assembly lies horizontal.
  </action>
  <verify>
    <automated>cd frontend && npx tsc --noEmit src/components/drawings/viewer3d/CartridgeMesh.tsx src/components/drawings/viewer3d/BulletMesh.tsx src/components/drawings/viewer3d/PrimerMesh.tsx src/components/drawings/viewer3d/CutawayControls.tsx 2>&1 | head -30</automated>
  </verify>
  <done>All 4 component files compile with zero TypeScript errors. CartridgeMesh renders case body with inner wall for cutaway. BulletMesh applies type-aware materials. PrimerMesh renders nickel cylinder. CutawayControls provides animated clip plane via useCutawayPlane hook.</done>
</task>

<task type="auto">
  <name>Task 2: Create CartridgeViewer3D main scene and DimensionLabels3D</name>
  <files>frontend/src/components/drawings/viewer3d/CartridgeViewer3D.tsx, frontend/src/components/drawings/viewer3d/DimensionLabels3D.tsx</files>
  <action>
**DimensionLabels3D.tsx:**

Props:
```typescript
interface DimensionLabels3DProps {
  visible: boolean;
  caseLength: number | null;    // mm
  oal: number | null;           // mm (overall length with bullet)
  neckDiameter: number | null;  // mm
  baseDiameter: number | null;  // mm
}
```

- When `visible` is false, render null
- Use drei `<Html>` component for each dimension label, positioned in 3D space at sensible locations:
  - Case length label: positioned at the midpoint of the case, offset above
  - OAL label: positioned at the midpoint of the full cartridge, offset below
  - Neck diameter: positioned at the neck area, offset to the side
  - Base diameter: positioned at the base, offset to the side
- Each label renders a small dark overlay div with Tailwind classes: `bg-slate-900/80 text-white text-xs px-2 py-1 rounded whitespace-nowrap border border-slate-600`
- Use `distanceFactor={80}` on Html for consistent label sizing regardless of zoom
- Skip labels where the value is null
- Labels are in Spanish: "Longitud Vaina", "Longitud Total", "Diametro Cuello", "Diametro Base"

**CartridgeViewer3D.tsx:**

This is the MAIN scene component. It will be dynamically imported via `next/dynamic` in the page integration plan.

Props:
```typescript
interface CartridgeViewer3DProps {
  cartridge: Cartridge;
  bullet?: Bullet;
  rifle?: Rifle;
  // For powder fill level (optional, from simulation/load data)
  powderChargeGrains?: number;
}
```

Implementation:

1. **Geometry generation** (in useMemo):
   - Convert cartridge to `CartridgeDimensions` using same `toCartridgeDims` pattern as DrawingViewer.tsx
   - Call `generateCartridgeProfile(dims)` to get cartridge ProfilePoint[]
   - If bullet provided, convert to `BulletDimensions` and call `generateBulletProfile(bulletDims)` to get bullet ProfilePoint[]
   - These are computed once and cached via useMemo with cartridge/bullet as deps

2. **Scene state:**
   - `cutawayActive` boolean state (default false)
   - `showLabels` boolean state (default false — per user decision: off by default)
   - Get clipPlane from `useCutawayPlane(cutawayActive)`

3. **Camera setup:**
   - Default camera position: `[0, 30, 80]` (above and in front of horizontal cartridge)
   - FOV: 45 degrees
   - Near: 0.1, Far: 1000

4. **Canvas configuration (CRITICAL):**
   ```tsx
   <Canvas
     gl={{ stencil: true, antialias: true, localClippingEnabled: true }}
     camera={{ position: [0, 30, 80], fov: 45, near: 0.1, far: 1000 }}
     fallback={<div className="flex items-center justify-center h-full text-slate-400 p-8">WebGL no disponible</div>}
   >
   ```
   - `stencil: true` is REQUIRED for cutaway caps (three.js r163+ disabled it by default)
   - `localClippingEnabled: true` is REQUIRED for clipping planes to work
   - `fallback` provides automatic WebGL detection (VIS3-01 degradation)

5. **Scene contents:**
   ```tsx
   <ambientLight intensity={0.4} />
   <directionalLight position={[10, 20, 15]} intensity={0.7} castShadow />
   <directionalLight position={[-5, 10, -10]} intensity={0.3} />
   <Environment files="/hdri/studio_small.hdr" />
   <OrbitControls
     enablePan={true}
     enableZoom={true}
     enableRotate={true}
     minDistance={20}
     maxDistance={200}
     enableDamping
     dampingFactor={0.1}
   />
   ```

6. **Assembly group:**
   - Wrap all meshes in a `<group>` with rotation `[-Math.PI / 2, 0, 0]` to orient cartridge horizontally
   - Render `<CartridgeMesh>` with cartridge profilePoints
   - If bullet exists, render `<BulletMesh>` positioned at case_length along the axial direction
   - Render `<PrimerMesh>` with primer dimensions (estimate primer diameter as base_diameter * 0.45 if not available, primer height as 3mm)
   - If powder charge data available, render powder fill cylinder inside the case using `createPowderFillGeometry`
   - Render `<DimensionLabels3D>` with cartridge/bullet dimensions when showLabels is true

7. **Cutaway toggle and label toggle** are rendered OUTSIDE the Canvas as HTML controls:
   - Toggle button for cutaway: "Seccion" with an icon, positioned in the top-left of the viewer container
   - Toggle button for labels: "Cotas" with an icon, positioned next to the cutaway button
   - Both use Tailwind classes matching the dark theme: `bg-slate-800 border border-slate-600 px-3 py-1.5 rounded text-sm text-slate-300 hover:text-white transition-colors`
   - Active state: `bg-blue-600 border-blue-500 text-white`

8. **Container:**
   - The component renders a `<div>` with relative positioning containing:
     - The toggle buttons bar at the top
     - The Canvas below, taking remaining height (use `style={{ height: '60vh', minHeight: 400 }}`)
     - A loading state: show `<Spinner>` centered while geometries are being computed (use a loading flag)

IMPORTANT: This component will be imported dynamically with `ssr: false` in Plan 03. It must be a default export. It imports Three.js, R3F, and drei — all client-only. Mark it `'use client'`.
  </action>
  <verify>
    <automated>cd frontend && npx tsc --noEmit src/components/drawings/viewer3d/CartridgeViewer3D.tsx src/components/drawings/viewer3d/DimensionLabels3D.tsx 2>&1 | head -30</automated>
  </verify>
  <done>CartridgeViewer3D renders a complete 3D scene with Canvas (stencil:true, localClippingEnabled:true), OrbitControls, Environment, lighting, and all mesh sub-components. DimensionLabels3D shows toggleable HTML overlays via drei Html. Both compile with zero errors.</done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` — zero TypeScript errors across the full project
2. `ls frontend/src/components/drawings/viewer3d/` — shows 6 files: CartridgeViewer3D.tsx, CartridgeMesh.tsx, BulletMesh.tsx, PrimerMesh.tsx, CutawayControls.tsx, DimensionLabels3D.tsx
3. `grep "localClippingEnabled" frontend/src/components/drawings/viewer3d/CartridgeViewer3D.tsx` — confirms clipping enabled
4. `grep "stencil: true" frontend/src/components/drawings/viewer3d/CartridgeViewer3D.tsx` — confirms stencil enabled
5. `grep "OrbitControls" frontend/src/components/drawings/viewer3d/CartridgeViewer3D.tsx` — confirms orbit controls
6. `grep "Environment" frontend/src/components/drawings/viewer3d/CartridgeViewer3D.tsx` — confirms HDR environment
</verification>

<success_criteria>
- CartridgeViewer3D renders a complete 3D scene with PBR materials, HDR lighting, and orbit controls
- User can rotate/zoom/pan the model via OrbitControls (VIS3-02)
- Cutaway toggle animates a clipping plane revealing internal structure (VIS3-03)
- Bullet material varies by bullet_type (FMJ, HP, solid copper) per user decision
- Dimension labels toggle on/off with drei Html overlays
- All 6 component files compile cleanly
- Canvas uses stencil:true, localClippingEnabled:true, and fallback prop for WebGL detection
</success_criteria>

<output>
After completion, create `.planning/phases/13-3d-parametric-cartridge-viewer/13-02-SUMMARY.md`
</output>
