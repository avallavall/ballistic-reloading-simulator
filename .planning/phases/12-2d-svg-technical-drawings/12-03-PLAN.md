---
phase: 12-2d-svg-technical-drawings
plan: 03
type: execute
wave: 3
depends_on: ["12-01", "12-02"]
files_modified:
  - frontend/src/hooks/useSvgExport.ts
  - frontend/src/hooks/useDrawingStyle.ts
  - frontend/src/components/drawings/DrawingTabs.tsx
  - frontend/src/components/drawings/ExportMenu.tsx
  - frontend/src/components/drawings/DrawingViewer.tsx
  - frontend/src/app/drawings/page.tsx
  - frontend/src/components/layout/Sidebar.tsx
  - frontend/src/app/simulate/page.tsx
autonomous: true
requirements: [VIS2-01, VIS2-02, VIS2-03, VIS2-04, VIS2-05]

must_haves:
  truths:
    - "User can navigate to /drawings from the sidebar and select a cartridge/rifle to view all 3 drawing tabs"
    - "User can switch between Cross-Section, Chamber, and Assembly tabs with horizontal tab navigation on desktop and dropdown on mobile"
    - "User can export any drawing as PNG (600 DPI), SVG, or PDF, with both blueprint and modern styles included in the export"
    - "Export generates two separate files for PNG/SVG (one per style) and a single 2-page PDF for PDF format"
    - "Style toggle persists selection in localStorage across page reloads"
    - "Assembly tab is always available and shows barrel + cartridge even without simulation data"
    - "Completeness banner appears above the drawing for basic tier and insufficient tier"
    - "Sidebar shows 'Dibujos Tecnicos' link with Pencil icon between Validacion and Proyectiles"
    - "After running a simulation, user sees a 'Ver Dibujo de Conjunto' button that navigates to /drawings with the rifle's cartridge_id, rifle_id, bullet_id pre-filled and the assembly tab active"
  artifacts:
    - path: "frontend/src/app/drawings/page.tsx"
      provides: "Dedicated /drawings page with cartridge/rifle selection, 3 drawing tabs, style toggle, export menu"
      min_lines: 150
    - path: "frontend/src/hooks/useSvgExport.ts"
      provides: "Hook wrapping exportSvgAsPng, exportSvgAsSvg, exportSvgAsPdf, exportBothStyles with loading state"
    - path: "frontend/src/hooks/useDrawingStyle.ts"
      provides: "Hook managing blueprint/modern toggle with localStorage persistence"
    - path: "frontend/src/components/drawings/DrawingTabs.tsx"
      provides: "Tab container with horizontal tabs on desktop, dropdown on mobile"
    - path: "frontend/src/components/drawings/ExportMenu.tsx"
      provides: "Export dropdown with PNG/SVG/PDF options"
    - path: "frontend/src/components/drawings/DrawingViewer.tsx"
      provides: "Orchestrator component compositing CompletenessBanner + active drawing + hidden alt-style drawing for export"
    - path: "frontend/src/app/simulate/page.tsx"
      provides: "'Ver Dibujo de Conjunto' button linking simulation results to assembly drawing with pre-filled IDs"
  key_links:
    - from: "frontend/src/app/drawings/page.tsx"
      to: "frontend/src/hooks/useCartridges.ts"
      via: "useCartridges() for cartridge selector dropdown"
      pattern: "useCartridges"
    - from: "frontend/src/app/drawings/page.tsx"
      to: "frontend/src/hooks/useRifles.ts"
      via: "useRifles() for rifle selector dropdown"
      pattern: "useRifles"
    - from: "frontend/src/components/drawings/DrawingViewer.tsx"
      to: "frontend/src/components/drawings/CartridgeCrossSection.tsx"
      via: "renders active drawing component based on selected tab"
      pattern: "CartridgeCrossSection|ChamberDrawing|AssemblyDrawing"
    - from: "frontend/src/hooks/useSvgExport.ts"
      to: "frontend/src/lib/drawings/export.ts"
      via: "wraps export utility functions with React state"
      pattern: "exportSvgAsPng|exportSvgAsPdf|exportBothStyles"
    - from: "frontend/src/components/layout/Sidebar.tsx"
      to: "frontend/src/app/drawings/page.tsx"
      via: "navigation link to /drawings"
      pattern: "href.*drawings"
    - from: "frontend/src/app/simulate/page.tsx"
      to: "frontend/src/app/drawings/page.tsx"
      via: "'Ver Dibujo de Conjunto' button navigates to /drawings?tab=assembly with cartridge/rifle/bullet IDs"
      pattern: "drawings.*tab=assembly"
---

<objective>
Wire all drawing components into a functional /drawings page with tab navigation, export system, style toggle, and sidebar link.

Purpose: This plan connects all the pieces built in Plans 01 and 02 into a user-facing page. After this plan, users can navigate to /drawings, select a cartridge and rifle, switch between three drawing tabs, toggle blueprint/modern styles, and export drawings in PNG/SVG/PDF format.

Output: /drawings page, 3 new components (DrawingTabs, ExportMenu, DrawingViewer), 2 new hooks (useSvgExport, useDrawingStyle), sidebar update, "Ver Dibujo de Conjunto" button on simulate results page.
</objective>

<execution_context>
@C:/Users/vall-/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/vall-/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-2d-svg-technical-drawings/12-CONTEXT.md
@.planning/phases/12-2d-svg-technical-drawings/12-RESEARCH.md
@.planning/phases/12-2d-svg-technical-drawings/12-01-SUMMARY.md
@.planning/phases/12-2d-svg-technical-drawings/12-02-SUMMARY.md

<interfaces>
<!-- Contracts from Plan 01 and Plan 02 that this plan consumes. -->

From frontend/src/lib/drawings/export.ts (Plan 01):
```typescript
export function exportSvgAsPng(svgElement: SVGSVGElement, filename: string, dpi?: number): Promise<void>;
export function exportSvgAsSvg(svgElement: SVGSVGElement, filename: string): void;
export function exportSvgAsPdf(svgElement: SVGSVGElement, filename: string): Promise<void>;
export function exportBothStyles(currentSvg: SVGSVGElement, otherStyleSvg: SVGSVGElement, basename: string, format: ExportFormat): Promise<void>;
```

From frontend/src/lib/drawings/types.ts (Plan 01):
```typescript
export type DrawingTab = 'cross-section' | 'chamber' | 'assembly';
export type ExportFormat = 'png' | 'svg' | 'pdf';
export interface DrawingTheme { name: 'blueprint' | 'modern'; /* ... */ }
```

From frontend/src/components/drawings/ (Plan 02):
```typescript
// CartridgeCrossSection.tsx - forwardRef component
export const CartridgeCrossSection: React.ForwardRefExoticComponent<{
  cartridge: Cartridge; bullet?: Bullet; style: 'blueprint' | 'modern'; width?: number; height?: number;
}>;

// ChamberDrawing.tsx - forwardRef component
export const ChamberDrawing: React.ForwardRefExoticComponent<{
  cartridge: Cartridge; bullet?: Bullet; rifle: Rifle; style: 'blueprint' | 'modern'; width?: number; height?: number;
}>;

// AssemblyDrawing.tsx - forwardRef component
export const AssemblyDrawing: React.ForwardRefExoticComponent<{
  cartridge: Cartridge; bullet?: Bullet; rifle: Rifle; simulation?: SimulationResult; style: 'blueprint' | 'modern'; width?: number; height?: number;
}>;

// CompletenessBanner.tsx
export function CompletenessBanner({ completeness, estimatedFields, totalFields, entityType, entityId }: { ... }): JSX.Element | null;

// StyleToggle.tsx
export function StyleToggle({ style, onToggle }: { style: 'blueprint' | 'modern'; onToggle: () => void }): JSX.Element;
```

From existing hooks:
```typescript
// useCartridges.ts
export function useCartridges(): UseQueryResult<Cartridge[]>;
export function useCartridge(id: string): UseQueryResult<Cartridge>;

// useRifles.ts
export function useRifles(): UseQueryResult<Rifle[]>;
export function useRifle(id: string): UseQueryResult<Rifle>;

// useBullets.ts
export function useBullets(): UseQueryResult<Bullet[]>;
```

From frontend/src/components/layout/Sidebar.tsx:
```typescript
// navItems array -- add new entry for /drawings
const navItems: { href: string; label: string; icon: typeof Home; indent?: boolean }[] = [
  { href: '/', label: 'Dashboard', icon: Home },
  // ...
  { href: '/validation', label: 'Validacion', icon: ShieldCheck },
  { href: '/bullets', label: 'Proyectiles', icon: Target },
  // ...
];
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create hooks (useSvgExport, useDrawingStyle) and wiring components (DrawingTabs, ExportMenu, DrawingViewer)</name>
  <files>
    frontend/src/hooks/useSvgExport.ts
    frontend/src/hooks/useDrawingStyle.ts
    frontend/src/components/drawings/DrawingTabs.tsx
    frontend/src/components/drawings/ExportMenu.tsx
    frontend/src/components/drawings/DrawingViewer.tsx
  </files>
  <action>
1. **frontend/src/hooks/useDrawingStyle.ts** -- Style toggle with localStorage:
   - `'use client'` directive
   - Exports `useDrawingStyle()` hook returning `{ style: 'blueprint' | 'modern', toggleStyle: () => void }`
   - Initializes from `localStorage.getItem('drawing-style')` on mount (default: 'blueprint')
   - `toggleStyle` flips between blueprint/modern and persists to localStorage
   - Uses `useState` + `useEffect` for hydration-safe localStorage read (SSR initial state = 'blueprint', updated on client mount)

2. **frontend/src/hooks/useSvgExport.ts** -- Export hook wrapping lib/drawings/export utilities:
   - `'use client'` directive
   - Exports `useSvgExport()` hook returning `{ exporting: boolean, exportDrawing: (format, primaryRef, altRef, basename) => Promise<void> }`
   - `exporting` state tracks loading spinner during export
   - `exportDrawing` function:
     - Sets `exporting = true`
     - Calls `exportBothStyles(primaryRef.current, altRef.current, basename, format)` from `lib/drawings/export`
     - Catches errors and logs them (no crash on export failure)
     - Sets `exporting = false` in finally block
   - Both `primaryRef` and `altRef` are `React.RefObject<SVGSVGElement>`

3. **frontend/src/components/drawings/DrawingTabs.tsx** -- Tab navigation:
   - `'use client'` directive
   - Props: `{ activeTab: DrawingTab, onTabChange: (tab: DrawingTab) => void, hasSimulation: boolean }`
   - Three tabs: "Seccion Transversal" (cross-section), "Recamara" (chamber), "Conjunto" (assembly)
   - Desktop (md+ breakpoint): horizontal tab bar using flex row, active tab has `border-b-2 border-blue-500 text-blue-400`, inactive has `text-slate-400 hover:text-white`
   - Mobile (< md breakpoint): `<select>` dropdown with the same 3 options, styled with dark theme classes
   - Chamber tab requires a rifle to be selected (disable and show tooltip if no rifle)
   - Assembly tab always enabled (per user decision)
   - If `hasSimulation`, show a small indicator dot on the Assembly tab (green dot) to signal simulation overlay is available

4. **frontend/src/components/drawings/ExportMenu.tsx** -- Export dropdown:
   - `'use client'` directive
   - Props: `{ onExport: (format: ExportFormat) => void, exporting: boolean }`
   - Renders a dropdown button "Exportar" with lucide `Download` icon
   - Dropdown options: "PNG (600 DPI)", "SVG (vector)", "PDF (print)"
   - Subtext under button: "Se exportan ambos estilos" ("Both styles are exported")
   - While `exporting` is true, show a spinner and disable the button
   - Use existing dropdown pattern: button click toggles a div with absolute positioning, click outside closes it (useEffect with click listener)

5. **frontend/src/components/drawings/DrawingViewer.tsx** -- Orchestrator component:
   - `'use client'` directive
   - Props: `{ cartridge: Cartridge, bullet?: Bullet, rifle?: Rifle, simulation?: SimulationResult, initialTab?: DrawingTab }`
   - Internal state: `activeTab` (DrawingTab), managed by DrawingTabs
   - Uses `useDrawingStyle()` for style toggle
   - Uses `useSvgExport()` for export functionality
   - Creates 2 refs per drawing: `primarySvgRef` and `altSvgRef` (alt is the other style, rendered hidden for export)
   - Computes data completeness from the geometry engine result for the active tab's entity
   - Total fields count: 13 for cartridge (case_length, overall_length, bore_diameter, groove_diameter, shoulder_diameter, neck_diameter, base_diameter, rim_diameter, shoulder_angle, neck_length, body_length, rim_thickness, case_type), varies for chamber
   - Renders:
     ```
     <div>
       <div className="flex items-center justify-between mb-4">
         <DrawingTabs activeTab={activeTab} onTabChange={setActiveTab} hasSimulation={!!simulation} />
         <div className="flex items-center gap-3">
           <StyleToggle style={style} onToggle={toggleStyle} />
           <ExportMenu onExport={(fmt) => exportDrawing(fmt, primaryRef, altRef, basename)} exporting={exporting} />
         </div>
       </div>
       <CompletenessBanner completeness={...} estimatedFields={...} totalFields={...} entityType="cartridge" entityId={cartridge.id} />
       {/* Primary drawing (visible) */}
       <div className="overflow-x-auto">
         {activeTab === 'cross-section' && <CartridgeCrossSection ref={primaryRef} cartridge={cartridge} bullet={bullet} style={style} />}
         {activeTab === 'chamber' && rifle && <ChamberDrawing ref={primaryRef} cartridge={cartridge} bullet={bullet} rifle={rifle} style={style} />}
         {activeTab === 'assembly' && rifle && <AssemblyDrawing ref={primaryRef} cartridge={cartridge} bullet={bullet} rifle={rifle} simulation={simulation} style={style} />}
         {(activeTab === 'chamber' || activeTab === 'assembly') && !rifle && <p className="text-slate-400 p-8 text-center">Selecciona un rifle para ver este dibujo</p>}
       </div>
       {/* Hidden alt-style drawing for dual-style export */}
       <div className="hidden" aria-hidden="true">
         {activeTab === 'cross-section' && <CartridgeCrossSection ref={altRef} cartridge={cartridge} bullet={bullet} style={altStyle} />}
         {activeTab === 'chamber' && rifle && <ChamberDrawing ref={altRef} cartridge={cartridge} bullet={bullet} rifle={rifle} style={altStyle} />}
         {activeTab === 'assembly' && rifle && <AssemblyDrawing ref={altRef} cartridge={cartridge} bullet={bullet} rifle={rifle} simulation={simulation} style={altStyle} />}
       </div>
     </div>
     ```
   - `altStyle` = style === 'blueprint' ? 'modern' : 'blueprint'
   - `basename` for export filename: `{cartridge.name}-{tabName}-{date}` (e.g., "308-Winchester-cross-section-2026-02-28")
   - The `overflow-x-auto` class enables horizontal scroll on mobile (per user decision)
  </action>
  <verify>
    <automated>cd frontend && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>2 hooks and 3 wiring components compile cleanly, DrawingViewer orchestrates tab switching, style toggling, completeness banner, export with hidden alt-style rendering</done>
</task>

<task type="auto">
  <name>Task 2: Create /drawings page, add sidebar link, and add "Ver Dibujo" button to simulate results</name>
  <files>
    frontend/src/app/drawings/page.tsx
    frontend/src/components/layout/Sidebar.tsx
    frontend/src/app/simulate/page.tsx
  </files>
  <action>
1. **frontend/src/app/drawings/page.tsx** -- Dedicated drawings page:
   - `'use client'` directive
   - Page title: "Dibujos Tecnicos" in an h1 matching existing page styles (text-2xl font-bold text-white)
   - Layout: Two selector dropdowns at top, then DrawingViewer below
   - Selector 1: Cartridge (cartucho) dropdown
     - Fetch all cartridges via `useCartridges()` hook
     - `<select>` with `<option>` for each cartridge, sorted by name
     - Default: no selection ("Seleccionar cartucho...")
     - On change: set selectedCartridgeId state, fetch full cartridge via `useCartridge(id)`
   - Selector 2: Rifle dropdown
     - Fetch all rifles via `useRifles()` hook
     - Filter to show only rifles whose `cartridge_id` matches the selected cartridge (if cartridge selected)
     - If no cartridge selected, show all rifles
     - Default: no selection ("Seleccionar rifle (opcional)...")
     - On change: set selectedRifleId state, fetch full rifle via `useRifle(id)`
   - Optional Selector 3: Bullet dropdown
     - Fetch all bullets via `useBullets()` hook (from `useCartridges` pattern)
     - Filter by caliber: show bullets whose `diameter_mm` matches cartridge's `bore_diameter_mm` (within 0.5mm tolerance) or `groove_diameter_mm`
     - Default: no selection ("Seleccionar proyectil (opcional)...")
   - Once cartridge is selected, render `<DrawingViewer cartridge={cartridge} bullet={bullet} rifle={rifle} />`
   - Before selection, show a centered message: "Selecciona un cartucho para ver los dibujos tecnicos" with a blueprint-style decorative border
   - Page follows the existing dark theme pattern from other pages (bg-slate-900, etc.)
   - Use the same Card component pattern as other pages if applicable, or simple `<div>` containers with matching Tailwind classes

2. **frontend/src/components/layout/Sidebar.tsx** -- Add drawings link:
   - Import `PenTool` (or `Pencil`) from lucide-react (representing technical drawings)
   - Add new navItem entry AFTER the Validacion entry and BEFORE Proyectiles:
     ```typescript
     { href: '/drawings', label: 'Dibujos Tecnicos', icon: PenTool },
     ```
   - The import statement needs to add `PenTool` to the lucide-react imports
   - No indent (it's a top-level page, not a sub-page)

3. **frontend/src/app/simulate/page.tsx** -- Add "Ver Dibujo de Conjunto" button (entry point 3 from CONTEXT.md):
   - Import `PenTool` from lucide-react and `Link` from `next/link`
   - After the simulation results are shown (inside the `{result && !simulation.isPending && (...)}` block), in the action bar that currently contains the "Exportar CSV" button, add a second button:
     ```tsx
     <Link
       href={`/drawings?cartridge_id=${selectedRifle?.cartridge?.id || ''}&rifle_id=${lastParams?.rifle_id || ''}&bullet_id=${lastParams?.bullet_id || ''}&tab=assembly`}
     >
       <Button variant="secondary" size="sm">
         <PenTool size={14} />
         Ver Dibujo de Conjunto
       </Button>
     </Link>
     ```
   - Place this button BETWEEN the SafetyIndicator and the "Exportar CSV" button in the flex row (around line 551-563)
   - The `selectedRifle` variable already exists (line 424: `const selectedRifle = result?.load?.rifle;`) and has `.cartridge?.id`
   - The `lastParams` variable already has `rifle_id` and `bullet_id`
   - This links to the /drawings page with the assembly tab pre-selected and IDs as query params
   - Also update the /drawings page to read these query params on mount:
     - In the /drawings page, use `useSearchParams()` from `next/navigation`
     - On mount, if `searchParams.get('cartridge_id')` exists, auto-select that cartridge
     - If `searchParams.get('rifle_id')` exists, auto-select that rifle
     - If `searchParams.get('bullet_id')` exists, auto-select that bullet
     - If `searchParams.get('tab')` exists, pass it as `initialTab` to DrawingViewer
   - This wires CONTEXT.md entry point 3: "Linked from simulation results -- assembly drawing includes that sim's harmonics/stress data"
   - Note: The actual simulation result data is NOT passed via URL (too large). The assembly drawing will render the structural view without simulation overlay when accessed this way. Full simulation overlay requires re-running the sim or a shared state solution (future enhancement).

**Entry points note:** The CONTEXT.md specifies 3 entry points:
1. Dedicated /drawings page -- implemented in this task (full)
2. Embedded "Drawings" tab within cartridge/rifle detail pages -- DEFERRED (these detail pages don't exist yet; current CRUD pages are table-based with inline edit, not detail views)
3. Linked from simulation results -- implemented in this task via "Ver Dibujo de Conjunto" button on /simulate page that navigates to /drawings?tab=assembly with IDs pre-filled
  </action>
  <verify>
    <automated>cd frontend && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>/drawings page renders with cartridge/rifle/bullet selectors and DrawingViewer, sidebar has "Dibujos Tecnicos" link, simulate page has "Ver Dibujo de Conjunto" button linking to /drawings?tab=assembly with IDs, /drawings reads query params on mount, all compiles cleanly</done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` -- zero TypeScript errors
2. `ls frontend/src/app/drawings/` -- page.tsx exists
3. `ls frontend/src/hooks/useSvgExport.ts frontend/src/hooks/useDrawingStyle.ts` -- both hooks exist
4. `ls frontend/src/components/drawings/DrawingTabs.tsx frontend/src/components/drawings/ExportMenu.tsx frontend/src/components/drawings/DrawingViewer.tsx` -- all 3 wiring components exist
5. `grep "drawings" frontend/src/components/layout/Sidebar.tsx` -- sidebar link exists
6. `grep "PenTool\|Pencil" frontend/src/components/layout/Sidebar.tsx` -- icon imported
7. `grep "exportBothStyles\|exportSvgAsPng" frontend/src/hooks/useSvgExport.ts` -- export utilities wired
8. `grep "localStorage" frontend/src/hooks/useDrawingStyle.ts` -- persistence implemented
9. `grep "Ver Dibujo" frontend/src/app/simulate/page.tsx` -- simulation-to-drawings link exists
10. `grep "tab=assembly" frontend/src/app/simulate/page.tsx` -- link targets assembly tab with IDs
</verification>

<success_criteria>
- /drawings page is accessible from sidebar "Dibujos Tecnicos" link
- User can select a cartridge from dropdown and see the Cross-Section tab immediately
- User can optionally select a rifle to enable Chamber and Assembly tabs
- User can optionally select a bullet to see it in the cross-section and chamber drawings
- Tab switching works on desktop (horizontal tabs) and mobile (dropdown)
- Style toggle switches between blueprint and modern, persists across reloads
- Export menu offers PNG (600 DPI), SVG, and PDF options
- Export generates both styles (2 files for PNG/SVG, 2-page PDF)
- Assembly tab is always clickable (shows "select rifle" message if no rifle chosen)
- Completeness banner appears for basic/insufficient data tiers
- Simulation results page shows "Ver Dibujo de Conjunto" button that navigates to /drawings?tab=assembly with cartridge/rifle/bullet IDs
- /drawings page reads query params and auto-selects cartridge, rifle, bullet, and tab on mount
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-2d-svg-technical-drawings/12-03-SUMMARY.md`
</output>
