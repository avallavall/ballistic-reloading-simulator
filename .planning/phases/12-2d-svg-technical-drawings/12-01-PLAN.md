---
phase: 12-2d-svg-technical-drawings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/models/rifle.py
  - backend/app/schemas/rifle.py
  - backend/app/db/migrations/versions/010_rifle_chamber_fields.py
  - backend/tests/test_schema_validation.py
  - frontend/src/lib/types.ts
  - frontend/package.json
  - frontend/src/lib/drawings/types.ts
  - frontend/src/lib/drawings/themes.ts
  - frontend/src/lib/drawings/hatching-patterns.ts
  - frontend/src/lib/drawings/dimension-layout.ts
  - frontend/src/lib/drawings/chamber-geometry.ts
  - frontend/src/lib/drawings/assembly-geometry.ts
  - frontend/src/lib/drawings/title-block.ts
  - frontend/src/lib/drawings/export.ts
autonomous: true
requirements: [VIS2-02, VIS2-04, VIS2-05]

must_haves:
  truths:
    - "Rifle model accepts nullable freebore_mm, throat_angle_deg, headspace_mm fields"
    - "Alembic migration 010 adds 3 nullable float columns to rifles table"
    - "Chamber geometry computation returns clearance values from cartridge + rifle dimensions"
    - "Assembly geometry composition combines cartridge + bullet + barrel cylinder coordinates"
    - "Drawing export utilities can serialize SVG to PNG blob at 600 DPI and generate PDF via jsPDF"
    - "Blueprint and modern themes define complete color palettes for all drawing elements"
    - "Dimension layout algorithm produces staggered non-overlapping annotation positions"
  artifacts:
    - path: "backend/app/models/rifle.py"
      provides: "3 nullable Float columns for chamber drawing"
      contains: "freebore_mm"
    - path: "backend/app/db/migrations/versions/010_rifle_chamber_fields.py"
      provides: "Alembic migration adding freebore_mm, throat_angle_deg, headspace_mm"
    - path: "frontend/src/lib/drawings/types.ts"
      provides: "DrawingTheme, DimensionAnnotation, DrawingConfig, ChamberClearances, AssemblyLayout interfaces"
    - path: "frontend/src/lib/drawings/themes.ts"
      provides: "blueprintTheme and modernTheme configuration objects"
    - path: "frontend/src/lib/drawings/chamber-geometry.ts"
      provides: "computeChamberClearances function"
    - path: "frontend/src/lib/drawings/export.ts"
      provides: "exportSvgAsPng, exportSvgAsSvg, exportSvgAsPdf functions"
  key_links:
    - from: "frontend/src/lib/drawings/chamber-geometry.ts"
      to: "frontend/src/lib/types.ts"
      via: "imports Cartridge, Rifle, Bullet types"
      pattern: "import.*Cartridge.*Rifle.*Bullet"
    - from: "frontend/src/lib/drawings/export.ts"
      to: "jspdf"
      via: "npm dependency for PDF generation"
      pattern: "import.*jsPDF"
---

<objective>
Backend schema extension for rifle chamber fields + complete frontend drawing computation library (types, themes, hatching, dimension layout, chamber geometry, assembly geometry, title block, export utilities).

Purpose: Establish all data contracts and computation logic that drawing React components (Plan 02) will consume. By separating computation from rendering, Plan 02 can focus purely on SVG component composition.

Output: Rifle model with 3 new nullable fields + Alembic migration + 8 frontend library files in `lib/drawings/` + jsPDF/svg2pdf.js installed.
</objective>

<execution_context>
@C:/Users/vall-/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/vall-/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-2d-svg-technical-drawings/12-CONTEXT.md
@.planning/phases/12-2d-svg-technical-drawings/12-RESEARCH.md
@.planning/phases/11-foundation-and-data-expansion/11-02-SUMMARY.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From frontend/src/lib/geometry/types.ts:
```typescript
export interface ProfilePoint {
  x: number;  // mm, axial position
  y: number;  // mm, radial position (half-diameter from centerline)
}

export interface GeometryResult {
  svgPath: string;
  profilePoints: ProfilePoint[];
  estimatedFields: string[];
  dataCompleteness: 'full' | 'basic' | 'insufficient';
}

export interface CartridgeDimensions {
  case_length_mm: number | null;
  base_diameter_mm: number | null;
  neck_diameter_mm: number | null;
  bore_diameter_mm: number | null;
  groove_diameter_mm: number | null;
  rim_diameter_mm: number | null;
  shoulder_diameter_mm: number | null;
  shoulder_angle_deg: number | null;
  neck_length_mm: number | null;
  body_length_mm: number | null;
  rim_thickness_mm: number | null;
  case_type: string | null;
}

export interface BulletDimensions {
  diameter_mm: number | null;
  length_mm: number | null;
  weight_grains: number | null;
  bearing_surface_mm: number | null;
  boat_tail_length_mm: number | null;
  meplat_diameter_mm: number | null;
  ogive_type: string | null;
  material: string | null;
  bullet_type: string | null;
  base_type: string | null;
}
```

From frontend/src/lib/types.ts (relevant interfaces):
```typescript
export interface Cartridge {
  id: string; name: string; saami_max_pressure_psi: number;
  case_length_mm: number; overall_length_mm: number;
  bore_diameter_mm: number; groove_diameter_mm: number;
  shoulder_diameter_mm: number | null; neck_diameter_mm: number | null;
  base_diameter_mm: number | null; rim_diameter_mm: number | null;
  shoulder_angle_deg: number | null; neck_length_mm: number | null;
  body_length_mm: number | null; rim_thickness_mm: number | null;
  case_type: string | null;
  // ...quality fields
}

export interface Rifle {
  id: string; name: string; barrel_length_mm: number;
  twist_rate_mm: number; cartridge_id: string;
  chamber_volume_mm3: number; weight_kg: number;
  barrel_condition: string; round_count: number;
  cartridge?: Cartridge;
}

export interface Bullet {
  id: string; name: string; manufacturer: string;
  weight_grains: number; diameter_mm: number;
  length_mm: number | null; bc_g1: number;
  bearing_surface_mm: number | null; boat_tail_length_mm: number | null;
  meplat_diameter_mm: number | null; ogive_type: string | null;
  // ...
}

export interface SimulationResult {
  // ...
  hoop_stress_mpa: number;
  optimal_barrel_times: number[] | null;
  obt_match: boolean;
  barrel_time_ms: number;
  barrel_frequency_hz: number;
  peak_pressure_psi: number;
  // ...
}
```

From backend/app/models/rifle.py:
```python
class Rifle(UUIDMixin, Base):
    __tablename__ = "rifles"
    name = Column(String(100), nullable=False)
    barrel_length_mm = Column(Float, nullable=False)
    twist_rate_mm = Column(Float, nullable=False)
    cartridge_id = Column(UUID(as_uuid=True), ForeignKey("cartridges.id"), nullable=False)
    chamber_volume_mm3 = Column(Float, nullable=False)
    weight_kg = Column(Float, nullable=False, default=3.5)
    barrel_condition = Column(String(20), nullable=False, default="new")
    round_count = Column(Integer, nullable=False, default=0)
    cartridge = relationship("Cartridge", lazy="selectin")
```

From backend/app/schemas/rifle.py:
```python
class RifleCreate(BaseModel):
    name: str = Field(min_length=1, max_length=100)
    barrel_length_mm: float = Field(gt=0, le=2000)
    twist_rate_mm: float = Field(gt=0, le=1000)
    cartridge_id: uuid.UUID
    chamber_volume_mm3: float = Field(gt=0, le=50_000)
    weight_kg: float = Field(default=3.5, gt=0, le=30)
    barrel_condition: str = Field(default="new", max_length=20)
    round_count: int = Field(default=0, ge=0, le=100_000)

class RifleUpdate(BaseModel):
    # All optional nullable fields (same as Create but with None defaults)

class RifleResponse(BaseModel):
    id: uuid.UUID
    # ... all fields ...
    model_config = {"from_attributes": True}
```

Existing migration numbering: 001-009 (next is 010).
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Rifle model with chamber drawing fields + migration + schema + tests</name>
  <files>
    backend/app/models/rifle.py
    backend/app/schemas/rifle.py
    backend/app/db/migrations/versions/010_rifle_chamber_fields.py
    backend/tests/test_schema_validation.py
    frontend/src/lib/types.ts
  </files>
  <action>
1. **backend/app/models/rifle.py** -- Add 3 nullable Float columns to the Rifle model:
   ```python
   freebore_mm = Column(Float, nullable=True)       # Unrifled lead before rifling
   throat_angle_deg = Column(Float, nullable=True)   # Angle of leade/throat
   headspace_mm = Column(Float, nullable=True)       # How much case floats in chamber
   ```

2. **backend/app/schemas/rifle.py** -- Add the 3 fields to all schemas:
   - `RifleCreate`: Add optional fields with physical limits:
     - `freebore_mm: float | None = Field(None, ge=0, le=20, description="Freebore length (mm), typical 0.05-5")`
     - `throat_angle_deg: float | None = Field(None, gt=0, le=10, description="Throat/leade angle (deg), typical 1-3")`
     - `headspace_mm: float | None = Field(None, ge=0, le=5, description="Headspace gap (mm), typical 0.05-0.15")`
   - `RifleUpdate`: Same 3 fields, all `| None` with `None` default
   - `RifleResponse`: Same 3 fields as `float | None`

3. **Migration 010** -- Create `backend/app/db/migrations/versions/010_rifle_chamber_fields.py`:
   - Follow existing migration pattern (see 009_schema_extensions.py)
   - `upgrade()`: Add 3 nullable Float columns to `rifles` table using `op.add_column`
   - `downgrade()`: Drop the 3 columns
   - Revision ID: generate a random hex string (e.g., `'a1b2c3d4e5f6'`)
   - Down revision: the revision ID from 009_schema_extensions.py (read it to get the correct value)

4. **backend/tests/test_schema_validation.py** -- Add tests to the existing `TestRifleValidation` class:
   - `test_rifle_with_chamber_fields_passes`: Create RifleCreate with all 3 new fields set to valid values, verify no validation error
   - `test_rifle_freebore_too_large`: freebore_mm=25 should fail (le=20)
   - `test_rifle_throat_angle_too_large`: throat_angle_deg=15 should fail (le=10)
   - `test_rifle_headspace_too_large`: headspace_mm=10 should fail (le=5)
   - `test_rifle_chamber_fields_nullable`: All 3 fields omitted should be valid (they default to None)

5. **frontend/src/lib/types.ts** -- Add the 3 fields to the `Rifle` interface:
   ```typescript
   freebore_mm: number | null;
   throat_angle_deg: number | null;
   headspace_mm: number | null;
   ```
   Also add them as optional to `RifleCreate`:
   ```typescript
   freebore_mm?: number | null;
   throat_angle_deg?: number | null;
   headspace_mm?: number | null;
   ```
  </action>
  <verify>
    <automated>cd backend && python -m pytest tests/test_schema_validation.py::TestRifleValidation -x -v</automated>
  </verify>
  <done>Rifle model has 3 nullable chamber fields, migration 010 exists, schemas validate physical limits, 5 new tests pass, frontend Rifle type updated</done>
</task>

<task type="auto">
  <name>Task 2: Create complete frontend drawing computation library + install npm dependencies</name>
  <files>
    frontend/package.json
    frontend/src/lib/drawings/types.ts
    frontend/src/lib/drawings/themes.ts
    frontend/src/lib/drawings/hatching-patterns.ts
    frontend/src/lib/drawings/dimension-layout.ts
    frontend/src/lib/drawings/chamber-geometry.ts
    frontend/src/lib/drawings/assembly-geometry.ts
    frontend/src/lib/drawings/title-block.ts
    frontend/src/lib/drawings/export.ts
  </files>
  <action>
1. **Install npm dependencies:**
   ```bash
   cd frontend && npm install jspdf@^4.2.0 svg2pdf.js@^2.5.0
   ```

2. **frontend/src/lib/drawings/types.ts** -- Central type definitions:
   ```typescript
   // DrawingTheme interface with all color/font properties:
   //   name, background, outline, hiddenEdge, dimColor, textColor, hatchColor,
   //   caseFill, copperFill, leadColor, powderFill, steelFill,
   //   titleBlockBg, titleBlockBorder, fontFamily, dimFontSize, titleFontSize
   //
   // DimensionAnnotation: { x1, y1, x2, y2, value_mm, label, side, offset_tier }
   //   - side: 'top' | 'bottom' | 'left' | 'right'
   //   - offset_tier: number (stagger level: 1, 2, 3 for non-overlapping layout)
   //
   // DrawingConfig: { width, height, padding_mm, style, showEstimated }
   //
   // ChamberClearances: { headspace_gap_mm, neck_clearance_mm, body_clearance_mm,
   //   freebore_mm, throat_angle_deg, rifling_engagement_mm,
   //   estimated_fields: string[] }
   //
   // AssemblyLayout: { cartridge_x, cartridge_scale, barrel_start_x, barrel_end_x,
   //   barrel_outer_r, barrel_bore_r, bullet_tip_x, total_width_mm, total_height_mm }
   //
   // TitleBlockData: { name, drawingType, scale, date, style }
   //
   // ExportFormat: 'png' | 'svg' | 'pdf'
   //
   // DrawingTab: 'cross-section' | 'chamber' | 'assembly'
   ```

3. **frontend/src/lib/drawings/themes.ts** -- Two theme objects:
   - `blueprintTheme`: Deep navy (#1a1f3a) background, white-blue (#e0e8ff) lines, muted blue (#7088cc) hatching/dimensions, monospace font (Courier New), no fills for case/copper/steel (outline only with hatching)
   - `modernTheme`: White (#ffffff) background, dark gray (#333333) outlines, gold/amber (#d4a94c) brass case fill, copper tone (#b87333) copper jacket, dark gray (#4a4a4a) lead, medium gray (#a0a0a0) steel, system-ui font stack
   - Both themes share `dimFontSize: 2.0` and `titleFontSize: 3.0` (SVG user units = mm)

4. **frontend/src/lib/drawings/hatching-patterns.ts** -- Pure data functions returning SVG pattern definitions:
   - `getHatchPatternDefs(theme: DrawingTheme): HatchPatternDef[]` -- Returns array of pattern objects: `{ id, width, height, patternUnits, patternTransform?, elements[] }`
   - Patterns: `hatch-metal` (45-degree diagonal lines, 6x6, strokeWidth 0.25), `hatch-brass` (45-degree lines, 5x5), `hatch-powder` (dot pattern, 4x4, circle r=0.5), `fill-lead` (solid fill), `hatch-copper` (30-degree diagonal, 5x5)
   - Each pattern element is typed: `{ type: 'line'|'circle'|'rect', attrs: Record<string, string|number> }`
   - Use `patternUnits="userSpaceOnUse"` for all patterns (critical for correct scaling with transforms)

5. **frontend/src/lib/drawings/dimension-layout.ts** -- Smart stagger algorithm:
   - `layoutDimensions(annotations: DimensionAnnotation[], drawingBounds: { width: number, height: number }): DimensionAnnotation[]`
   - Algorithm:
     a. Separate annotations by `side` (top, bottom, left, right)
     b. Sort each group by position (x for top/bottom, y for left/right)
     c. For each group, assign `offset_tier` using greedy interval scheduling:
        - Estimate text width from label length * dimFontSize * 0.6 (approximate char width)
        - Track occupied intervals per tier
        - Place each annotation in the lowest tier where its interval doesn't overlap any existing
        - Tier spacing: 4mm between tiers
     d. Return the annotations with `offset_tier` populated
   - Export constant `TIER_SPACING_MM = 4`
   - Export constant `BASE_OFFSET_MM = 6` (first tier distance from outline)

6. **frontend/src/lib/drawings/chamber-geometry.ts** -- Chamber clearance computation:
   - `computeChamberClearances(cartridge: Cartridge, bullet: Bullet | null, rifle: { freebore_mm?: number | null, throat_angle_deg?: number | null, headspace_mm?: number | null }): ChamberClearances`
   - Uses rifle overrides when present; derives from SAAMI tolerances when null:
     - `headspace_gap_mm`: rifle.headspace_mm ?? 0.05 (SAAMI min for rimless)
     - `neck_clearance_mm`: cartridge.neck_diameter_mm * 0.005 ?? 0.05 (~0.5% radial)
     - `body_clearance_mm`: cartridge.base_diameter_mm * 0.003 ?? 0.04 (~0.3% radial)
     - `freebore_mm`: rifle.freebore_mm ?? estimateFreebore(cartridge)
     - `throat_angle_deg`: rifle.throat_angle_deg ?? 1.5 (SAAMI standard)
     - `rifling_engagement_mm`: computed from bullet length and bearing surface
   - `estimateFreebore(cartridge: Cartridge): number` -- bore-diameter-aware:
     - bore < 7mm: 1.0mm, bore 7-8mm: 2.0mm, bore > 8mm: 3.0mm
   - Track estimated fields in returned `estimated_fields` array
   - `computeChamberProfile(cartridge: Cartridge, clearances: ChamberClearances): ProfilePoint[]`
     -- Returns profile points of the chamber outline (cartridge exterior + clearance gaps)

7. **frontend/src/lib/drawings/assembly-geometry.ts** -- Assembly composition:
   - `computeAssemblyLayout(cartridge: Cartridge, bullet: Bullet | null, rifle: Rifle): AssemblyLayout`
   - Computes positions for: cartridge origin, barrel cylinder (start at chamber end, extends to barrel_length_mm), bullet position (seated in case mouth)
   - Barrel represented as straight cylinder: outer radius = groove_diameter_mm/2 + 3mm (wall thickness), bore = bore_diameter_mm/2
   - Returns total drawing dimensions for viewBox computation
   - `getObtNodePositions(barrelLength: number, simulation: SimulationResult): { x: number, label: string, isNode: boolean }[]`
     -- Converts optimal_barrel_times to x positions along barrel using barrel_time_ms ratio
   - `getStressZone(simulation: SimulationResult, saamiMaxPsi: number): { severity: 'safe' | 'caution' | 'danger', fraction: number }`
     -- Computes pressure fraction for stress overlay coloring

8. **frontend/src/lib/drawings/title-block.ts** -- Title block data:
   - `computeTitleBlock(name: string, drawingType: string, scale: number, style: 'blueprint' | 'modern'): TitleBlockData`
   - Returns data for rendering: name, type label, scale text (e.g., "Scale: 8:1"), date (current), style name
   - Title block dimensions: 60mm wide x 15mm tall (in drawing coordinates)
   - Export constants: `TITLE_BLOCK_WIDTH = 60`, `TITLE_BLOCK_HEIGHT = 15`

9. **frontend/src/lib/drawings/export.ts** -- Export utilities:
   - `exportSvgAsPng(svgElement: SVGSVGElement, filename: string, dpi?: number): Promise<void>`
     - Default DPI: 600
     - Steps: XMLSerializer -> Blob -> Image -> Canvas (scaled to DPI) -> toBlob -> saveAs
     - All styles must be inline SVG attributes (not CSS classes) for serialization to work
     - Uses `file-saver` saveAs (already installed)
   - `exportSvgAsSvg(svgElement: SVGSVGElement, filename: string): void`
     - XMLSerializer -> Blob -> saveAs as .svg
   - `exportSvgAsPdf(svgElement: SVGSVGElement, filename: string): Promise<void>`
     - Import jsPDF and svg2pdf.js
     - Create PDF with matching aspect ratio, landscape/portrait auto-detect
     - `await doc.svg(svgElement, { x: 0, y: 0, width, height })`
     - `doc.save(filename + '.pdf')`
   - `exportBothStyles(currentSvg: SVGSVGElement, otherStyleSvg: SVGSVGElement, basename: string, format: ExportFormat): Promise<void>`
     - For PNG/SVG: triggers two separate downloads with style suffix in filename
     - For PDF: creates single 2-page PDF (page 1 = blueprint, page 2 = modern)
  </action>
  <verify>
    <automated>cd frontend && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>8 files exist in frontend/src/lib/drawings/, jsPDF + svg2pdf.js installed, all TypeScript compiles cleanly, drawing computation functions are pure (no React imports)</done>
</task>

</tasks>

<verification>
1. `cd backend && python -m pytest tests/test_schema_validation.py::TestRifleValidation -x -v` -- all rifle tests pass
2. `cd frontend && npx tsc --noEmit` -- zero TypeScript errors
3. `ls frontend/src/lib/drawings/` -- 8 .ts files exist (types, themes, hatching-patterns, dimension-layout, chamber-geometry, assembly-geometry, title-block, export)
4. `grep -l "freebore_mm" backend/app/models/rifle.py backend/app/schemas/rifle.py frontend/src/lib/types.ts` -- field appears in all 3 files
5. `grep "jspdf\|svg2pdf" frontend/package.json` -- both dependencies listed
</verification>

<success_criteria>
- Rifle model has 3 nullable chamber fields with Alembic migration
- Schema validates physical limits on new fields (5 new tests pass)
- Frontend Rifle type includes 3 new fields
- 8 drawing library files compile without errors
- jsPDF and svg2pdf.js are installed
- All drawing computation is pure TypeScript (no React/Three.js imports in lib/drawings/)
</success_criteria>

<output>
After completion, create `.planning/phases/12-2d-svg-technical-drawings/12-01-SUMMARY.md`
</output>
