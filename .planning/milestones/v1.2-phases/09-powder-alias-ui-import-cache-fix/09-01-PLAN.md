---
phase: 09-powder-alias-ui-import-cache-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/api/powders.py
  - backend/app/schemas/powder.py
  - backend/tests/test_import_pipelines.py
autonomous: true
requirements: [PWD-05]

must_haves:
  truths:
    - "GRT import endpoint applies alias_group from powder_aliases.json to newly created and updated powders using case-insensitive name matching"
    - "GRT import response includes aliases_linked count showing how many powders got alias_group set"
    - "Existing alias endpoint GET /powders/{id}/aliases continues to work unchanged"
  artifacts:
    - path: "backend/app/api/powders.py"
      provides: "Alias mapping logic in import_grt endpoint"
      contains: "_load_alias_map"
    - path: "backend/app/schemas/powder.py"
      provides: "aliases_linked field on GrtImportResult"
      contains: "aliases_linked"
    - path: "backend/tests/test_import_pipelines.py"
      provides: "Tests for alias application during GRT import"
      contains: "test_grt_import_applies_alias"
  key_links:
    - from: "backend/app/api/powders.py"
      to: "backend/app/seed/fixtures/powder_aliases.json"
      via: "_load_alias_map reads JSON file"
      pattern: "_load_alias_map"
    - from: "backend/app/api/powders.py"
      to: "backend/app/schemas/powder.py"
      via: "GrtImportResult with aliases_linked"
      pattern: "aliases_linked"
---

<objective>
Apply powder alias mappings during GRT import and expose aliases_linked count in the import response.

Purpose: Complete the backend side of PWD-05 -- GRT-imported powders get their alias_group set automatically based on powder_aliases.json, and the import response tells the frontend how many aliases were linked.
Output: Modified import_grt endpoint with alias mapping, updated GrtImportResult schema, 3+ new tests.
</objective>

<execution_context>
@C:/Users/vall-/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/vall-/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-powder-alias-ui-import-cache-fix/09-RESEARCH.md
@.planning/phases/05-import-pipelines-and-fixture-data/05-03-SUMMARY.md
@backend/app/api/powders.py
@backend/app/schemas/powder.py
@backend/app/seed/fixtures/powder_aliases.json
@backend/app/seed/initial_data.py
@backend/tests/test_import_pipelines.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add alias mapping to GRT import endpoint and update schema</name>
  <files>backend/app/api/powders.py, backend/app/schemas/powder.py</files>
  <action>
1. In `backend/app/schemas/powder.py`, add `aliases_linked: int = 0` field to the `GrtImportResult` class.

2. In `backend/app/api/powders.py`, add a `_load_alias_map()` helper function near the top of the file (after imports):
   - Reads `backend/app/seed/fixtures/powder_aliases.json` using `Path(__file__).parent.parent / "seed" / "fixtures" / "powder_aliases.json"`
   - Inverts the JSON structure: for each group_name -> list of names, create a dict mapping `name.lower() -> group_name`
   - Returns `dict[str, str]` (lowercase powder name -> alias group name)
   - If file doesn't exist, return empty dict (graceful fallback)
   - Cache the result at module level (load once, reuse) since the file is static

3. In the `import_grt` endpoint function (the POST handler), after the main import loop that creates/updates powders and before the return statement:
   - Call `_load_alias_map()` to get the name-to-group mapping
   - Iterate over all created + updated powder objects
   - For each powder, look up `powder.name.lower()` in the alias map
   - If found, set `powder.alias_group = group_name` and increment an `aliases_linked` counter
   - After the loop, call `await db.commit()` (or piggyback on the existing commit if it follows)
   - Include `aliases_linked=aliases_linked` in the GrtImportResult return

Note: The existing seed loader in `initial_data.py` already applies aliases during seed loading. This task adds the same capability to the runtime GRT import endpoint so that user-initiated imports also get aliases.

Use case-insensitive matching (`.lower()`) per research pitfall #4 to handle GRT naming inconsistencies.
  </action>
  <verify>
    <automated>cd backend && python -m pytest tests/test_import_pipelines.py -x -v 2>&1 | tail -20</automated>
    <manual>Existing import tests still pass. Schema change is backward-compatible (default=0).</manual>
  </verify>
  <done>GrtImportResult schema has aliases_linked field. import_grt endpoint applies alias_group from powder_aliases.json to imported powders and returns the count. Existing tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for alias application during GRT import</name>
  <files>backend/tests/test_import_pipelines.py</files>
  <action>
Add 3 new tests to `backend/tests/test_import_pipelines.py`:

1. `test_grt_import_applies_alias_group` - Import a GRT XML containing a powder whose name appears in powder_aliases.json (e.g., "Hodgdon Varget" or similar known alias name). Verify the created powder has `alias_group` set to the correct group name. Verify the response `aliases_linked >= 1`.

2. `test_grt_import_no_alias_for_unknown_powder` - Import a GRT XML with a powder name NOT in any alias group. Verify the created powder has `alias_group = None`. Verify `aliases_linked == 0` in response.

3. `test_grt_import_alias_case_insensitive` - Import a GRT XML with a powder name that matches an alias entry but with different casing (e.g., "hodgdon varget" vs "Hodgdon Varget"). Verify alias_group is still applied, confirming case-insensitive matching.

For test XML generation, follow the pattern already used in existing GRT import tests in the same file (creating minimal valid GRT XML strings with the required powder fields).

If the existing test fixtures use specific powder names, reuse those names or check powder_aliases.json for actual alias group entries to use real names.
  </action>
  <verify>
    <automated>cd backend && python -m pytest tests/test_import_pipelines.py -x -v -k "alias" 2>&1 | tail -20</automated>
    <manual>All 3 new tests pass. Existing tests remain green.</manual>
  </verify>
  <done>3 new tests verify alias application during GRT import: correct group assignment, no-match case, and case-insensitive matching. Full test suite passes.</done>
</task>

</tasks>

<verification>
1. `cd backend && python -m pytest tests/test_import_pipelines.py -x -v` -- all tests pass including 3 new alias tests
2. `cd backend && python -m pytest tests/ -x --tb=short` -- full test suite passes (no regressions)
3. GrtImportResult schema includes `aliases_linked: int` field with default 0
</verification>

<success_criteria>
- GRT import endpoint applies alias_group to imported powders based on powder_aliases.json
- Case-insensitive name matching for alias lookup
- GrtImportResult response includes aliases_linked count
- 3+ new tests cover alias application scenarios
- Full test suite passes with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/09-powder-alias-ui-import-cache-fix/09-01-SUMMARY.md`
</output>
