---
phase: 09-powder-alias-ui-import-cache-fix
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - frontend/src/components/ui/AliasBadge.tsx
  - frontend/src/components/ui/Toast.tsx
  - frontend/src/lib/api.ts
  - frontend/src/lib/types.ts
  - frontend/src/app/powders/page.tsx
autonomous: true
requirements: [PWD-05]

must_haves:
  truths:
    - "Powder list page shows a blue alias badge on powders that have an alias_group set"
    - "Hovering the alias badge reveals a tooltip listing all linked powder names with their manufacturer"
    - "After GRT import (both normal and overwrite), a toast notification shows import result with aliases_linked count"
    - "After GRT import with overwrite, the powder list auto-refreshes (no stale data)"
    - "getPowderAliases() function exists in api.ts and fetches GET /powders/{id}/aliases"
  artifacts:
    - path: "frontend/src/components/ui/AliasBadge.tsx"
      provides: "Alias badge with on-hover tooltip showing linked powder names"
      contains: "AliasBadge"
    - path: "frontend/src/components/ui/Toast.tsx"
      provides: "Success toast type with green styling"
      contains: "success"
    - path: "frontend/src/lib/api.ts"
      provides: "getPowderAliases API function"
      contains: "getPowderAliases"
    - path: "frontend/src/lib/types.ts"
      provides: "aliases_linked field on GrtImportResult"
      contains: "aliases_linked"
    - path: "frontend/src/app/powders/page.tsx"
      provides: "AliasBadge in powder table, toast on import, cache invalidation fix"
      contains: "AliasBadge"
  key_links:
    - from: "frontend/src/components/ui/AliasBadge.tsx"
      to: "/api/v1/powders/{id}/aliases"
      via: "getPowderAliases() called on hover"
      pattern: "getPowderAliases"
    - from: "frontend/src/app/powders/page.tsx"
      to: "frontend/src/components/ui/AliasBadge.tsx"
      via: "Rendered in powder table rows when alias_group is set"
      pattern: "AliasBadge"
    - from: "frontend/src/app/powders/page.tsx"
      to: "queryClient.invalidateQueries"
      via: "Called after handleOverwriteDuplicates success"
      pattern: "invalidateQueries.*powders"
---

<objective>
Create AliasBadge UI component, fix overwrite cache invalidation, and add toast feedback for GRT import.

Purpose: Complete the frontend side of PWD-05 -- users see alias badges on linked powders, get toast feedback after import, and the overwrite flow correctly refreshes the list.
Output: New AliasBadge component, updated Toast with success type, updated powder page with badge + toast + cache fix.
</objective>

<execution_context>
@C:/Users/vall-/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/vall-/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-powder-alias-ui-import-cache-fix/09-RESEARCH.md
@.planning/phases/09-powder-alias-ui-import-cache-fix/09-01-SUMMARY.md
@.planning/phases/06-frontend-integration/06-01-SUMMARY.md
@frontend/src/components/ui/QualityBadge.tsx
@frontend/src/components/ui/Toast.tsx
@frontend/src/components/ui/Badge.tsx
@frontend/src/lib/api.ts
@frontend/src/lib/types.ts
@frontend/src/app/powders/page.tsx
@frontend/src/hooks/usePowders.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AliasBadge component, extend Toast with success type, add getPowderAliases API function</name>
  <files>frontend/src/components/ui/AliasBadge.tsx, frontend/src/components/ui/Toast.tsx, frontend/src/lib/api.ts, frontend/src/lib/types.ts</files>
  <action>
1. **frontend/src/lib/types.ts** -- Add `aliases_linked` to the `GrtImportResult` interface:
   - Add `aliases_linked: number;` field to match the updated backend schema.

2. **frontend/src/lib/api.ts** -- Add `getPowderAliases()` function:
   ```typescript
   export async function getPowderAliases(powderId: string): Promise<Powder[]> {
     return request<Powder[]>(`/powders/${powderId}/aliases`);
   }
   ```
   Place it near the other powder-related functions.

3. **frontend/src/components/ui/Toast.tsx** -- Add 'success' type:
   - Change `type ToastType = 'error' | 'info';` to `type ToastType = 'error' | 'info' | 'success';`
   - Add to BORDER_COLORS: `success: 'border-green-500/60 text-green-300'`

4. **frontend/src/components/ui/AliasBadge.tsx** -- Create new component following QualityBadge CSS-tooltip pattern:
   - Props: `powderId: string` and `aliasGroup: string`
   - Uses `useState` for `hovered` (boolean) and `aliases` (array or null)
   - On first hover (`onMouseEnter`), fetches aliases via `getPowderAliases(powderId)` and caches in state
   - Badge styling: blue/neutral palette per user decision -- use `bg-blue-500/10 text-blue-400 border border-blue-500/30` on the badge element
   - Badge text: show `aliasGroup` label initially; once aliases loaded, show count like "3 aliases" (or "2 aliases" etc.)
   - Tooltip: use Tailwind named group `group/alias` to avoid conflicts with parent group styles
   - Tooltip positioning: absolute, bottom-full, centered like QualityBadge but with `whitespace-pre-line` (not `whitespace-nowrap`) and `max-w-xs` since content is multi-line
   - Tooltip content: each alias on its own line, format "Name (Manufacturer)" per user decision
   - While loading: show "Cargando..." in tooltip
   - On fetch error: show empty tooltip or "Sin datos" gracefully
   - Use `group-hover/alias:opacity-100` for tooltip visibility

Key styling decisions per CONTEXT.md locked decisions:
- Small badge next to powder name, count format: "3 aliases"
- Neutral/blue color palette distinct from quality badges
- Only shown on powders with alias_group set (parent controls rendering)
- Tooltip shows all linked powder names with manufacturer
- Format: one powder per line as "Name (Manufacturer)"
  </action>
  <verify>
    <automated>cd frontend && npx tsc --noEmit 2>&1 | tail -20</automated>
    <manual>TypeScript compiles. AliasBadge.tsx, Toast.tsx, api.ts, types.ts all updated.</manual>
  </verify>
  <done>AliasBadge component created with blue badge + CSS hover tooltip fetching aliases on demand. Toast supports 'success' type with green styling. getPowderAliases() function exists in api.ts. GrtImportResult type includes aliases_linked.</done>
</task>

<task type="auto">
  <name>Task 2: Wire AliasBadge into powder list, fix overwrite cache invalidation, add toast feedback</name>
  <files>frontend/src/app/powders/page.tsx</files>
  <action>
Modify `frontend/src/app/powders/page.tsx` with three changes:

**A. Add AliasBadge to powder table rows:**
- Import `AliasBadge` from `@/components/ui/AliasBadge`
- In the table body where each powder row renders the name cell, add AliasBadge AFTER the QualityBadge (per user decision: "Badge appears in the same row as the powder name, after the QualityBadge")
- Only render AliasBadge when `powder.alias_group` is truthy (non-null, non-empty):
  ```tsx
  {powder.alias_group && (
    <AliasBadge powderId={powder.id} aliasGroup={powder.alias_group} />
  )}
  ```
- Ensure the name cell has `flex items-center gap-2` to lay out name + QualityBadge + AliasBadge inline

**B. Fix handleOverwriteDuplicates cache invalidation:**
- Import `useQueryClient` from `@tanstack/react-query` (if not already imported)
- Get `queryClient` via `const queryClient = useQueryClient()` at the component level
- In `handleOverwriteDuplicates`, after the successful `importGrtPowders()` call and before/after `setImportResult(...)`, add:
  ```typescript
  queryClient.invalidateQueries({ queryKey: ['powders'] });
  ```
- Add `queryClient` to the useCallback dependency array

**C. Add toast notifications for import results:**
- Import `useToast` from `@/components/ui/Toast` (if not already present)
- Destructure `const { showToast, ToastContainer } = useToast();`
- Render `<ToastContainer />` in the component's JSX return (typically near the end, inside the outermost fragment/div)
- After successful normal import (in `handleImportFile`'s `onSuccess` callback), add:
  ```typescript
  showToast(
    `Importados ${data.created.length} polvoras (${data.aliases_linked ?? 0} aliases vinculados, ${data.skipped} omitidos)`,
    'success'
  );
  ```
- After successful overwrite import (in `handleOverwriteDuplicates`'s success path), add:
  ```typescript
  showToast(
    `Actualizados ${data.updated?.length ?? 0} polvoras (${data.aliases_linked ?? 0} aliases vinculados)`,
    'success'
  );
  ```
- Use `data.aliases_linked ?? 0` with nullish coalescing for backward compatibility in case the backend hasn't been updated yet

Toast message format follows CONTEXT.md locked decisions:
- Normal: "Importados X polvoras (Y aliases vinculados, Z omitidos)"
- Overwrite: "Actualizados X polvoras (Y aliases vinculados)"
  </action>
  <verify>
    <automated>cd frontend && npx tsc --noEmit 2>&1 | tail -20</automated>
    <manual>Open /powders page. Powders with alias_group show blue alias badge. Hovering badge shows tooltip with linked names. After GRT import, toast appears with alias count. After overwrite, list refreshes.</manual>
  </verify>
  <done>Powder list page shows AliasBadge on aliased powders. handleOverwriteDuplicates invalidates query cache after import. Toast notifications show import results with aliases_linked count. TypeScript compiles cleanly.</done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` -- zero TypeScript errors
2. AliasBadge.tsx exists and exports AliasBadge component
3. Toast.tsx supports 'success' type with green styling
4. getPowderAliases function exists in api.ts
5. GrtImportResult in types.ts includes aliases_linked field
6. powders/page.tsx renders AliasBadge when alias_group is set
7. powders/page.tsx calls queryClient.invalidateQueries after overwrite import
8. powders/page.tsx shows toast after both normal and overwrite import
</verification>

<success_criteria>
- Powder list shows blue alias badge on powders with alias_group (after QualityBadge)
- Hovering alias badge shows tooltip with linked powder names and manufacturers
- Toast notification appears after GRT import showing aliases_linked count
- Overwrite import flow invalidates TanStack Query cache so list auto-refreshes
- TypeScript compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-powder-alias-ui-import-cache-fix/09-02-SUMMARY.md`
</output>
