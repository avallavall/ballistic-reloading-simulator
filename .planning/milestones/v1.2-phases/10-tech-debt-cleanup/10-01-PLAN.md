---
phase: 10-tech-debt-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/db/migrations/versions/008_fix_cartridge_caliber_backfill.py
autonomous: true
requirements:
  - TD-01

must_haves:
  truths:
    - "After running migration 008, all cartridges have caliber_family derived from groove_diameter_mm, not bore_diameter_mm"
    - "All 11 caliber families (.224 through .510) are covered in the migration backfill"
    - "Migration has a valid downgrade path that reverts to bore_diameter_mm-based backfill"
  artifacts:
    - path: "backend/app/db/migrations/versions/008_fix_cartridge_caliber_backfill.py"
      provides: "Corrective migration for cartridge caliber_family backfill"
      contains: "groove_diameter_mm"
  key_links:
    - from: "backend/app/db/migrations/versions/008_fix_cartridge_caliber_backfill.py"
      to: "backend/app/services/search.py"
      via: "CALIBER_FAMILIES diameter ranges must match"
      pattern: "groove_diameter_mm BETWEEN"
---

<objective>
Fix cartridge caliber_family migration backfill to use groove_diameter_mm instead of bore_diameter_mm, matching the live endpoint logic in cartridges.py and search.py derive_caliber_family().

Purpose: Migration 006 backfilled caliber_family using bore_diameter_mm, but the live create/update endpoints use groove_diameter_mm via derive_caliber_family(). This creates mismatches for seeded/existing records vs newly created records.
Output: New Alembic migration 008 that clears and re-derives all cartridge caliber_family values from groove_diameter_mm using all 11 caliber family ranges.
</objective>

<execution_context>
@C:/Users/vall-/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/vall-/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/app/services/search.py
@backend/app/db/migrations/versions/006_search_and_pagination.py
@backend/app/api/cartridges.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create corrective Alembic migration for cartridge caliber_family backfill</name>
  <files>backend/app/db/migrations/versions/008_fix_cartridge_caliber_backfill.py</files>
  <action>
Create a new Alembic migration file `008_fix_cartridge_caliber_backfill.py` with:

1. First, verify current migration head by reading `backend/app/db/migrations/versions/` directory to confirm `007_import_pipelines` is the latest revision.

2. Create the migration with:
   - `revision = "008_fix_caliber_backfill"`
   - `down_revision = "007_import_pipelines"`
   - Docstring: "Fix cartridge caliber_family backfill to use groove_diameter_mm"

3. In `upgrade()`:
   - First: `UPDATE cartridges SET caliber_family = NULL` (clear all existing values)
   - Then 11 UPDATE statements using groove_diameter_mm ranges matching search.py CALIBER_FAMILIES:
     - '.224': groove_diameter_mm BETWEEN 5.5 AND 5.8
     - '.243': groove_diameter_mm BETWEEN 6.1 AND 6.3
     - '.264': groove_diameter_mm BETWEEN 6.5 AND 6.8
     - '.284': groove_diameter_mm BETWEEN 7.0 AND 7.3
     - '.308': groove_diameter_mm BETWEEN 7.7 AND 7.9
     - '.338': groove_diameter_mm BETWEEN 8.5 AND 8.7
     - '.375': groove_diameter_mm BETWEEN 9.5 AND 9.6
     - '.408': groove_diameter_mm BETWEEN 10.3 AND 10.4
     - '.416': groove_diameter_mm BETWEEN 10.5 AND 10.7
     - '.458': groove_diameter_mm BETWEEN 11.5 AND 11.7
     - '.510': groove_diameter_mm BETWEEN 12.9 AND 13.1

4. In `downgrade()`:
   - Clear all: `UPDATE cartridges SET caliber_family = NULL`
   - Re-derive using bore_diameter_mm with the same ranges (original 006 behavior)

5. Cross-reference the 11 caliber families with CALIBER_FAMILIES dict in `backend/app/services/search.py` to verify diameter ranges match exactly. Read that file first to confirm ranges.

Important: Use `from alembic import op` only. No need for `sa` import since this is a data-only migration (no DDL).
  </action>
  <verify>
    <automated>cd C:/Users/vall-/Desktop/projectes/simulador_balistica/backend && python -c "import ast; tree = ast.parse(open('app/db/migrations/versions/008_fix_cartridge_caliber_backfill.py').read()); funcs = [n.name for n in ast.walk(tree) if isinstance(n, ast.FunctionDef)]; assert 'upgrade' in funcs and 'downgrade' in funcs; content = open('app/db/migrations/versions/008_fix_cartridge_caliber_backfill.py').read(); assert 'groove_diameter_mm' in content; assert content.count('caliber_family') >= 22; print('Migration structure OK: upgrade + downgrade present, groove_diameter_mm used, all 11 families covered')"</automated>
    <manual>Review migration SQL statements match search.py CALIBER_FAMILIES ranges</manual>
  </verify>
  <done>Migration 008 exists with upgrade/downgrade functions, uses groove_diameter_mm for all 11 caliber family ranges, and has correct revision chain (down_revision = 007_import_pipelines)</done>
</task>

</tasks>

<verification>
- Migration file parses as valid Python
- upgrade() clears and re-derives from groove_diameter_mm (not bore_diameter_mm)
- All 11 caliber families from search.py CALIBER_FAMILIES are present
- downgrade() reverts to bore_diameter_mm-based ranges
- Revision chain: 007_import_pipelines -> 008_fix_caliber_backfill
</verification>

<success_criteria>
Migration 008 exists and correctly re-derives cartridge caliber_family from groove_diameter_mm for all 11 caliber families, matching live endpoint logic.
</success_criteria>

<output>
After completion, create `.planning/phases/10-tech-debt-cleanup/10-01-SUMMARY.md`
</output>
