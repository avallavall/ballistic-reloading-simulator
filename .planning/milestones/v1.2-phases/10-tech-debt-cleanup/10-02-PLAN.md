---
phase: 10-tech-debt-cleanup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/lib/utils.ts
  - frontend/src/components/forms/SimulationForm.tsx
  - frontend/src/app/bullets/page.tsx
  - frontend/src/app/cartridges/page.tsx
  - frontend/src/app/powders/page.tsx
  - frontend/src/app/rifles/page.tsx
  - frontend/src/app/loads/page.tsx
autonomous: true
requirements:
  - TD-02
  - TD-03
  - TD-04

must_haves:
  truths:
    - "Powder and bullet picker modals in SimulationForm show QualityBadge (color dot + numeric score + hover tooltip) inline on each row"
    - "Bullets table displays model_number, bullet_type, base_type, and length_mm columns with correct column order"
    - "Cartridges table displays parent_cartridge_name, case_capacity_grains, case_length_mm, max_oal_mm, neck_diameter_mm, bore_diameter_mm, groove_diameter_mm columns"
    - "All null/missing values across all component tables display as em dash in muted gray"
    - "bullet_type and base_type render as small colored badge pills when present, em dash when null"
  artifacts:
    - path: "frontend/src/lib/utils.ts"
      provides: "displayValue() helper for null display convention"
      contains: "displayValue"
    - path: "frontend/src/components/forms/SimulationForm.tsx"
      provides: "QualityBadge in picker renderItem callbacks"
      contains: "QualityBadge"
    - path: "frontend/src/app/bullets/page.tsx"
      provides: "Extended bullets table with 4 new columns"
      contains: "model_number"
    - path: "frontend/src/app/cartridges/page.tsx"
      provides: "Extended cartridges table with 7 new columns"
      contains: "parent_cartridge_name"
  key_links:
    - from: "frontend/src/components/forms/SimulationForm.tsx"
      to: "frontend/src/components/ui/QualityBadge.tsx"
      via: "import and render in renderItem"
      pattern: "import.*QualityBadge"
    - from: "frontend/src/app/bullets/page.tsx"
      to: "frontend/src/lib/utils.ts"
      via: "displayValue for null cells"
      pattern: "displayValue"
    - from: "frontend/src/app/cartridges/page.tsx"
      to: "frontend/src/lib/utils.ts"
      via: "displayValue for null cells"
      pattern: "displayValue"
---

<objective>
Add QualityBadge to ComponentPicker modals, extend bullets and cartridges tables with new columns, and establish a shared null-display convention (em dash in muted gray) applied retroactively across all component tables.

Purpose: Improve data visibility in picker modals (quality at a glance during selection), display the full breadth of imported component data in list tables, and create a consistent visual language for missing data.
Output: Updated SimulationForm with quality badges in pickers, extended bullets/cartridges tables, displayValue utility, null display applied to all CRUD pages.
</objective>

<execution_context>
@C:/Users/vall-/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/vall-/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-tech-debt-cleanup/10-CONTEXT.md
@.planning/phases/10-tech-debt-cleanup/10-RESEARCH.md
@frontend/src/lib/utils.ts
@frontend/src/lib/types.ts
@frontend/src/components/forms/SimulationForm.tsx
@frontend/src/components/ui/QualityBadge.tsx
@frontend/src/components/ui/Badge.tsx
@frontend/src/components/ui/Table.tsx
@frontend/src/app/bullets/page.tsx
@frontend/src/app/cartridges/page.tsx
@frontend/src/app/powders/page.tsx
@frontend/src/app/rifles/page.tsx
@frontend/src/app/loads/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add displayValue utility and wire QualityBadge into picker renderItem callbacks</name>
  <files>
    frontend/src/lib/utils.ts
    frontend/src/components/forms/SimulationForm.tsx
  </files>
  <action>
**Part A: Add displayValue to utils.ts**

Read `frontend/src/lib/utils.ts` and add a `displayValue` helper function. This is a string-returning utility (not a component) consistent with the existing `formatNum` pattern in the file:

```typescript
/** Display value or em dash for null/undefined/empty */
export function displayValue(value: string | number | null | undefined): string {
  if (value == null || value === '') return '\u2014';
  return String(value);
}
```

Place it near the existing formatting utilities (e.g., `formatNum`). This will be the project-wide standard for rendering null/missing values.

**Part B: Add QualityBadge to SimulationForm picker rows**

Read `frontend/src/components/forms/SimulationForm.tsx`. Add import for QualityBadge:
```typescript
import QualityBadge from '@/components/ui/QualityBadge';
```

Find the bullet ComponentPicker `renderItem` callback. Update it to show name + caliber + weight + QualityBadge per user decision:
```tsx
renderItem={(b) => (
  <div className="flex items-center justify-between gap-3">
    <div className="min-w-0 flex-1">
      <span className="text-sm font-medium text-white">{b.name}</span>
      <span className="ml-2 text-xs text-slate-400">
        {b.diameter_mm}mm {b.weight_grains}gr
      </span>
    </div>
    <QualityBadge score={b.quality_score} level={b.quality_level} tooltip={b.quality_tooltip} />
  </div>
)}
```

Find the powder ComponentPicker `renderItem` callback. Update it to show name + middot + manufacturer + QualityBadge per user decision:
```tsx
renderItem={(p) => (
  <div className="flex items-center justify-between gap-3">
    <div className="min-w-0 flex-1">
      <span className="text-sm font-medium text-white">{p.name}</span>
      <span className="mx-1.5 text-slate-600">&middot;</span>
      <span className="text-sm text-slate-400">{p.manufacturer}</span>
    </div>
    <QualityBadge score={p.quality_score} level={p.quality_level} tooltip={p.quality_tooltip} />
  </div>
)}
```

Important: Do NOT create a cartridge picker (none exists in the codebase). Only update the 2 existing pickers (bullet and powder).

Verify QualityBadge props match the component signature by reading `frontend/src/components/ui/QualityBadge.tsx` first. The component should accept score, level, and optionally tooltip.
  </action>
  <verify>
    <automated>cd C:/Users/vall-/Desktop/projectes/simulador_balistica/frontend && npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Check SimulationForm.tsx contains QualityBadge import and both renderItem callbacks include it</manual>
  </verify>
  <done>displayValue utility exists in utils.ts. SimulationForm powder and bullet pickers render QualityBadge inline with name/metadata. TypeScript compiles with zero errors.</done>
</task>

<task type="auto">
  <name>Task 2: Extend bullets and cartridges tables with new columns and apply null display convention to all CRUD pages</name>
  <files>
    frontend/src/app/bullets/page.tsx
    frontend/src/app/cartridges/page.tsx
    frontend/src/app/powders/page.tsx
    frontend/src/app/rifles/page.tsx
    frontend/src/app/loads/page.tsx
  </files>
  <action>
**Part A: Create TypeBadge helper in bullets/page.tsx**

At the top of the bullets page (or inline), create color maps and a TypeBadge component for bullet_type and base_type display:

```tsx
const BULLET_TYPE_COLORS: Record<string, string> = {
  'Match':    'bg-blue-500/15 text-blue-400 border-blue-500/30',
  'Hunting':  'bg-green-500/15 text-green-400 border-green-500/30',
  'Target':   'bg-purple-500/15 text-purple-400 border-purple-500/30',
  'Tactical': 'bg-orange-500/15 text-orange-400 border-orange-500/30',
};

const BASE_TYPE_COLORS: Record<string, string> = {
  'BT':     'bg-sky-500/15 text-sky-400 border-sky-500/30',
  'FB':     'bg-amber-500/15 text-amber-400 border-amber-500/30',
  'Hybrid': 'bg-violet-500/15 text-violet-400 border-violet-500/30',
};

function TypeBadge({ value, colorMap }: { value: string | null | undefined; colorMap: Record<string, string> }) {
  if (!value) return <span className="text-gray-500">{'\u2014'}</span>;
  const colors = colorMap[value] || 'bg-slate-500/15 text-slate-400 border-slate-500/30';
  return (
    <span className={`inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-medium ${colors}`}>
      {value}
    </span>
  );
}
```

**Part B: Extend bullets table columns**

Read `frontend/src/app/bullets/page.tsx`. Modify the table to have this exact column order per user decision:
1. Nombre (Name)
2. N. Modelo (model_number) -- new
3. Tipo (bullet_type) -- new, uses TypeBadge with BULLET_TYPE_COLORS
4. Base (base_type) -- new, uses TypeBadge with BASE_TYPE_COLORS
5. Longitud (mm) (length_mm) -- new, nullable
6. Peso (gr) (weight_grains)
7. Diametro (mm) (diameter_mm)
8. BC G1 (bc_g1)
9. BC G7 (bc_g7) -- nullable
10. Calidad (quality badge)
11. Acciones (edit/delete buttons)

Import `displayValue` from `@/lib/utils`. Use `displayValue()` for all nullable cells (model_number, length_mm, bc_g7). Use `TypeBadge` for bullet_type and base_type. Apply `text-gray-500` class when value is null.

Update SkeletonRows columns count to match new total (11 columns).

Also update the edit form if it renders inline -- the existing columns should be preserved, just the table display changes. Do NOT add model_number/bullet_type/base_type to the edit form unless they are already there.

**Part C: Extend cartridges table columns**

Read `frontend/src/app/cartridges/page.tsx`. Modify the table to have this exact column order per user decision:
1. Nombre (Name)
2. Cartucho Padre (parent_cartridge_name) -- new
3. Capacidad (gr H2O) (case_capacity_grains) -- new
4. Long. Vaina (mm) (case_length_mm) -- new
5. OAL (mm) (max_oal_mm) -- new
6. Cuello (mm) (neck_diameter_mm) -- new
7. Bore (mm) (bore_diameter_mm) -- existing but may need reposition
8. Groove (mm) (groove_diameter_mm) -- existing but may need reposition
9. SAAMI Max (psi) (saami_max_pressure_psi) -- existing
10. Calidad (quality badge)
11. Acciones (edit/delete buttons)

Units in column headers only (not repeated in cell values). Import `displayValue` from `@/lib/utils`. Use it for all nullable fields. Apply `text-gray-500` class when value is null.

Update SkeletonRows columns count to match new total (11 columns).

**Part D: Retroactive null display on powders, rifles, and loads pages**

Read each file and audit for nullable columns that currently display raw null/undefined instead of em dash:

For `frontend/src/app/powders/page.tsx`:
- Import `displayValue` from `@/lib/utils`
- Audit all table cells for nullable fields. Known: `web_thickness_mm` is nullable. Any cell that could show null/undefined should use `displayValue()` with `text-gray-500` conditional class.

For `frontend/src/app/rifles/page.tsx`:
- Import `displayValue` from `@/lib/utils`
- Audit table cells. `round_count` or other fields may be nullable. Apply displayValue to any nullable cells found.

For `frontend/src/app/loads/page.tsx`:
- Import `displayValue` from `@/lib/utils`
- Audit table cells and apply displayValue to any nullable cells found.

For all pages: When a numeric value uses `.toFixed()` or `.toLocaleString()`, wrap in a null check first -- either use displayValue or use conditional: `value != null ? value.toFixed(2) : '\u2014'`.

The pattern for nullable cells:
```tsx
<TableCell className={value == null ? 'text-gray-500' : ''}>
  {displayValue(value)}
</TableCell>
```

Or for formatted numbers:
```tsx
<TableCell className={value == null ? 'text-gray-500' : ''}>
  {value != null ? value.toFixed(3) : '\u2014'}
</TableCell>
```
  </action>
  <verify>
    <automated>cd C:/Users/vall-/Desktop/projectes/simulador_balistica/frontend && npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Verify bullets page has 11 columns in correct order, cartridges page has 11 columns in correct order, and all nullable cells use displayValue or em dash pattern</manual>
  </verify>
  <done>Bullets table shows model_number, bullet_type (as colored pill), base_type (as colored pill), and length_mm columns in the user-specified order. Cartridges table shows parent_cartridge_name, case_capacity, case_length, OAL, neck_dia, bore, groove columns in user-specified order. All nullable cells across all 5 CRUD pages render em dash in muted gray. TypeScript compiles with zero errors.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors in frontend/
- SimulationForm has QualityBadge imported and used in both picker renderItem callbacks
- Bullets table has 11 columns: Name, N. Modelo, Tipo, Base, Longitud, Peso, Diametro, BC G1, BC G7, Calidad, Acciones
- Cartridges table has 11 columns: Nombre, Cartucho Padre, Capacidad, Long. Vaina, OAL, Cuello, Bore, Groove, SAAMI Max, Calidad, Acciones
- displayValue function exists in utils.ts
- No raw null/undefined displayed in any table cell across powders, bullets, cartridges, rifles, loads pages
</verification>

<success_criteria>
QualityBadge appears in picker modals. Bullets and cartridges tables show all extended columns in correct order. Null values display as em dash in muted gray across all component tables. TypeScript compiles cleanly.
</success_criteria>

<output>
After completion, create `.planning/phases/10-tech-debt-cleanup/10-02-SUMMARY.md`
</output>
