---
phase: 08-frontend-filter-search-controls
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/lib/api.ts
  - frontend/src/hooks/useFilterOptions.ts
  - frontend/src/components/filters/FilterBar.tsx
autonomous: true
requirements:
  - SRC-03

must_haves:
  truths:
    - "ListParams interface includes manufacturer, caliber_family, quality_level, sort, and order fields"
    - "buildQueryString serializes all ListParams fields as URL query parameters (omitting empty/falsy values)"
    - "API functions exist for fetching manufacturer lists and caliber-family lists from backend"
    - "useFilterOptions hooks (useManufacturers, useCaliberFamilies) cache results with 5-min staleTime"
    - "FilterBar component renders horizontal bar with configurable dropdowns left-aligned and search input right-aligned"
    - "Quality level dropdown maps display labels (Alta/Media/Baja) to backend values (success/warning/danger)"
    - "FilterBar shows 'Limpiar filtros' link when any filter or search is active"
    - "Search input has clear (X) button when text is present"
  artifacts:
    - path: "frontend/src/lib/api.ts"
      provides: "Extended ListParams, buildQueryString, 4 new API fetch functions"
      contains: "getPowderManufacturers|getBulletManufacturers|getBulletCaliberFamilies|getCartridgeCaliberFamilies"
    - path: "frontend/src/hooks/useFilterOptions.ts"
      provides: "useManufacturers and useCaliberFamilies hooks"
      exports: ["useManufacturers", "useCaliberFamilies"]
    - path: "frontend/src/components/filters/FilterBar.tsx"
      provides: "Reusable filter bar component with search, manufacturer, caliber-family, and quality dropdowns"
      exports: ["FilterBar"]
  key_links:
    - from: "frontend/src/components/filters/FilterBar.tsx"
      to: "frontend/src/hooks/useDebounce.ts"
      via: "import useDebounce for search input"
      pattern: "useDebounce"
    - from: "frontend/src/hooks/useFilterOptions.ts"
      to: "frontend/src/lib/api.ts"
      via: "import fetch functions for manufacturers/caliber-families"
      pattern: "getPowderManufacturers|getBulletManufacturers"
    - from: "frontend/src/lib/api.ts"
      to: "backend /manufacturers and /caliber-families endpoints"
      via: "HTTP GET requests via request() helper"
      pattern: "request.*manufacturers|request.*caliber-families"
---

<objective>
Create the API layer, hooks, and reusable FilterBar component for component list page filtering.

Purpose: Build all the shared infrastructure so Plan 02 can wire filters into the three list pages with minimal page-specific code.
Output: Extended ListParams/buildQueryString in api.ts, useFilterOptions hooks, and a configurable FilterBar component.
</objective>

<execution_context>
@C:/Users/vall-/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/vall-/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-frontend-filter-search-controls/08-RESEARCH.md

@frontend/src/lib/api.ts
@frontend/src/hooks/useDebounce.ts
@frontend/src/components/ui/Select.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend ListParams, buildQueryString, and add filter API functions</name>
  <files>frontend/src/lib/api.ts</files>
  <action>
In `frontend/src/lib/api.ts`:

1. **Extend the `ListParams` interface** (currently at line 31-35) to add these optional fields:
   ```typescript
   export interface ListParams {
     page?: number;
     size?: number;
     q?: string;
     manufacturer?: string;
     caliber_family?: string;
     quality_level?: string;
     sort?: string;
     order?: string;
   }
   ```

2. **Update `buildQueryString`** (currently at line 37-44) to serialize ALL ListParams fields. Only add params that are truthy (non-empty, non-undefined). Keep the existing `q.length >= 3` check for search. For all other new params, just check truthiness:
   ```typescript
   function buildQueryString(params: ListParams): string {
     const sp = new URLSearchParams();
     if (params.page) sp.set('page', String(params.page));
     if (params.size) sp.set('size', String(params.size));
     if (params.q && params.q.length >= 3) sp.set('q', params.q);
     if (params.manufacturer) sp.set('manufacturer', params.manufacturer);
     if (params.caliber_family) sp.set('caliber_family', params.caliber_family);
     if (params.quality_level) sp.set('quality_level', params.quality_level);
     if (params.sort) sp.set('sort', params.sort);
     if (params.order) sp.set('order', params.order);
     const qs = sp.toString();
     return qs ? `?${qs}` : '';
   }
   ```

3. **Add 4 new API functions** after the existing powder/bullet/cartridge sections. These call the existing backend endpoints:
   ```typescript
   // Powder filter options
   export async function getPowderManufacturers(): Promise<string[]> {
     return request<string[]>('/powders/manufacturers');
   }

   // Bullet filter options
   export async function getBulletManufacturers(): Promise<string[]> {
     return request<string[]>('/bullets/manufacturers');
   }

   export async function getBulletCaliberFamilies(): Promise<string[]> {
     return request<string[]>('/bullets/caliber-families');
   }

   // Cartridge filter options
   export async function getCartridgeCaliberFamilies(): Promise<string[]> {
     return request<string[]>('/cartridges/caliber-families');
   }
   ```

   Place these functions logically: `getPowderManufacturers` after `deletePowder`, `getBulletManufacturers` and `getBulletCaliberFamilies` after `deleteBullet`, `getCartridgeCaliberFamilies` after `deleteCartridge`.
  </action>
  <verify>
    <automated>cd C:/Users/vall-/Desktop/projectes/simulador_balistica/frontend && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
    <manual>Verify ListParams has 8 fields, buildQueryString serializes all of them, and 4 new exported functions exist</manual>
  </verify>
  <done>ListParams includes manufacturer/caliber_family/quality_level/sort/order fields. buildQueryString serializes them. 4 API fetch functions for manufacturer/caliber-family endpoints exist and are exported.</done>
</task>

<task type="auto">
  <name>Task 2: Create useFilterOptions hooks and FilterBar component</name>
  <files>frontend/src/hooks/useFilterOptions.ts, frontend/src/components/filters/FilterBar.tsx</files>
  <action>
**Part A: Create `frontend/src/hooks/useFilterOptions.ts`**

Two hooks using TanStack Query with 5-minute staleTime (manufacturers/caliber-families rarely change):

```typescript
import { useQuery } from '@tanstack/react-query';
import {
  getPowderManufacturers,
  getBulletManufacturers,
  getBulletCaliberFamilies,
  getCartridgeCaliberFamilies,
} from '@/lib/api';

export function useManufacturers(entity: 'powders' | 'bullets') {
  const fetchFn = entity === 'powders' ? getPowderManufacturers : getBulletManufacturers;
  return useQuery({
    queryKey: [entity, 'manufacturers'],
    queryFn: fetchFn,
    staleTime: 5 * 60 * 1000,
  });
}

export function useCaliberFamilies(entity: 'bullets' | 'cartridges') {
  const fetchFn = entity === 'bullets' ? getBulletCaliberFamilies : getCartridgeCaliberFamilies;
  return useQuery({
    queryKey: [entity, 'caliber-families'],
    queryFn: fetchFn,
    staleTime: 5 * 60 * 1000,
  });
}
```

**Part B: Create `frontend/src/components/filters/FilterBar.tsx`**

A reusable component. Props control which dropdowns appear (powders get manufacturer + quality, bullets get all three, cartridges get caliber_family + quality only).

Key implementation details:

1. **Props interface:**
   ```typescript
   interface FilterBarProps {
     searchValue: string;
     onSearchChange: (value: string) => void;
     searchPlaceholder?: string;

     // Manufacturer filter (powders + bullets only, omit for cartridges)
     manufacturers?: string[];
     selectedManufacturer?: string;
     onManufacturerChange?: (value: string) => void;

     // Caliber family filter (bullets + cartridges only, omit for powders)
     caliberFamilies?: string[];
     selectedCaliberFamily?: string;
     onCaliberFamilyChange?: (value: string) => void;

     // Quality level filter (always shown on all three)
     selectedQualityLevel?: string;
     onQualityLevelChange?: (value: string) => void;

     // Clear all
     hasActiveFilters: boolean;
     onClearFilters: () => void;
   }
   ```

2. **Layout:** Horizontal bar using flexbox. Filters left-aligned, search right-aligned (`ml-auto`). Use `flex-wrap gap-3` for responsive wrapping on narrow viewports.

3. **Styling:** Consistent with existing dark theme. Use `rounded-lg border border-slate-700 bg-slate-800/50 px-4 py-3` for the bar container.

4. **Dropdowns:** Use native `<select>` elements styled with Tailwind (matching existing `input-field` class from the codebase). Each dropdown gets:
   - A default "all" option with empty string value (e.g., "Todos los fabricantes", "Todas las familias", "Todas las calidades")
   - Styling: `bg-slate-800 border-slate-600 text-slate-300 text-sm rounded-md px-2 py-1.5`

5. **Quality level options** (CRITICAL -- must map display labels to backend values):
   ```typescript
   const QUALITY_OPTIONS = [
     { value: '', label: 'Todas las calidades' },
     { value: 'success', label: 'Alta (70-100)' },
     { value: 'warning', label: 'Media (40-69)' },
     { value: 'danger', label: 'Baja (0-39)' },
   ];
   ```

6. **Search input:** Right-aligned in the bar. Has a `Search` icon (from lucide-react) on the left inside the input. Has an `X` clear button that appears when `searchValue` is non-empty. Placeholder: "Buscar por nombre..." (per user decision). Note: the FilterBar does NOT debounce internally -- it receives the raw `searchValue` and calls `onSearchChange` directly. The PARENT page is responsible for debouncing (via `useDebounce`).

7. **"Limpiar filtros" link:** Appears only when `hasActiveFilters` is true. Styled as a text button: `text-sm text-blue-400 hover:text-blue-300`. Calls `onClearFilters`.

8. **Icons:** Import `Search` and `X` from `lucide-react`.

Do NOT import or use the existing `Select` component (it includes label/error wrapper which is unnecessary for inline filter dropdowns). Use raw `<select>` with Tailwind classes to keep the filter bar compact.
  </action>
  <verify>
    <automated>cd C:/Users/vall-/Desktop/projectes/simulador_balistica/frontend && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
    <manual>Verify useFilterOptions.ts exports useManufacturers and useCaliberFamilies. Verify FilterBar.tsx exports FilterBar with correct props interface.</manual>
  </verify>
  <done>useFilterOptions hook provides useManufacturers(entity) and useCaliberFamilies(entity) with 5-min cache. FilterBar renders horizontal bar with configurable dropdowns (manufacturer, caliber_family, quality) left-aligned, search input with X clear button right-aligned, and "Limpiar filtros" link when filters are active. Quality dropdown maps display labels to backend values (success/warning/danger).</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `ListParams` has 8 fields (page, size, q, manufacturer, caliber_family, quality_level, sort, order)
3. `buildQueryString` serializes all truthy params
4. 4 new API functions are exported (getPowderManufacturers, getBulletManufacturers, getBulletCaliberFamilies, getCartridgeCaliberFamilies)
5. useManufacturers and useCaliberFamilies hooks exist and use correct API functions per entity
6. FilterBar component accepts configurable props for which filters to show
7. Quality dropdown values are 'success', 'warning', 'danger' (not 'high', 'medium', 'low')
</verification>

<success_criteria>
- TypeScript compiles without errors
- All shared infrastructure (ListParams, buildQueryString, API functions, hooks, FilterBar) is ready for list page integration in Plan 02
- FilterBar is entity-agnostic and reusable (powders: manufacturer+quality, bullets: manufacturer+caliber+quality, cartridges: caliber+quality)
</success_criteria>

<output>
After completion, create `.planning/phases/08-frontend-filter-search-controls/08-01-SUMMARY.md`
</output>
