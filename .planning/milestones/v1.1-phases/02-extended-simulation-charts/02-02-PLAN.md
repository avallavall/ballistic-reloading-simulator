---
phase: 02-extended-simulation-charts
plan: 02
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - frontend/src/lib/types.ts
  - frontend/src/lib/api.ts
  - frontend/src/components/charts/ChartTile.tsx
  - frontend/src/components/charts/ChartModal.tsx
  - frontend/src/components/charts/BurnProgressChart.tsx
  - frontend/src/components/charts/EnergyRecoilChart.tsx
  - frontend/src/components/charts/TemperatureChart.tsx
  - frontend/src/hooks/useChartExport.ts
  - frontend/src/hooks/useChartZoom.ts
  - frontend/src/app/simulate/page.tsx
  - frontend/src/components/charts/PressureTimeChart.tsx
  - frontend/src/components/charts/VelocityDistanceChart.tsx
  - frontend/src/components/charts/HarmonicsChart.tsx
autonomous: true
requirements:
  - CHART-01
  - CHART-02
  - CHART-03

must_haves:
  truths:
    - "User sees a 2-column dashboard grid of chart tiles after running a simulation, with P(t) and V(x) as hero charts at the top"
    - "User can view burn fraction Z vs time and dZ/dt vs time in a dedicated orange-themed chart tile"
    - "User can view kinetic energy vs distance and recoil impulse vs time in green-themed chart tiles"
    - "User can view gas temperature and cumulative heat loss vs time in a red-themed chart tile"
    - "User can click any chart tile to expand it into a full-detail modal with zoom and tooltips"
    - "User can download PNG image or CSV data for any individual chart tile"
  artifacts:
    - path: "frontend/src/components/charts/ChartTile.tsx"
      provides: "Reusable chart tile wrapper with domain color, expand button, export buttons"
      min_lines: 40
    - path: "frontend/src/components/charts/ChartModal.tsx"
      provides: "Full-screen modal overlay for expanded chart view"
      min_lines: 30
    - path: "frontend/src/components/charts/BurnProgressChart.tsx"
      provides: "Z(t) and dZ/dt(t) dual-axis chart with orange domain color"
      min_lines: 40
    - path: "frontend/src/components/charts/EnergyRecoilChart.tsx"
      provides: "KE(x) and recoil impulse(t) charts with green domain color"
      min_lines: 40
    - path: "frontend/src/components/charts/TemperatureChart.tsx"
      provides: "T_gas(t) and Q_loss(t) chart with red domain color"
      min_lines: 40
    - path: "frontend/src/hooks/useChartExport.ts"
      provides: "html2canvas PNG export + CSV generation hook"
      min_lines: 30
    - path: "frontend/src/hooks/useChartZoom.ts"
      provides: "Click-drag zoom state management hook"
      min_lines: 25
    - path: "frontend/src/app/simulate/page.tsx"
      provides: "Restructured dashboard grid layout with all chart tiles"
      min_lines: 100
  key_links:
    - from: "frontend/src/lib/types.ts"
      to: "backend API response"
      via: "TypeScript interfaces matching backend curve arrays"
      pattern: "BurnCurvePoint|EnergyCurvePoint|TemperatureCurvePoint|RecoilCurvePoint"
    - from: "frontend/src/components/charts/BurnProgressChart.tsx"
      to: "frontend/src/lib/types.ts"
      via: "Import BurnCurvePoint type"
      pattern: "import.*BurnCurvePoint"
    - from: "frontend/src/app/simulate/page.tsx"
      to: "frontend/src/components/charts/ChartTile.tsx"
      via: "Wraps each chart in ChartTile"
      pattern: "ChartTile"
    - from: "frontend/src/components/charts/ChartTile.tsx"
      to: "frontend/src/hooks/useChartExport.ts"
      via: "Uses export hook for PNG/CSV buttons"
      pattern: "useChartExport"
---

<objective>
Build the frontend chart infrastructure (types, tile wrapper, modal, export, zoom) and 3 new chart components (BurnProgress, EnergyRecoil, Temperature), then restructure the simulation page into a responsive dashboard grid layout.

Purpose: Transform the simulation results from a vertical stack of 2 charts into a comprehensive dashboard showing all physics the solver computes, with consistent tile chrome and per-chart export/expand capabilities.

Output: Dashboard grid with 7 chart tiles (P/V hero row + burn/energy/temperature/harmonics/recoil tiles), each with expand-to-modal and PNG/CSV export.
</objective>

<execution_context>
@C:/Users/vall-/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/vall-/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-extended-simulation-charts/02-RESEARCH.md
@.planning/phases/02-extended-simulation-charts/02-01-SUMMARY.md

@frontend/src/lib/types.ts
@frontend/src/lib/api.ts
@frontend/src/app/simulate/page.tsx
@frontend/src/components/charts/PressureTimeChart.tsx
@frontend/src/components/charts/VelocityDistanceChart.tsx
@frontend/src/components/charts/HarmonicsChart.tsx
@frontend/src/hooks/useSimulation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, add TS types, update API client, create chart infrastructure</name>
  <files>
    frontend/src/lib/types.ts
    frontend/src/lib/api.ts
    frontend/src/components/charts/ChartTile.tsx
    frontend/src/components/charts/ChartModal.tsx
    frontend/src/hooks/useChartExport.ts
    frontend/src/hooks/useChartZoom.ts
  </files>
  <action>
**Install new dependencies:**
```bash
cd frontend && npm install html2canvas file-saver && npm install -D @types/file-saver
```

**In types.ts**, add new curve point interfaces and update SimulationResult:

```typescript
// New curve point types (add after existing CurvePoint and DistanceCurvePoint)
export interface BurnCurvePoint {
  t_ms: number;
  z: number;
  dz_dt: number;
  psi: number;
}

export interface EnergyCurvePoint {
  t_ms: number;
  x_mm: number;
  ke_j: number;
  ke_ft_lbs: number;
  momentum_ns: number;
}

export interface TemperatureCurvePoint {
  t_ms: number;
  t_gas_k: number;
  q_loss_j: number;
}

export interface RecoilCurvePoint {
  t_ms: number;
  impulse_ns: number;
}
```

Update the `SimulationResult` interface to add:
```typescript
burn_curve: BurnCurvePoint[];
energy_curve: EnergyCurvePoint[];
temperature_curve: TemperatureCurvePoint[];
recoil_curve: RecoilCurvePoint[];
```

Add sensitivity types:
```typescript
export interface SensitivityInput {
  powder_id: string;
  bullet_id: string;
  rifle_id: string;
  powder_charge_grains: number;
  coal_mm: number;
  seating_depth_mm: number;
  charge_delta_grains?: number;
}

export interface SensitivityResponse {
  center: SimulationResult;
  upper: SimulationResult;
  lower: SimulationResult;
  charge_center_grains: number;
  charge_upper_grains: number;
  charge_lower_grains: number;
}
```

**In api.ts**, add the sensitivity API function:
```typescript
export async function runSensitivity(input: SensitivityInput): Promise<SensitivityResponse> {
  return request<SensitivityResponse>('/simulate/sensitivity', {
    method: 'POST',
    body: JSON.stringify(input),
  });
}
```

**Create ChartTile.tsx** (`frontend/src/components/charts/ChartTile.tsx`):
Reusable wrapper providing consistent tile chrome. Props: `title: string`, `domainColor: 'blue' | 'orange' | 'red' | 'green'`, `children: React.ReactNode`, `data: Record<string, unknown>[]`, `csvHeaders: string[]`, `csvFilename: string`, `onExpand: () => void`, `badge?: string`.

- Renders a Card with a colored left border accent based on domainColor (blue-500, orange-500, red-500, green-500 via Tailwind classes -- use a lookup object, not template literals for Tailwind purge safety).
- Header row: title on left, 3 icon buttons on right (PNG download via useChartExport, CSV download via useChartExport, expand via Maximize2 icon from lucide-react).
- CardContent wraps children in a div with ref for html2canvas export.
- Badge renders optional text badge next to title (e.g., "Combustion", "Energy").

**Create ChartModal.tsx** (`frontend/src/components/charts/ChartModal.tsx`):
Full-screen overlay. Props: `isOpen: boolean`, `onClose: () => void`, `title: string`, `children: React.ReactNode`.

- When isOpen, render a React portal to document.body.
- Semi-transparent dark backdrop (bg-black/60 backdrop-blur-sm).
- Centered white/dark card (max-w-6xl w-full mx-4) with title header, close button (X icon from lucide-react), and content area.
- Content area gives chart a generous height: h-[32rem] (512px).
- Close on Escape key (useEffect with keydown listener).
- Close on backdrop click.
- Use key prop on children's ResponsiveContainer: `key="expanded"` to force remount so Recharts re-measures dimensions (per research pitfall 5).

**Create useChartExport.ts** (`frontend/src/hooks/useChartExport.ts`):
Custom hook that returns `{ chartRef, exportPng, exportCsv }`.

- `chartRef`: React.RefObject<HTMLDivElement> for html2canvas target.
- `exportPng(filename: string)`: Calls `html2canvas(chartRef.current, { backgroundColor: '#0f172a' })` (dark bg to match app theme), then `canvas.toBlob()` + `saveAs(blob, filename + '.png')`.
- `exportCsv(data: Record<string, unknown>[], headers: string[], filename: string)`: Generates CSV string from data array using headers as column names. Uses `saveAs(new Blob([csvString], { type: 'text/csv' }), filename + '.csv')`.

**Create useChartZoom.ts** (`frontend/src/hooks/useChartZoom.ts`):
Custom hook for click-drag zoom on Recharts charts. Returns `{ zoomState, refAreaLeft, refAreaRight, onMouseDown, onMouseMove, onMouseUp, onDoubleClickReset }`.

- `zoomState`: `{ left: 'dataMin' | number, right: 'dataMax' | number }` for XAxis domain prop.
- `onMouseDown(e)`: If e has activeLabel, set refAreaLeft.
- `onMouseMove(e)`: If refAreaLeft is set and e has activeLabel, set refAreaRight.
- `onMouseUp()`: If both refAreaLeft and refAreaRight set, compute new domain from min/max of the two, clear refArea. If selection is too small (< 5% of range), treat as click not drag and ignore.
- `onDoubleClickReset()`: Reset zoomState to `{ left: 'dataMin', right: 'dataMax' }`.
  </action>
  <verify>
Run `cd C:/Users/vall-/Desktop/projectes/simulador_balistica/frontend && npx tsc --noEmit` -- TypeScript compilation passes with no errors. Verify `html2canvas` and `file-saver` appear in package.json dependencies.
  </verify>
  <done>
New TS types for all 4 curve arrays + sensitivity. API client has runSensitivity function. ChartTile wrapper renders card with domain color accent, PNG/CSV/expand buttons. ChartModal provides full-screen overlay with proper resize handling. useChartExport and useChartZoom hooks provide reusable chart interaction logic. All TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BurnProgressChart, EnergyRecoilChart, and TemperatureChart components</name>
  <files>
    frontend/src/components/charts/BurnProgressChart.tsx
    frontend/src/components/charts/EnergyRecoilChart.tsx
    frontend/src/components/charts/TemperatureChart.tsx
  </files>
  <action>
All 3 charts follow existing project Recharts patterns (see PressureTimeChart.tsx and VelocityDistanceChart.tsx). All use `'use client'` directive, ResponsiveContainer, LineChart or ComposedChart, custom Tooltip, and Tailwind styling.

**BurnProgressChart.tsx** -- Orange domain (#f97316 / orange-500):
- Props: `data: BurnCurvePoint[]`, `syncId?: string`
- Dual Y-axis chart using ComposedChart:
  - Left Y-axis: Burn fraction Z (0 to 1.0), label "Z (fraction quemada)"
  - Right Y-axis: dZ/dt (burn rate), label "dZ/dt (s^-1)"
  - X-axis: t_ms, label "Tiempo (ms)"
  - Line for Z: solid orange-500, dataKey="z", yAxisId="left"
  - Line for dZ/dt: dashed orange-300, dataKey="dz_dt", yAxisId="right"
  - Custom tooltip showing t_ms, Z (formatted 3 decimal places), dZ/dt
- Use `syncId="sim-time"` for synchronized crosshairs across time-domain charts.
- Include ReferenceArea support for zoom (accept zoomState, refAreaLeft, refAreaRight as props, or use useChartZoom internally -- pick internal usage per Claude's discretion on complexity).

**EnergyRecoilChart.tsx** -- Green domain (#22c55e / green-500):
- This renders TWO sub-charts stacked vertically inside one component (not dual Y-axis, since KE is vs distance and recoil is vs time -- different x-axes per user decision in CONTEXT.md "kinetic energy vs distance and recoil impulse over time").
- Props: `energyData: EnergyCurvePoint[]`, `recoilData: RecoilCurvePoint[]`, `distanceSyncId?: string`, `timeSyncId?: string`
- Top half: KE vs distance (x_mm on X-axis, ke_ft_lbs on Y-axis). Label: "Energia Cinetica (ft-lbs)" vs "Distancia (mm)". Use syncId="sim-distance".
- Bottom half: Recoil impulse vs time (t_ms on X-axis, impulse_ns on Y-axis). Label: "Impulso de Retroceso (N-s)" vs "Tiempo (ms)". Use syncId="sim-time".
- Both use green-500 line color.
- Custom tooltips with proper unit formatting.
- Each sub-chart gets h-32 (128px) when in tile mode (total h-64 for the pair).

**TemperatureChart.tsx** -- Red domain (#ef4444 / red-500):
- Props: `data: TemperatureCurvePoint[]`, `syncId?: string`
- Dual Y-axis chart using ComposedChart:
  - Left Y-axis: Gas temperature (K), label "T gas (K)"
  - Right Y-axis: Cumulative heat loss (J), label "Q perdido (J)"
  - X-axis: t_ms, label "Tiempo (ms)"
  - Line for t_gas_k: solid red-500, yAxisId="left"
  - Line for q_loss_j: dashed red-300, yAxisId="right"
- Use `syncId="sim-time"` for crosshair sync.
- Custom tooltip showing time, temperature in K, and heat loss in J.

**All charts common patterns:**
- Accept an optional `expanded?: boolean` prop. When true, use a larger height and denser tick formatting.
- Use `dot={false}` on all Lines (200 data points makes dots unreadable).
- Use CartesianGrid with `strokeDasharray="3 3"` and low opacity.
- Tooltip background should be dark (bg-gray-900) with light text to match app theme.
  </action>
  <verify>
Run `cd C:/Users/vall-/Desktop/projectes/simulador_balistica/frontend && npx tsc --noEmit` -- TypeScript compilation passes. Visually inspect that each component file exists and has proper imports.
  </verify>
  <done>
Three new chart components created: BurnProgressChart (Z and dZ/dt vs time, orange), EnergyRecoilChart (KE vs distance + recoil impulse vs time, green), TemperatureChart (T_gas and Q_loss vs time, red). All use syncId for crosshair synchronization, follow existing Recharts patterns, and accept expanded prop for modal view.
  </done>
</task>

<task type="auto">
  <name>Task 3: Restructure simulate/page.tsx into responsive dashboard grid</name>
  <files>
    frontend/src/app/simulate/page.tsx
    frontend/src/components/charts/PressureTimeChart.tsx
    frontend/src/components/charts/VelocityDistanceChart.tsx
    frontend/src/components/charts/HarmonicsChart.tsx
  </files>
  <action>
**Restructure simulate/page.tsx** from the current vertical stack layout into a responsive dashboard grid per user decisions in CONTEXT.md.

Layout structure:
1. **SimulationForm** at top (unchanged functionality)
2. **Result summary cards** row (peak pressure, muzzle velocity, barrel time -- these already exist, keep them)
3. **Structural cards** row (hoop stress, case expansion, erosion -- these already exist, keep them)
4. **Hero row**: 2-column grid with `PressureTimeChart` (left, blue) and `VelocityDistanceChart` (right, blue). Each wrapped in ChartTile.
5. **Secondary chart grid**: 2-column responsive grid (`grid grid-cols-1 lg:grid-cols-2 gap-4`) containing:
   - BurnProgressChart tile (orange, "Progreso de Combustion")
   - EnergyRecoilChart tile (green, "Energia y Retroceso")
   - TemperatureChart tile (red, "Temperatura y Calor")
   - HarmonicsChart tile (blue, "Armonicos del Canon") -- existing chart, moved into grid
6. Hero charts should be taller: h-80 (320px). Secondary tiles: h-64 (256px).

**Chart wrapping pattern** (for each chart):
```tsx
const [expandedChart, setExpandedChart] = useState<string | null>(null);

// For each chart:
<ChartTile
  title="Presion vs Tiempo"
  domainColor="blue"
  data={result.pressure_curve}
  csvHeaders={["t_ms", "p_psi"]}
  csvFilename="presion_tiempo"
  onExpand={() => setExpandedChart('pressure')}
>
  <PressureTimeChart data={result.pressure_curve} syncId="sim-time" />
</ChartTile>

// Single ChartModal instance, renders the expanded chart:
<ChartModal
  isOpen={expandedChart !== null}
  onClose={() => setExpandedChart(null)}
  title={getChartTitle(expandedChart)}
>
  {expandedChart === 'pressure' && (
    <PressureTimeChart data={result.pressure_curve} syncId="sim-time" expanded />
  )}
  {/* ... other charts ... */}
</ChartModal>
```

**Modify PressureTimeChart.tsx**:
- Add optional `syncId?: string` prop, pass to LineChart.
- Add optional `expanded?: boolean` prop for larger rendering.
- Add optional `saami_max_psi?: number` prop (extracted from existing inline rendering).
- Keep existing functionality, just make it more composable.

**Modify VelocityDistanceChart.tsx**:
- Add optional `syncId?: string` prop (use "sim-distance").
- Add optional `expanded?: boolean` prop.
- Keep existing functionality.

**Modify HarmonicsChart.tsx**:
- Add optional `syncId?: string` prop.
- Add optional `expanded?: boolean` prop.
- Keep existing functionality.

**Pass new curve data to new charts**: After simulation runs, the result object now includes burn_curve, energy_curve, temperature_curve, recoil_curve. Pass these directly to the corresponding chart components inside their ChartTile wrappers.

**Responsive behavior**: Use Tailwind responsive classes. On mobile (< lg), grid collapses to 1 column. Hero charts stack vertically. On lg+, 2-column grid.

**Key requirement from CONTEXT.md**: "Harmonics (OBT) chart moves into the grid as a regular tile alongside the new charts." Move it from its current standalone section into the secondary grid.

Remove the old vertical stack layout. The structural cards (hoop stress, etc.) remain as summary cards ABOVE the chart grid, not as tiles.
  </action>
  <verify>
Run `cd C:/Users/vall-/Desktop/projectes/simulador_balistica/frontend && npx tsc --noEmit` -- TypeScript compilation passes. Run `npm run build` to verify no build errors with the restructured page. Check that the page renders by visiting http://localhost:3000/simulate (requires Docker running).
  </verify>
  <done>
Simulation page displays a 2-column responsive dashboard grid. Hero row shows P(t) and V(x) as the largest charts. Secondary grid shows BurnProgress, EnergyRecoil, Temperature, and Harmonics tiles. Each tile has PNG/CSV export buttons and expand-to-modal. Click any tile to see full-detail modal. All time-domain charts share syncId for synchronized crosshairs. Existing functionality (form, summary cards, structural cards) preserved.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` -- TypeScript compiles cleanly
2. `cd frontend && npm run build` -- Next.js build succeeds
3. Visual check: simulation page shows dashboard grid after running a simulation
4. Each chart tile has PNG download, CSV download, and expand buttons
5. Click expand on any tile opens full-detail modal
6. Hover tooltip works on all charts
7. Time-domain charts (pressure, burn, temperature, recoil) have synchronized crosshairs
</verification>

<success_criteria>
- Dashboard grid layout with 2-column responsive design
- 6 chart tiles visible after simulation (pressure, velocity, burn, energy/recoil, temperature, harmonics)
- Hero row (P/V) is visually prominent at top
- Each tile has domain color accent (blue/orange/red/green)
- Per-chart PNG and CSV export functional
- Expand-to-modal works for all charts
- All existing simulation functionality preserved (form, cards, CSV global export)
</success_criteria>

<output>
After completion, create `.planning/phases/02-extended-simulation-charts/02-02-SUMMARY.md`
</output>
