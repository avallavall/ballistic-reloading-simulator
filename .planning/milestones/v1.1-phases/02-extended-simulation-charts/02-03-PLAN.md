---
phase: 02-extended-simulation-charts
plan: 03
type: execute
wave: 3
depends_on:
  - 02-02
files_modified:
  - frontend/src/components/charts/PressureTimeChart.tsx
  - frontend/src/components/charts/VelocityDistanceChart.tsx
  - frontend/src/components/panels/SensitivityPanel.tsx
  - frontend/src/hooks/useSensitivity.ts
  - frontend/src/app/simulate/page.tsx
  - frontend/src/lib/types.ts
autonomous: false
requirements:
  - CHART-04
  - CHART-05

must_haves:
  truths:
    - "User sees shaded error bands on pressure and velocity charts showing +/- charge weight variation by default"
    - "User can toggle error bands on/off via a checkbox"
    - "User can open a collapsible side panel with sliders for charge weight, seating depth, and barrel length"
    - "Dragging sliders updates ALL charts in the grid in near-real-time (debounced)"
    - "Summary result cards show live values AND +/- delta badges vs the original simulation values"
    - "Error bands recalculate around the new center value when sliders change"
  artifacts:
    - path: "frontend/src/components/panels/SensitivityPanel.tsx"
      provides: "Collapsible side panel with charge/seating/barrel sliders"
      min_lines: 60
    - path: "frontend/src/hooks/useSensitivity.ts"
      provides: "Slider state management with debounced re-simulation"
      min_lines: 40
    - path: "frontend/src/components/charts/PressureTimeChart.tsx"
      provides: "Error band rendering via ComposedChart with stacked Area"
      contains: "ComposedChart"
    - path: "frontend/src/components/charts/VelocityDistanceChart.tsx"
      provides: "Error band rendering via ComposedChart with stacked Area"
      contains: "ComposedChart"
  key_links:
    - from: "frontend/src/hooks/useSensitivity.ts"
      to: "frontend/src/lib/api.ts"
      via: "Calls runSensitivity or runSimulation on debounced slider change"
      pattern: "runSensitivity|runSimulation"
    - from: "frontend/src/components/panels/SensitivityPanel.tsx"
      to: "frontend/src/hooks/useSensitivity.ts"
      via: "Uses sensitivity hook for slider state and handlers"
      pattern: "useSensitivity"
    - from: "frontend/src/app/simulate/page.tsx"
      to: "frontend/src/components/panels/SensitivityPanel.tsx"
      via: "Renders panel alongside chart grid, feeds slider results to all charts"
      pattern: "SensitivityPanel"
    - from: "frontend/src/components/charts/PressureTimeChart.tsx"
      to: "frontend/src/lib/types.ts"
      via: "Accepts error band data props"
      pattern: "upperData|lowerData|bandData"
---

<objective>
Add error band visualization to P/V charts and build the interactive sensitivity explorer with collapsible slider panel that updates all charts in real-time.

Purpose: Enable users to explore parameter sensitivity visually -- seeing how +/- charge weight variation affects pressure/velocity (error bands) and how changing charge, seating depth, or barrel length affects all simulation outputs (interactive sliders).

Output: Error bands on P/V charts + collapsible sensitivity panel with live-updating sliders + delta badges on summary cards.
</objective>

<execution_context>
@C:/Users/vall-/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/vall-/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-extended-simulation-charts/02-RESEARCH.md
@.planning/phases/02-extended-simulation-charts/02-01-SUMMARY.md
@.planning/phases/02-extended-simulation-charts/02-02-SUMMARY.md

@frontend/src/app/simulate/page.tsx
@frontend/src/components/charts/PressureTimeChart.tsx
@frontend/src/components/charts/VelocityDistanceChart.tsx
@frontend/src/hooks/useSensitivity.ts
@frontend/src/lib/api.ts
@frontend/src/lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add error bands to PressureTimeChart and VelocityDistanceChart</name>
  <files>
    frontend/src/components/charts/PressureTimeChart.tsx
    frontend/src/components/charts/VelocityDistanceChart.tsx
    frontend/src/lib/types.ts
  </files>
  <action>
**In types.ts**, add error band helper type:
```typescript
export interface ErrorBandPoint {
  // For pressure chart
  t_ms?: number;
  // For velocity chart
  x_mm?: number;
  // Band values
  center: number;
  upper: number;
  lower: number;
  band: number; // upper - lower (for stacked Area trick)
}
```

Add helper function (can go in types.ts or a new utils function):
```typescript
export function buildErrorBandData(
  center: { [key: string]: number }[],
  upper: { [key: string]: number }[],
  lower: { [key: string]: number }[],
  xKey: string,
  valueKey: string
): ErrorBandPoint[] {
  return center.map((c, i) => ({
    [xKey]: c[xKey],
    center: c[valueKey],
    upper: upper[i]?.[valueKey] ?? c[valueKey],
    lower: lower[i]?.[valueKey] ?? c[valueKey],
    band: (upper[i]?.[valueKey] ?? c[valueKey]) - (lower[i]?.[valueKey] ?? c[valueKey]),
  }));
}
```

**Modify PressureTimeChart.tsx:**

Convert from LineChart to ComposedChart. Add optional props:
- `upperData?: CurvePoint[]` -- pressure curve for +delta charge
- `lowerData?: CurvePoint[]` -- pressure curve for -delta charge
- `showBands?: boolean` -- default true, toggle error bands

When band data is provided AND showBands is true, render the stacked Area trick (per RESEARCH.md Pattern 1):

```tsx
import { ComposedChart, Area, Line, ... } from 'recharts';

// Transform data for band rendering:
// Merge center, upper, lower into single array with p_center, p_lower, p_band columns
const bandData = centerData.map((c, i) => ({
  t_ms: c.t_ms,
  p_center: c.p_psi,
  p_lower: lowerData?.[i]?.p_psi ?? c.p_psi,
  p_upper: upperData?.[i]?.p_psi ?? c.p_psi,
  p_band: (upperData?.[i]?.p_psi ?? c.p_psi) - (lowerData?.[i]?.p_psi ?? c.p_psi),
}));

<ComposedChart data={bandData} syncId={syncId}>
  {/* Error bands (only when showBands && band data exists) */}
  {showBands && upperData && lowerData && (
    <>
      {/* Invisible lower bound */}
      <Area type="monotone" dataKey="p_lower" stackId="error" stroke="none" fill="transparent" fillOpacity={0} />
      {/* Visible band delta */}
      <Area type="monotone" dataKey="p_band" stackId="error" stroke="none" fill="#3b82f6" fillOpacity={0.15} />
      {/* Dashed boundary lines */}
      <Line type="monotone" dataKey="p_upper" stroke="#3b82f6" strokeDasharray="4 4" dot={false} strokeWidth={1} />
      <Line type="monotone" dataKey="p_lower" stroke="#3b82f6" strokeDasharray="4 4" dot={false} strokeWidth={1} />
    </>
  )}
  {/* Main center line */}
  <Line type="monotone" dataKey="p_center" stroke="#3b82f6" strokeWidth={2} dot={false} />
  {/* SAAMI reference line if applicable */}
</ComposedChart>
```

Use blue domain color (#3b82f6) for bands at reduced opacity (0.15) per user decision: "Error bands use the same domain color as the main curve but at reduced opacity."

**Modify VelocityDistanceChart.tsx:**

Same pattern but for velocity data:
- Optional props: `upperData?: DistanceCurvePoint[]`, `lowerData?: DistanceCurvePoint[]`, `showBands?: boolean`
- Merge into band data with v_center, v_lower, v_band columns keyed on x_mm.
- Use blue domain color for bands.
- Convert to ComposedChart.

**IMPORTANT**: The stacked Area trick requires the data to have p_lower as the invisible base and p_band = p_upper - p_lower as the visible fill ON TOP of the base. This fills ONLY the region between the two bounds. Do NOT use two separate Areas without stacking -- that fills from each line down to zero.
  </action>
  <verify>
Run `cd C:/Users/vall-/Desktop/projectes/simulador_balistica/frontend && npx tsc --noEmit` -- TypeScript compiles cleanly. Verify that PressureTimeChart and VelocityDistanceChart still render correctly without band data (backward compatible -- band props are optional).
  </verify>
  <done>
PressureTimeChart and VelocityDistanceChart support optional error band rendering via ComposedChart + stacked Area trick. When upperData/lowerData props are provided and showBands is true, shaded fill appears between +/- bounds with dashed boundary lines. Charts still work without band data (backward compatible).
  </done>
</task>

<task type="auto">
  <name>Task 2: Build sensitivity panel, useSensitivity hook, and wire everything into simulate page</name>
  <files>
    frontend/src/components/panels/SensitivityPanel.tsx
    frontend/src/hooks/useSensitivity.ts
    frontend/src/app/simulate/page.tsx
  </files>
  <action>
**Create useSensitivity.ts** (`frontend/src/hooks/useSensitivity.ts`):

Hook that manages sensitivity exploration state. Accepts the original simulation params and result.

```typescript
interface UseSensitivityOptions {
  originalParams: {
    powder_id: string;
    bullet_id: string;
    rifle_id: string;
    powder_charge_grains: number;
    coal_mm: number;
    seating_depth_mm: number;
  };
  originalResult: SimulationResult;
  enabled: boolean; // only active when panel is open
}

interface UseSensitivityReturn {
  // Slider values
  chargeGrains: number;
  setChargeGrains: (v: number) => void;
  seatingDepthMm: number;
  setSeatingDepthMm: (v: number) => void;
  barrelLengthMm: number;
  setBarrelLengthMm: (v: number) => void;
  // Current result (from re-simulation)
  currentResult: SimulationResult | null;
  // Error band data (from sensitivity endpoint)
  sensitivityData: SensitivityResponse | null;
  // Loading state
  isSimulating: boolean;
  // Delta values for badges
  deltas: {
    pressure_psi: number;
    velocity_fps: number;
    barrel_time_ms: number;
  } | null;
  // Reset to original
  reset: () => void;
}
```

Implementation:
1. Initialize slider values from originalParams.
2. Use `useDeferredValue` from React 18 for each slider value.
3. When any deferred value changes AND differs from original, set a 300ms debounce timer.
4. On debounce fire: call `runSimulation` (from api.ts, POST to /simulate/direct) with the new params. Also call `runSensitivity` with the new center charge + default delta (0.3 grains).
5. Store the new result in state. Compute deltas (new - original).
6. For barrel length: the existing /simulate/direct endpoint accepts rifle_id, not barrel_length_mm directly. Options: (a) pass the barrel length as an override to the sensitivity endpoint, or (b) for MVP, only support charge weight and seating depth sliders that map directly to existing request fields. Barrel length slider shows the value but when changed, it needs a custom approach. For now, barrel length slider is display-only with a "(proximamente)" label. This is acceptable for MVP -- charge weight and seating depth are the primary variables reloaders adjust.
7. IMPORTANT: Do NOT fire API calls when slider values equal the original values. Only re-simulate on actual changes.
8. Use useMutation from TanStack Query for the API calls to get proper isPending state.

**Create SensitivityPanel.tsx** (`frontend/src/components/panels/SensitivityPanel.tsx`):

Collapsible side panel. Per user decision: "Collapsible side panel with sliders for charge weight, seating depth, and barrel length" and "Side panel for sliders should not obscure the chart grid -- push content or overlay with enough transparency."

Props: `isOpen: boolean`, `onToggle: () => void`, slider values and handlers from useSensitivity.

Layout:
- When closed: floating toggle button (ChevronRight icon + "Explorador" label) on the right edge of the chart area.
- When open: panel slides in from right (w-72, 288px). Content pushes left (the chart grid container gets `pr-72` when panel is open). Use transition-all for smooth animation.
- Panel contents:
  1. Header: "Explorador de Sensibilidad" + close button (ChevronLeft).
  2. **Charge Weight slider**: Label "Carga (gr)", range input, min/max derived from original charge +/- 20% (or at least +/- 3 grains). Step 0.1 grain. Display current value. Show delta badge.
  3. **Seating Depth slider**: Label "Prof. Asentamiento (mm)", range from original -2mm to +2mm. Step 0.1mm. Display value + delta badge.
  4. **Barrel Length slider**: Label "Largo Canon (mm)", range from original -100mm to +100mm. Step 10mm. Display value. Mark as "(proximamente)" with disabled state.
  5. **Error Band toggle**: Checkbox "Mostrar bandas de error (+/- 0.3 gr)". Default checked.
  6. **Reset button**: "Restablecer" -- resets all sliders to original values.

Delta badges: Show change from original in parentheses with color coding. Positive pressure increase = amber/red. Positive velocity increase = green. Use Tailwind text colors.

**Wire into simulate/page.tsx:**

1. Add state: `const [sensitivityOpen, setSensitivityOpen] = useState(false)`.
2. After a simulation runs successfully, enable the sensitivity panel toggle button.
3. Instantiate useSensitivity hook with original params + result + enabled=sensitivityOpen.
4. When sensitivity is active (sensitivityOpen && currentResult):
   - Pass `currentResult` curve data to ALL chart components instead of the original result. This implements "Replace (live update) mode: charts update in real-time as user drags sliders."
   - Pass sensitivity upper/lower data to PressureTimeChart and VelocityDistanceChart for error bands.
   - Update summary cards to show currentResult values + delta badges.
5. Error band toggle: Pass `showBands` state from SensitivityPanel through to P/V chart components.
6. When panel closes, charts revert to showing original result data.
7. Layout: wrap the chart grid area in a div that adjusts padding when panel is open.
8. Delta badges on summary cards: show the delta value with arrow direction and color. Example: "62,450 PSI (+2,100)" in amber, or "3,258 FPS (+45)" in green. Per user decision: "green for favorable, red/amber for approaching limits."
  </action>
  <verify>
Run `cd C:/Users/vall-/Desktop/projectes/simulador_balistica/frontend && npx tsc --noEmit` -- TypeScript compiles cleanly. Run `npm run build` -- Next.js build succeeds. Manual test: run a simulation, verify error bands appear on P/V charts, open sensitivity panel, drag charge weight slider, verify all charts update.
  </verify>
  <done>
Sensitivity panel opens as collapsible right-side panel with charge weight and seating depth sliders. Dragging sliders updates all charts live via debounced re-simulation. Error bands show +/- charge variation on P/V charts with shaded fill and dashed boundaries. Summary cards display delta badges. Error band toggle allows hiding bands. Barrel length slider shown as "coming soon."
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual verification of complete dashboard</name>
  <files>frontend/src/app/simulate/page.tsx</files>
  <action>
Human verifies the complete simulation dashboard visually and functionally. All implementation was automated in prior tasks. This checkpoint confirms the full Phase 2 feature set works correctly end-to-end.

What was built:
- 2-column responsive chart grid (6 tiles: pressure, velocity, burn, energy/recoil, temperature, harmonics)
- Hero row with P(t) and V(x) as largest charts
- Error bands on P/V charts (shaded blue fill with dashed boundaries)
- Collapsible sensitivity panel with charge weight and seating depth sliders
- Live-updating charts when sliders are dragged
- Delta badges on summary cards
- Per-chart PNG/CSV export buttons
- Click-to-expand modal for each chart
- Synchronized crosshairs across time-domain charts

Verification steps:
1. Start the app: `docker-compose up --build` (or backend + frontend dev servers)
2. Navigate to http://localhost:3000/simulate
3. Run a simulation with any rifle/bullet/powder combination
4. Verify dashboard grid layout: Hero row P(t) left, V(x) right; below: 4 smaller tiles (burn in orange, energy/recoil in green, temperature in red, harmonics in blue)
5. Hover over any time-domain chart -- verify crosshair appears on OTHER time-domain charts simultaneously
6. Click expand button (Maximize icon) on any tile -- verify full-screen modal opens
7. Click PNG download on a tile -- verify .png file downloads
8. Click CSV download on a tile -- verify .csv file downloads with correct data
9. Verify error bands visible on P(t) and V(x) charts (shaded blue region with dashed lines)
10. Click "Explorador" button -- verify sensitivity panel slides in
11. Drag "Carga (gr)" slider -- verify all charts update and summary cards show delta badges
12. Toggle error band checkbox off -- verify bands disappear
13. Click "Restablecer" -- verify sliders reset and charts show original values
14. Resize browser to mobile width -- verify grid collapses to 1 column
  </action>
  <verify>User confirms all 14 verification steps pass by typing "approved" or describing issues.</verify>
  <done>User has visually and functionally verified the complete Phase 2 dashboard: grid layout, all chart types, error bands, sensitivity explorer, export, and responsive behavior.</done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` -- clean TypeScript compilation
2. `cd frontend && npm run build` -- Next.js build succeeds
3. `cd backend && python -m pytest tests/ -v` -- all backend tests pass
4. Visual: dashboard grid renders with 6 chart tiles after simulation
5. Visual: error bands visible on P/V charts
6. Functional: sensitivity sliders update all charts
7. Functional: per-chart PNG/CSV export works
8. Functional: expand-to-modal works for all tiles
</verification>

<success_criteria>
- Error bands rendered as shaded fill between +/- charge variation on P/V charts
- Error bands toggle on/off via checkbox
- Sensitivity panel opens as collapsible right panel
- Charge weight and seating depth sliders update all charts live
- Summary cards show delta badges with color coding
- All charts respond to slider changes simultaneously
- User has approved visual/functional verification
</success_criteria>

<output>
After completion, create `.planning/phases/02-extended-simulation-charts/02-03-SUMMARY.md`
</output>
