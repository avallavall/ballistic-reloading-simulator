---
milestone: v1.2
audited: 2026-02-23T19:30:00Z
status: gaps_found
scores:
  requirements: 19/21
  phases: 5/5
  integration: 28/30
  flows: 3/4
gaps:
  requirements:
    - id: "SRC-03"
      status: "partial"
      phase: "Phase 4"
      claimed_by_plans: ["04-01-PLAN.md", "04-02-PLAN.md"]
      completed_by_plans: ["04-01-SUMMARY.md", "04-02-SUMMARY.md"]
      verification_status: "passed (backend only)"
      evidence: "Backend endpoints accept manufacturer, caliber_family, quality_level, min_quality params and tests pass. Frontend buildQueryString() only passes page/size/q. No filter UI on any list page or picker modal. /manufacturers and /caliber-families routes have zero frontend callers."
    - id: "PWD-05"
      status: "partial"
      phase: "Phase 5"
      claimed_by_plans: ["05-01-PLAN.md", "05-03-PLAN.md"]
      completed_by_plans: ["05-01-SUMMARY.md", "05-03-SUMMARY.md"]
      verification_status: "passed (backend only)"
      evidence: "alias_group column exists, 11 alias groups applied during seed, GET /powders/{id}/aliases endpoint works. No getPowderAliases() in frontend api.ts, no alias UI in powders page. GRT import endpoint does NOT apply alias groups (only seed loader does). Users cannot see or interact with aliases."
  integration:
    - from: "frontend/powders/page.tsx handleOverwriteDuplicates"
      to: "TanStack Query cache invalidation"
      issue: "Overwrite path uses dynamic import of importGrtPowders, bypassing useImportGrtPowders mutation hook. queryClient.invalidateQueries not called after overwrite import. List does not auto-refresh."
      affected_requirements: ["PWD-01"]
    - from: "frontend/src/lib/api.ts buildQueryString"
      to: "backend filter query params"
      issue: "ListParams interface only has page/size/q. Backend accepts manufacturer, caliber_family, quality_level, min_quality, sort, order but frontend never passes them."
      affected_requirements: ["SRC-03"]
  flows:
    - name: "GRT import overwrite flow"
      breaks_at: "Post-import cache invalidation — list does not refresh after overwrite-mode import"
      affected_requirements: ["PWD-01"]
tech_debt:
  - phase: 06-frontend-integration
    items:
      - "PWD-01: handleOverwriteDuplicates bypasses TanStack Query mutation — cache invalidation missing after overwrite import"
      - "SRC-04: ComponentPicker renderItem does not display QualityBadge on picker rows — quality data returned by API but not rendered"
      - "List pages (powders, bullets, cartridges) have no search input widget — search only available through ComponentPicker on /simulate"
  - phase: 04-search-and-pagination
    items:
      - "Migration 006 backfill uses bore_diameter_mm for cartridge caliber_family but live endpoint uses groove_diameter_mm — pre-seeded cartridges may have incorrect caliber_family"
  - phase: 05-import-pipelines-and-fixture-data
    items:
      - "GRT import endpoint does not apply powder_aliases.json mappings — only seed loader links aliases. Newly imported GRT powders have alias_group=null"
      - "BUL-02 extended fields (model_number, bullet_type, base_type) not displayed as dedicated columns in bullets/page.tsx table"
      - "CRT-02 extended fields (parent_cartridge_name, extended dimensions) not shown in cartridges/page.tsx table"
---

# Milestone v1.2 Audit Report: Component Databases + Search

**Milestone Goal:** Build comprehensive pre-loaded component databases with quality indicators, multi-source import pipelines, and advanced search/filtering so users can simulate immediately without manual data entry.

**Audited:** 2026-02-23T19:30:00Z
**Status:** GAPS FOUND
**Scores:** Requirements 19/21 | Phases 5/5 | Integration 28/30 | Flows 3/4

---

## Phase Verification Summary

| Phase | Name | Status | Score | Key Deliverables |
|-------|------|--------|-------|-----------------|
| 03 | Schema and Quality System | PASSED | 5/5 | Quality scorer, data provenance, web_thickness DB param, migration 005 |
| 04 | Search and Pagination | PASSED | 12/12 | pg_trgm search, paginate() helper, 3 paginated endpoints, 22 tests |
| 05 | Import Pipelines and Fixture Data | PASSED | 12/12 | 208 powders, 127 bullets, 53 cartridges, 3 import endpoints, 25 tests |
| 07 | Cross-Phase Integration Fixes | PASSED | 6/6 | pg_trgm bootstrap, ILIKE fallback, TypeScript nullable fix, import mode fix |
| 06 | Frontend Integration | PASSED | 3/3 | QualityBadge, Pagination, ComponentPicker modals, keepPreviousData |

All 5 phases passed individual verification. Gaps surfaced at the cross-phase integration level.

---

## Requirements Coverage (3-Source Cross-Reference)

Sources used:
- **Source 1:** VERIFICATION.md (per-phase, all 5 present)
- **Source 2:** REQUIREMENTS.md traceability table (21 REQ-IDs, all `[x]` Complete)
- **Source 3:** SUMMARY.md frontmatter `requirements_completed` — NOT AVAILABLE (field absent from all 11 summaries)
- **Source 4:** Integration checker agent (cross-phase wiring verification)

| REQ-ID | Description | VERIFICATION | REQUIREMENTS | Integration | Final |
|--------|-------------|-------------|--------------|-------------|-------|
| PWD-01 | Batch-import 200+ powders from GRT with collision handling | SATISFIED (Ph5) | [x] Complete | Wired (overwrite cache bug = tech debt) | **satisfied** |
| PWD-02 | Quality badges on powders (red/yellow/green) | SATISFIED (Ph3) | [x] Complete | Wired | **satisfied** |
| PWD-03 | Quality score 0-100 with breakdown tooltip | SATISFIED (Ph3) | [x] Complete | Wired | **satisfied** |
| PWD-04 | Data source provenance tracking | SATISFIED (Ph3) | [x] Complete | Wired | **satisfied** |
| PWD-05 | Powder aliases resolved across markets | SATISFIED (Ph5) | [x] Complete | Unwired (no frontend consumer) | **partial** |
| BUL-01 | 100-200 pre-loaded bullets from 5 manufacturers | SATISFIED (Ph5) | [x] Complete | Wired | **satisfied** |
| BUL-02 | Bullet records with full manufacturer data fields | SATISFIED (Ph5) | [x] Complete | Wired | **satisfied** |
| BUL-03 | Nullable bullet fields (length_mm, bc_g7) | SATISFIED (Ph5) | [x] Complete | Wired | **satisfied** |
| BUL-04 | Batch-import bullets from JSON | SATISFIED (Ph5) | [x] Complete | Wired (backend, per scope) | **satisfied** |
| CRT-01 | 50+ pre-loaded cartridges with CIP/SAAMI specs | SATISFIED (Ph5) | [x] Complete | Wired | **satisfied** |
| CRT-02 | Cartridge parent lineage and extended dimensions | SATISFIED (Ph5) | [x] Complete | Wired | **satisfied** |
| CRT-03 | Batch-import cartridges from JSON | SATISFIED (Ph5) | [x] Complete | Wired (backend, per scope) | **satisfied** |
| QLT-01 | Quality badges on ALL component records | SATISFIED (Ph6) | [x] Complete | Wired (list pages) | **satisfied** |
| QLT-02 | Auto-recompute quality on PUT | SATISFIED (Ph3) | [x] Complete | Wired | **satisfied** |
| QLT-03 | Deterministic quality formula | SATISFIED (Ph3) | [x] Complete | Wired | **satisfied** |
| SRC-01 | Server-side pagination with total count | SATISFIED (Ph4) | [x] Complete | Wired | **satisfied** |
| SRC-02 | Fuzzy search via pg_trgm | SATISFIED (Ph4) | [x] Complete | Wired (via ComponentPicker) | **satisfied** |
| SRC-03 | Filter by manufacturer, caliber, quality level | SATISFIED (Ph4) | [x] Complete | Partial (backend only, no frontend UI) | **partial** |
| SRC-04 | Searchable picker modals in simulation form | SATISFIED (Ph6) | [x] Complete | Wired | **satisfied** |
| SRC-05 | Frontend pagination with keepPreviousData | SATISFIED (Ph6) | [x] Complete | Wired | **satisfied** |
| SOL-01 | Solver reads web_thickness from DB | SATISFIED (Ph3) | [x] Complete | Wired | **satisfied** |

**Satisfied:** 19 | **Partial:** 2 (SRC-03, PWD-05) | **Unsatisfied:** 0 | **Orphaned:** 0

---

## Gap Details

### GAP 1: SRC-03 — Frontend filter controls not wired

**Requirement:** "User can filter components by manufacturer, caliber/caliber family, and quality level"

**Backend:** Complete. All three list endpoints accept `manufacturer`, `caliber_family`, `quality_level`, `min_quality` query params. Tests verify AND composition. Dynamic routes `/manufacturers` and `/caliber-families` return distinct values.

**Frontend:** Not wired. `buildQueryString()` in `api.ts` only encodes `page`, `size`, `q`. `ListParams` has no filter fields. No list page has filter dropdown controls. `/manufacturers` and `/caliber-families` routes have zero frontend callers.

**Impact:** Users cannot filter the 200+ powder, 127 bullet, or 53 cartridge databases by manufacturer, caliber family, or quality level through the UI. They can only browse paginated lists and search by text via ComponentPicker.

**Fix scope:** Add filter fields to `ListParams`, extend `buildQueryString`, add filter dropdowns on list pages backed by `/manufacturers` and `/caliber-families` data.

### GAP 2: PWD-05 — Alias endpoint not surfaced in UI

**Requirement:** "Powder aliases are resolved so duplicate entries across markets are linked (e.g., ADI AR2208 = Hodgdon Varget)"

**Backend:** Complete. `alias_group` column with index, 11 alias groups (18 powders linked) applied during seed, `GET /powders/{id}/aliases` returns linked powders.

**Frontend:** Not wired. No `getPowderAliases()` in `api.ts`. No alias display in powders page. Users cannot see that ADI AR2208 and Hodgdon Varget are the same powder.

**Additional issue:** GRT import does NOT apply alias group mappings — only the seed loader does. Newly imported GRT powders always have `alias_group = null`.

**Fix scope:** Add `getPowderAliases()` to API client, display alias indicator on powder rows, apply alias mapping during GRT import.

---

## Cross-Phase Integration

**Score:** 28/30 exports wired correctly

### Verified Wiring (28 connections)

- `compute_quality_score()` (Ph3) -> powders, bullets, cartridges CRUD + seed (Ph5) -> QualityBadge (Ph6)
- `paginate()` + `apply_fuzzy_search()` (Ph4) -> all 3 list endpoints -> `*Paginated` hooks (Ph6)
- `ImportMode` + `ImportResult` (Ph5) -> bullets/cartridges import endpoints
- `app.state.has_trgm` flag (Ph7) -> ILIKE fallback in search.py -> all 3 list endpoints
- Fixtures (Ph5) -> `_load_fixture()` in seed -> quality computed + caliber derived
- `QualityBadge` + `Pagination` + `SkeletonRows` (Ph6) -> all 3 list pages
- `ComponentPicker` (Ph6) -> `SimulationForm` -> `getBullets`/`getPowders` with debounce
- `keepPreviousData` -> all 3 `*Paginated` hooks -> opacity-50 transition in table rows
- All 7 routers registered in `api/router.py` and mounted in `main.py`

### Integration Issues (2 remaining)

| # | Issue | Severity | REQs |
|---|-------|----------|------|
| 1 | `handleOverwriteDuplicates` bypasses mutation hook — cache invalidation missing after overwrite import | Medium | PWD-01 |
| 2 | `buildQueryString` only passes page/size/q — backend filter params never sent from frontend | Medium | SRC-03 |

**Previously fixed by Phase 7:** pg_trgm bootstrap (SRC-02), import mode param mismatch (PWD-01), TypeScript nullable alignment (BUL-03)

---

## E2E Flow Verification

| # | Flow | Status | Details |
|---|------|--------|---------|
| 1 | Fresh boot -> seed -> quality -> /powders with badges and pagination | COMPLETE | 208+127+53 seeded, quality computed, badges displayed, pagination working |
| 2 | GRT import -> collision -> quality -> aliases -> search | PARTIAL | Import works, quality recomputed, but overwrite skips cache invalidation; aliases not applied during import; no alias UI |
| 3 | /simulate -> picker -> search -> select -> simulate | COMPLETE | ComponentPicker wired, debounced search works, selection flows to simulation |
| 4 | Search "hodgon" -> pg_trgm -> filter by manufacturer -> paginate | PARTIAL | pg_trgm search works via ComponentPicker; manufacturer filter has no UI; list pages lack search input |

---

## Tech Debt Summary

### Phase 06 — Frontend Integration (3 items)
1. `handleOverwriteDuplicates` bypasses TanStack Query mutation — cache invalidation missing after overwrite import
2. ComponentPicker `renderItem` does not display QualityBadge on picker rows (cosmetic)
3. List pages have no search input widget — search only available through ComponentPicker on /simulate

### Phase 04 — Search and Pagination (1 item)
1. Migration 006 backfill uses `bore_diameter_mm` for cartridge `caliber_family` but live endpoint uses `groove_diameter_mm` — pre-seeded cartridges may have incorrect caliber_family

### Phase 05 — Import Pipelines and Fixture Data (3 items)
1. GRT import endpoint does not apply `powder_aliases.json` mappings — only seed loader links aliases
2. Extended bullet fields (model_number, bullet_type, base_type) not displayed in bullets table
3. Extended cartridge fields (parent_cartridge_name, dimensions) not shown in cartridges table

**Total: 7 tech debt items across 3 phases (non-blocking)**

---

## Human Verification Items (Carried Forward)

From phase verifications, requiring live Docker environment:

1. **pg_trgm fuzzy search on live PostgreSQL** — `GET /powders?q=hodgon` returns Hodgdon results
2. **Fresh Docker boot fixture loading** — 208 powders, 127 bullets, 53 cartridges seeded
3. **Quality badge tooltip hover rendering** — CSS group-hover tooltip on powders page
4. **Pagination keepPreviousData transition** — No empty flash between page navigations
5. **ComponentPicker debounce** — 2-char input suppressed, 3rd char triggers after 300ms

---

## Test Suite Status

| Phase | Tests Added | Suite Total | Status |
|-------|-------------|-------------|--------|
| Phase 3 | 15 (10 unit + 5 integration) | 270 | All passing |
| Phase 4 | 22 (pagination + filters) | 292 | All passing |
| Phase 5 | 25 (fixtures + imports + seed) | 317 | All passing |
| Phase 7 | 5 (ILIKE fallback + import mode) | 322 | All passing |
| Phase 6 | 0 (UI components, no backend tests) | 322 | — |

---

_Audited: 2026-02-23T19:30:00Z_
_Auditor: Claude (gsd-audit-milestone orchestrator + gsd-integration-checker agent)_
